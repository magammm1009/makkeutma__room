<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë§ˆëë§ˆ</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%97%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --panel:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --pink2:#ffb6d6;
      --pink3:#ff77b8;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:16px;
      --tileMin:170px;
      --tileMax:230px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color:var(--text);
      background:#000;
      min-height:100vh;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:30;
      display:grid; align-items:center; justify-content:stretch;
      grid-template-columns: minmax(160px, 1fr) auto minmax(320px, 1fr);
      gap:12px;
      padding:12px 14px;
      background: rgba(11,11,16,.84);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex; align-items:center; justify-content:center; text-align:center; gap:10px;
      font-weight:1000; letter-spacing:-.5px;
      min-width:0;
      font-size:18px;
      white-space:nowrap;
    }
    .brand .dot{width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,.22);border:1px solid rgba(255,182,214,.22);box-shadow:0 0 0 rgba(0,0,0,0)}
    body.joined .brand .dot{background:var(--pink3);border-color: rgba(255,182,214,.45);box-shadow:0 0 18px rgba(255,119,184,.65);animation: lampTwinkle 1.2s ease-in-out infinite;}
    @keyframes lampTwinkle{0%,100%{transform:scale(1);filter:brightness(1);}50%{transform:scale(1.18);filter:brightness(1.25);}}
    .brandTitle{font-weight:1100; font-size:18px; letter-spacing:-.4px;}
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; justify-self:end}
    body.joined #meHint{display:none !important;}

    input, button, textarea{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      color:var(--text);
      background: rgba(255,255,255,.06);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.4)}
    button{cursor:pointer}
    button.primary{
      background: linear-gradient(135deg, rgba(255,119,184,.92), rgba(255,182,214,.88));
      border: none;
      color:#1b1020;
      font-weight:1000;
      box-shadow: 0 14px 30px rgba(255,119,184,.18);
    }
    button.ghost{display:flex;align-items:center;justify-content:center;gap:6px;background: rgba(255,255,255,.05)}

    /* âœ… ì¶œê·¼ ë²„íŠ¼: ì˜¤ëŠ˜ ë¯¸ì¶œê·¼ì´ë©´ ì‚´ì§ ë°˜ì§(ë…ì´‰), ì¶œê·¼ ì™„ë£Œë©´ ì²´í¬ í‘œì‹œ */
    @keyframes checkInPulse{
      0%,100%{ transform: translateY(0); filter: brightness(1); box-shadow: 0 0 0 rgba(255,119,184,0); }
      50%{ transform: translateY(-1px); filter: brightness(1.15); box-shadow: 0 0 18px rgba(255,119,184,.20); }
    }
    #checkInBtn.checkinPulse{
      animation: checkInPulse 1.25s ease-in-out infinite;
      border-color: rgba(255,182,214,.55);
    }
    #checkInBtn.checkinDone{
      opacity: .92;
      border-color: rgba(255,255,255,.18);
      filter: saturate(.95);
    }

    /* âœ… Topbar ë²„íŠ¼ í¬ê¸° í†µì¼ (ê¸°ë³¸ ëª¨ë“œ Work ë²„íŠ¼ ê¸°ì¤€) */
.topCenter button,
.actions button{
  min-height:40px;
  padding:10px 12px;
  font-size:13px;
  line-height:1;
  border-radius:12px;
}
#statusMenu .statusBtns button{
  min-height:40px;
  padding:10px 12px;
  font-size:13px;
  line-height:1;
  border-radius:12px;
}

/* âœ… ë ˆì´ì•„ì›ƒ í† ê¸€ ë²„íŠ¼ë„ ë™ì¼ ê·œê²© */
.gridHead .layoutToggle{
  min-height:40px;
  padding:10px 12px;
  font-size:13px;
  line-height:1;
  border-radius:12px;
}

    button:disabled, input:disabled, textarea:disabled{opacity:.45; cursor:not-allowed;}

    /* Main layout */
    .wrap{
      display:grid;
      grid-template-columns: minmax(0, 1fr) clamp(280px, 28vw, 340px);
      gap: 10px;
      padding:14px;
      width:100%;
      max-width:none;
      margin:0;
    }

    /* âœ… Main(íƒ€ì¼) ì˜ì—­ ì˜¤ë¥¸ìª½ ì—¬ë°±: ëŒ€ì‹œë³´ë“œì™€ ë”± ë¶™ëŠ” ëŠë‚Œ ì™„í™” */
    .wrap > main{ padding-right:10px; }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
      .sidebar{order:-1; position:relative; top:auto; height:auto}
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:72px;
      align-self:start;
      justify-self:end;
      display:flex;
      flex-direction:column;
      gap:12px;
      height: calc(100vh - 92px);
      min-height: 520px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0;
      padding:12px 14px;
      font-size:14px;
      color:rgba(255,255,255,.9);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:center; text-align:center; justify-content:space-between;
      gap:10px;
    }

    /* Dashboard head (title + mission count + fold) */
    .dashHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .dashHead h3{
      margin:0;
      padding:0;
      border:0;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      white-space:nowrap;
    }
    .dashHeadRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .dashSuccess{
      font-weight:1000;
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,182,214,.35);
      background: rgba(255,182,214,.10);
    }
    .dashFoldBtnSmall{
      padding:6px 10px;
      border-radius:999px;
      min-height:auto;
      line-height:1;
    }
    .dashFoldBtnSmall .dashFoldTxt{font-size:12px; opacity:.85; margin-left:6px;}
    @media (max-width: 520px){
      .dashFoldBtnSmall .dashFoldTxt{display:none;}
      .dashSuccess{padding:6px 8px;}
    }
    .card h3 span{color:var(--muted); font-weight:800; font-size:12px}
    .card .body{padding:12px 14px; display:flex; flex-direction:column; gap:10px;}

    /* Dashboard: two boxes side-by-side */
    .dashRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .dashBox{
      background: rgba(255,214,233,.10);
      border:1px solid rgba(255,182,214,.20);
      border-radius:14px;
      padding:8px 8px 6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:84px;
    }
    .dashTitle{font-weight:1000; display:flex; align-items:center; justify-content:center; text-align:center; gap:8px;}
    .dashBig{font-size:28px; font-weight:1100; letter-spacing:-1px; line-height:1}
    .dashFoot{display:flex; justify-content:space-between; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);
      font-size:12px;
      font-weight:900;
    }
    .btnRow{display:flex; gap:8px;}
    .btnRow button{flex:1; min-width: 0}
    .dashGo{padding:8px 10px; font-size:12px; font-weight:1100}
    .dashFoot{font-size:11px;}
    .tiny{font-size:11px;}
    .tiny{font-size:12px; color:var(--muted); line-height:1.35}

    /* Chat */
    .chatCard{flex:1; min-height: 260px; display:flex; flex-direction:column;}
    .chatBody{display:flex; flex-direction:column; gap:10px; height:100%;}
    .chatList{
      flex:1;
      overflow:auto;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      padding:10px;
    }

    .chatNewBar{
      margin-top:8px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .chatJumpBtn{
      width:100%;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(255,182,214,.30) !important;
      background: rgba(255,182,214,.14) !important;
      font-weight:900;
    }
    .chatJumpBtn:hover{ filter:brightness(1.05); }
    .msg{
      display:flex; flex-direction:column; gap:4px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      margin-bottom:8px;
    }
    .msg .meta{display:flex; gap:8px; align-items:center; color:rgba(255,255,255,.72); font-size:12px; font-weight:800}
    .msg .text{white-space:pre-wrap; word-break:break-word; font-size:13px; line-height:1.35}
    .chatInputRow{display:flex; gap:8px}
    .chatInputRow input{flex:1}
    .chatInputRow button{flex:0 0 auto; min-width:88px}

    /* Chat alignment (ìƒëŒ€=ì™¼ìª½, ë‚˜=ì˜¤ë¥¸ìª½ / ê¸€ììˆ˜ì— ë§ì¶° í­ ìë™) */
    .chatList{display:flex; flex-direction:column;}
    .msg{width: fit-content; max-width: 78%;}
    .msg.other{align-self:flex-start; margin-right:auto;}
    .msg.me{align-self:flex-end; margin-left:auto; border-color: rgba(255,182,214,.28); background: rgba(255,214,233,.10);}
    .msg.other .meta{justify-content:flex-start;}
    .msg.me .meta{justify-content:flex-end;}
/* Main */
    .gridHead{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; padding:2px 2px 8px;
    }
    .gridHead .title{font-size:18px; font-weight:1100; letter-spacing:-.6px; display:flex; align-items:baseline; gap:10px;}
    .titleSub{font-size:12px; color:var(--muted); font-weight:900;}
    .gridHead .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-right:10px;}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:rgba(255,255,255,.86);
      font-size:12px; font-weight:1000;
      display:inline-flex; align-items:center; gap:8px;
    }
    .grid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fill, minmax(var(--tileMin), var(--tileMax)));
      justify-content: center;
      padding:4px 2px 14px;
      align-items:stretch;
          align-content:start;
    }

    
    /* Layout mode toggle */
    .layoutToggle{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      color:rgba(255,255,255,.9);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    /* âœ… Mini ë³´ê¸°(ìë™ ì •ë ¬) */
    .grid.compact5{
      /* ê¸°ì¡´ '5ì—´ ê³ ì •' ëŒ€ì‹ , ë¸Œë¼ìš°ì € í­ì— ë§ì¶° ìë™ ë°°ì¹˜ */
      --tileMin: 150px;
      --tileMax: 210px;
      grid-template-columns: repeat(auto-fill, minmax(var(--tileMin), 1fr));
      justify-content: center;
      padding:6px 2px 14px;
    }

    .grid.compact5 .tile{
      aspect-ratio: auto;         /* prevent clipping */
      min-height: 168px;
    }
    .grid.compact5 .content{
      padding:10px;
      --tileGap: 8px;
      align-items:center;
      text-align:center;
    }
    .grid.compact5 .statusBar{
      justify-content:center;
    }
    .grid.compact5 .statusLeft{
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .grid.compact5 .namePill{flex:1; min-width:0; min-height:40px; padding:0 12px; font-size:13px; line-height:1; border-radius:12px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .grid.compact5 .bigTimer{
      font-size: clamp(16px, 2.6vw, 22px);
      justify-content:center;
      align-items:center;
      flex-direction:column;
      gap:8px;
    }
    .grid.compact5 .missionBtn{display:none !important;}
    .grid.compact5 .bottomStack{
      display:none; /* hide bubble + avatar/photo in mini mode */
    }

    /* âœ… Mini ë³´ê¸°(5ì—´) ì¶”ê°€ ê°„ì†Œí™” íŒ¨ì¹˜ */
    .grid.compact5 .tile{
      aspect-ratio: auto;
      min-height: 92px;
    }
    .grid.compact5 .content{
      padding:8px 8px 10px;
      gap:6px;
      align-items:center;
    }
    .grid.compact5 .statusBar{
      padding:0;
      justify-content:center;
    }
    .grid.compact5 .statusRight{display:none;}
    .grid.compact5 .statusLeft{
      flex-direction:row !important; /* ìƒíƒœ ì´í™íŠ¸ ì˜†ìœ¼ë¡œ ë‹‰ë„¤ì„ */
      align-items:center !important;
      justify-content:center;
      gap:6px;
      min-width:0;
    }
    /* ìƒíƒœ ë°°ì§€: ì´í™íŠ¸ë§Œ(í…ìŠ¤íŠ¸ ìˆ¨ê¹€) */
    .grid.compact5 .badge span:not(:first-child){display:none !important;}
    /* ë¯¸ë‹ˆ ëª¨ë“œ: ë°°ì§€/ë‹‰ë„¤ì„ pill í¬ê¸° ë‹¤ë“¬ê¸° */
    .grid.compact5 .badge{min-height:40px; padding:0 12px; font-size:13px; line-height:1; border-radius:12px;}
    .grid.compact5 .namePill{flex:1; min-width:0; min-height:40px; padding:0 12px; font-size:13px; line-height:1; border-radius:12px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}


    /* âœ… ë¯¸ì…˜ ì„±ê³µ ë©”ë‹¬(íƒ€ì¼ì—ì„œ ëª¨ë‘ê°€ ì‹¤ì‹œê°„ í™•ì¸) */
    .missionMedal{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,182,214,.45);
      background: rgba(255,182,214,.12);
      font-size:18px;
      font-weight:1000;
      line-height:1;
      box-shadow: 0 10px 22px rgba(255,119,184,.10);
      user-select:none;
    }
    .missionMedal.hidden{display:none !important;}
    .grid.compact5 .missionMedal{padding:0 10px; font-size:16px;}

    /* ë¯¸ë‹ˆ ëª¨ë“œì—ì„œëŠ” ë¯¸ì…˜ ë²„íŠ¼ ìˆ¨ê¹€ */
    .grid.compact5 .missionBtn,
    .grid.compact5 .missionSpacer{display:none !important;}
    /* ì‘ì—… ì‹œê°„: ë” í¬ê²Œ */
    .grid.compact5 .bigTimer .time{
      font-size: clamp(18px, 3.2vw, 26px);
      letter-spacing: .5px;
    }

    /* Tile */
    .tile{
      position:relative;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 16px 38px rgba(0,0,0,.28);
      aspect-ratio: 1 / 1;
      min-height: unset;
      background: rgba(255,255,255,.04);
      max-width:none;
      width:100%;
      justify-self:stretch;
      }
    .tile .bg{position:absolute; inset:0; opacity:1;}
    .tile .shade{
      position:absolute; inset:0;
      /* íŒ¨í„´ì´ ë” ì˜ ë³´ì´ë„ë¡ ì‚´ì§ë§Œ ì–´ë‘¡ê²Œ */
      background: rgba(0,0,0,.32);
      }
    .tile .content{
      position:relative;
      padding:7px;
      padding-bottom: 10px;
      display:flex;
      flex-direction:column;
      --tileGap: 10px;
      gap: var(--tileGap, 10px);
      height:100%;
      min-height:unset;
    }

    .statusBar{display:flex; justify-content:center; align-items:center; gap:8px;}
    .statusLeft{display:flex; align-items:center; justify-content:center; text-align:center; gap:8px; min-width:0;}
    .statusRight{display:none;}
    
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:40px;
      padding:0 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1;
      font-weight:1100;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.34);
    }
    .bWork{background: rgba(85, 255, 170, .12); border-color: rgba(85, 255, 170, .22)}
    .bBreak{background: rgba(255, 214, 80, .12); border-color: rgba(255, 214, 80, .22)}
    .bIdle{background: rgba(160, 160, 255, .12); border-color: rgba(160, 160, 255, .22)}
    .bOff{background: rgba(255, 255, 255, .08); border-color: rgba(255, 255, 255, .14)}

    .rowTop{display:flex; align-items:center; justify-content:center; text-align:center; justify-content:center; gap:6px; padding-top:0;}
    .who{display:flex; flex-direction:column; align-items:center; gap:8px; min-width:0;}
    .avatar{
      width: var(--emoSize, 60px);
      height: var(--emoSize, 60px);
      border-radius: 16px;
      background: var(--emoBg, #2b2b2b);
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center; text-align:center; justify-content:center;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      font-size: calc(var(--emoSize, 60px) * 0.55);
      line-height:1;
    }
    .whoText{min-width:0; display:flex; flex-direction:column; gap:2px;}
    .name{font-weight:1100; letter-spacing:-.4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .namePill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:40px;
      padding:0 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1;
      font-weight:1100;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.34);
    }
    /* âœ… Nickname display: full in ê¸°ë³¸ ë³´ê¸°, 3ê¸€ì+â€¦ in ë¯¸ë‹ˆ ë³´ê¸° */
    .namePill .nameMini{display:none;}
    .grid.compact5 .namePill .nameFull{display:none;}
    .grid.compact5 .namePill .nameMini{display:inline;}

    .bubble{
      margin:0;
      background: var(--bubbleBg, rgba(255,255,255,.10));
      border-color: var(--bubbleBorder, rgba(255,255,255,.16));
    }

    body.compact .grid{ grid-template-columns: 1fr; }

    .gridRosterWrap{
      width: 100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
    }
    .gridRosterTitle{
      font-weight: 900;
      letter-spacing: -.2px;
      margin: 2px 0 10px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .gridRosterList{ display:flex; flex-direction:column; gap:10px; }
    .gridRosterItem{
      display:flex; align-items:center; justify-content:center; text-align:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
    }
    .gridRosterLeft{ display:flex; align-items:center; justify-content:center; text-align:center; gap:10px; min-width:0; }
    .gridRosterEmoji{
      width: 40px; height: 40px;
      display:flex; align-items:center; justify-content:center; text-align:center; justify-content:center;
      border-radius: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      font-size: 20px;
    }
    .gridRosterName{
      font-weight: 850;
      max-width: 64vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .gridRosterStatus{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.86);
      flex: none;
    }

    #settingsModal .modalBody{ gap: 14px; }
    #settingsModal .row{ gap: 12px; }

    .motto{font-size:12px; color:rgba(255,255,255,.72); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .idPhoto{
      width: var(--photoSize, 108px);
      height: var(--photoSize, 108px);
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.34);
      overflow:hidden;
      flex:0 0 auto;
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      display:flex; align-items:center; justify-content:center; text-align:center; justify-content:center;
      color: rgba(255,255,255,.78);
      font-weight: 900;
      font-size: 12px;
    }
    .idPhoto img{width:100%; height:100%; object-fit:cover; display:block;}

    .bigTimer{
      font-size: clamp(20px, 4.8vw, 30px);
      font-weight:1100;
      letter-spacing:-1px;
      line-height:1;
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      min-width:0;
    }
    .bigTimer small{font-size:11px; font-weight:900; color:rgba(255,255,255,.70);}
    .bigTimer .time{white-space:nowrap; font-variant-numeric: tabular-nums;}

    .bubble{
  position:relative;
  margin:0;
  z-index:3;
  padding:7px 9px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.10);
  font-size:12.5px;
  line-height:1.25;
  min-height:32px;
  display:flex; align-items:center; justify-content:center; text-align:center;
  word-break:break-word;
  overflow:hidden;
}
.bottomStack{
  margin-top: 0;
  display:flex;
  flex: 0 0 auto;
  flex-direction:column;
  gap: var(--tileGap, 10px);
}
.mediaRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding-top:0;
}
    .bubble.muted{opacity:.72}


    /* âœ… v27-tile-only patch: vivid colors + remove avatar/photo shadow + darker bubble */
    .tile .shade{ background: rgba(0,0,0,0) !important; } /* keep vivid */
    .avatar{
      background: var(--emoBg, #2b2b2b) !important;   /* no dark overlay */
      box-shadow: none !important;
    }
    .idPhoto{ box-shadow: none !important; }
    

    /* Bottom bar */
    .bottomBar{
      position:sticky; bottom:0; z-index:15;
      background: rgba(11,11,16,.86);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 14px;
    }
    .bottomInner{
      max-width:1400px; margin:0 auto;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
    }
    .leftBar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .rightBar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .miniHelp{font-size:12px; color:var(--muted); font-weight:800}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:100; padding:16px;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(720px, 100%);
      background: rgba(18,18,26,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
      max-height: calc(100vh - 32px);
      display:flex; flex-direction:column;
    }
    .modalHeader{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.34);
    }
    .modalHeader .t{font-weight:1100}
    .modalBody{padding:12px 14px; display:flex; flex-direction:column; gap:10px; overflow:auto; min-height:0;}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .row > *{flex:1; min-width: 220px}
    .row .tight{flex:0 0 auto; min-width:auto}
/* Profile modal layout tidy */
    #profileModal .modalBody .row{display:flex; align-items:center; justify-content:center; text-align:center; gap:12px; flex-wrap:wrap}
    #profileModal .modalBody .row > *{flex:0 0 auto; min-width:0}
    #profileModal .modalBody .row label{flex:0 0 140px; max-width:140px; min-width:140px; font-weight:950; color:rgba(255,255,255,.86)}
    #profileModal .modalBody .row textarea{flex:1 1 420px; min-width:260px; height:46px; padding:10px 12px; line-height:1.35; resize:vertical}
    #profileModal .modalBody .row input[type="text"]{flex:1 1 260px; min-width:180px}
    #profileModal .modalBody .row input[type="file"]{flex:1 1 320px; min-width:220px}
    #profileModal .modalBody .row input[type="range"]{flex:1 1 340px; min-width:220px}
    #profileModal .modalBody .row select{flex:1 1 340px; min-width:220px}
    #profileModal .modalBody .row input[type="number"]{flex:0 0 86px; min-width:86px}
    #profileModal .modalBody .row .colorControls{flex:1 1 320px; min-width:220px}
    #profileModal .modalBody .row .tiny{flex:1 1 100%; margin-left:140px; min-width:0; font-size:12px; color:rgba(255,255,255,.62)}
    #profileModal .modalBody .row:last-child{justify-content:flex-end}

    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .hr{height:1px;background:rgba(255,255,255,.10); margin:4px 0}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:70px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:rgba(255,255,255,.9);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:999;
    }
    .toast.show{opacity:1}

    /* Color palette controls */
    .paletteWrap{display:flex; flex-direction:column; gap:8px;}
    .swatches{display:flex; flex-wrap:wrap; gap:8px;}
    #bgSwatches{display:none;}

    .swatch{
      width:22px; height:22px; border-radius:8px; cursor:pointer;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 8px 18px rgba(0,0,0,.20);
    }
    .swatch.active{outline:2px solid rgba(255,119,184,.9);}
    .colorControls{display:flex; gap:8px; align-items:center;}
    input[type="color"]{width:44px; height:44px; padding:0; border-radius:12px; overflow:hidden;}
    /* Embeds */
    .embedBar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;}
    .embedBar .left{display:flex; gap:8px; align-items:center;}
    .embedFrame{
      width:100%;
      height:100%;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.22);
    }

    
    .topCenter{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex:1;
      min-width: 240px;
      flex-wrap:wrap;
      position:relative;
    }

    .statusMenu{
      position:absolute;
      top:42px;
      left:50%;
      transform: translateX(-50%);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(16,16,18,.92);
      box-shadow: 0 16px 34px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      z-index: 50;
      width: min(520px, 92vw);
    }
    .statusMenu.hidden{display:none;}
    .statusBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:center;}
    .statusMenu button{min-width:106px;}
    .statusMenu button.tight{min-width:52px; padding:10px 10px; border-radius:12px;}
    .topCenter button{
      padding:10px 12px;
      border-radius:12px;
      font-weight:1000;
      white-space:nowrap;
    }
    .miniPill{padding:7px 10px; font-size:12px;}
    .topPills{display:none;}

    .meMini{
      font-size:12px;
      color: rgba(255,255,255,.68);
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    @media (max-width: 980px){
      .topCenter{order:3; width:100%; justify-content:flex-start;}
      .actions{order:2;}
      .brand{order:1;}
      .topbar{display:flex; flex-wrap:wrap;}
    }


    .tile .rowTop{min-height: 132px;}
    .tile .bigTimer{font-size:32px;}
    @media (max-width: 420px){
      .idPhoto{width:96px; height:96px;}
      .tile .bigTimer{font-size:28px;}
    }


    /* Status animations */
    .stIcon{display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:10px; background: rgba(0,0,0,.34); border:1px solid rgba(255,255,255,.14); margin-right:6px;}
    .stWork{animation: wiggle 1.25s ease-in-out infinite;}
    .stBreak{animation: puff 1.6s ease-in-out infinite;}
    .stIdle{animation: floaty 1.8s ease-in-out infinite;}
    @keyframes wiggle{0%,100%{transform:rotate(0deg) translateY(0);}50%{transform:rotate(-10deg) translateY(-1px);}}
    @keyframes puff{0%,100%{transform:translateY(0);opacity:1;}50%{transform:translateY(-2px);opacity:.85;}}
    @keyframes floaty{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}
    .chatEmoji{margin-right:6px;}

@media (max-width: 520px){
  /* Force at least 2 profile tiles on small screens */
  .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
  .tile{max-width:none; justify-self:stretch;}
  .rowTop{min-height: 156px;}
  .dashRow{grid-template-columns: 1fr;}
}


    /* Mini online button next to profile */
    .miniOnline{
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: rgba(255,255,255,.05);
    }

    /* Chat responsive fixes (avoid input bar getting cut) */
    .chatCard{min-height: 320px;}
    .chatBody{min-height:0;}
    .chatList{min-height:0;}
    .chatInputRow{flex-wrap:wrap;}
    .chatInputRow input{min-width:0;}
    @media (max-width: 520px){
      .chatInputRow button{min-width:72px;}
    }
    @media (max-width: 380px){
      .chatInputRow button{width:100%; min-width:0;}
      .chatInputRow input{width:100%;}
    }

    
    @media (max-height: 720px){
      .sidebar{height:auto; min-height:0;}
      .chatCard{min-height:260px;}
    }

    /* Dashboard docking under settings button */
    #dashboardCard.docked{
      position: fixed;
      z-index: 60;
      width: clamp(260px, 28vw, 340px);
    }

    #chatCard.dockedChat{
      z-index: 55;
      width: clamp(260px, 28vw, 340px);
    }


    /* --- Context menu (í”„ë¡œí•„ ìš°í´ë¦­ ê°•í‡´) --- */
    .ctxMenu{
      position: fixed;
      z-index: 9999;
      min-width: 190px;
      max-width: 260px;
      background: rgba(18,18,20,.94);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      padding: 8px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select: none;
    }
    .ctxMenu.hidden{ display:none; }
    .ctxMenu .title{
      font-size: 13px;
      color: rgba(255,255,255,.88);
      padding: 6px 10px 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .ctxMenu button{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 700;
      cursor: pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      margin-top: 6px;
    }
    .ctxMenu button:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); }
    .ctxMenu button:active{ transform: translateY(1px); }
    .ctxMenu button.danger{
      background: rgba(255, 90, 140, .20);
      border-color: rgba(255, 90, 140, .40);
    }
    .ctxMenu button.danger:hover{
      background: rgba(255, 90, 140, .28);
      border-color: rgba(255, 90, 140, .55);
    }
    .ctxMenu button:disabled{
      opacity: .45;
      cursor: not-allowed;
      transform: none;
    }
    /* âœ… ultra-small window: use roster layout in main (tiles hidden by JS) */
    body.compact .wrap{grid-template-columns: 1fr;}

  
    body.passok #roomPass{display:none;}
    .actions{flex-wrap:wrap}
    #roomPass{min-width:92px}

  

    /* âœ… ì´ˆì†Œí˜• í™”ë©´: ì±„íŒ…ë§Œ ë‚¨ê¸°ê³  ë©”ì¸(íƒ€ì¼/ì‹œê°„/ì ‘ì†ìëª©ë¡-ì»´íŒ©íŠ¸)ì„ ìˆ¨ê¹€ */
    body.compact main{ display:none !important; }
    body.compact .wrap{ grid-template-columns: 1fr !important; }
    body.compact .sidebar{
      grid-column: 1 / -1;
      height: calc(100vh - 92px);
      max-height: calc(100vh - 92px);
      overflow: auto;
    }
    body.compact .sidebar .chatCard{ height: calc(100vh - 150px); }

    .btnLabel{font-size:12px;font-weight:900;letter-spacing:-0.2px;margin-left:8px;opacity:.92;}


    /* âœ… REC(ì‘ì—…ì¤‘) í‘œì‹œ */
    .recBadge{ background: rgba(255,0,0,.14) !important; border-color: rgba(255,0,0,.35) !important; }
    .recBadge .recDot{
      width:8px;height:8px;border-radius:999px;
      background: rgb(255,60,60);
      box-shadow: 0 0 0 0 rgba(255,60,60,.55);
      animation: recPulse 1.1s infinite;
      display:inline-block;
      margin-right:6px;
      vertical-align:middle;
    }
    @keyframes recPulse{
      0%{ box-shadow:0 0 0 0 rgba(255,60,60,.50); transform:scale(1); }
      70%{ box-shadow:0 0 0 10px rgba(255,60,60,0); transform:scale(1.05); }
      100%{ box-shadow:0 0 0 0 rgba(255,60,60,0); transform:scale(1); }
    }

    /* âœ… ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ë²„íŠ¼(ì§‘ì¤‘ì‹œê°„ ë¼ë²¨ ìë¦¬) */
    .missionBtn{
      width: 34px; height: 18px;
      flex:0 0 auto;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.25);
      position: relative;
      padding: 0;
      cursor: pointer;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
      color: rgba(255,255,255,.95);
      font-size: 13px;
      font-weight: 1100;
      letter-spacing: -0.2px;
    
      display:flex; align-items:center; justify-content:center;
}
    .missionBtn[data-me="0"]{display:none !important;}

    .missionBtn::after{
      content:"";
      position:absolute; inset: 2px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      pointer-events:none;
    }
    .missionSpacer{width:34px;height:18px; display:inline-block; flex:0 0 auto; opacity:0;}
    .missionBtn.isHot{
      border-color: rgba(255,140,0,.65);
      box-shadow:
        0 0 10px rgba(255,120,0,.25),
        0 0 22px rgba(255,80,0,.14),
        inset 0 0 0 1px rgba(0,0,0,.18);
      animation: fireFlicker 1.1s infinite;
    }
    @keyframes fireFlicker{
      0%{ filter: drop-shadow(0 0 0 rgba(255,120,0,.0)); transform: translateY(0); }
      35%{ filter: drop-shadow(0 0 4px rgba(255,120,0,.35)); transform: translateY(-.3px); }
      70%{ filter: drop-shadow(0 0 6px rgba(255,80,0,.25)); transform: translateY(.2px); }
      100%{ filter: drop-shadow(0 0 0 rgba(255,120,0,.0)); transform: translateY(0); }
    }
    .missionBtn.isDone{
      border-color: rgba(255,255,255,.75);
      box-shadow:
        0 0 12px rgba(255,255,255,.22),
        0 0 26px rgba(255,255,255,.12),
        inset 0 0 0 1px rgba(0,0,0,.18);
      animation: sparkle 1.25s infinite;
    }
    @keyframes sparkle{
      0%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      50%{ filter: drop-shadow(0 0 6px rgba(255,255,255,.55)); }
      100%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
    }

    /* âœ… í­ì£½ FX ë ˆì´ì–´ */
    #fxLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }
    .fxPop{
      position: absolute;
      width: 6px; height: 6px;
      border-radius: 999px;
      opacity: .95;
      transform: translate(-50%,-50%);
      animation: fxFly 700ms ease-out forwards;
      background: rgba(255,255,255,.95);
    }
    @keyframes fxFly{
      to{
        transform: translate(var(--dx), var(--dy));
        opacity: 0;
      }
    }

    /* âœ… ëŒ€ì‹œë³´ë“œ ë¯¸ì…˜ ë¼ì¸ + ì ‘ê¸° */
    .dashMissionLine{display:flex; align-items:center; justify-content:center; text-align:center; gap:10px; margin:2px 0 8px;}
    .dashFoldBtn{
      margin-left:auto;
      height: 26px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.85);
      font-weight: 900;
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dashFoldBtn:hover{ background: rgba(0,0,0,.22); }
    /* Dashboard fold body: add breathing room between 'í˜„í™©' and 'ë°”ë¡œê°€ê¸°' rows */
    .dashFoldBody{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .dashFoldBody.isHidden{ display:none !important; }

/* âœ… v62b: ëŒ€ì‹œë³´ë“œ ì ‘ê¸°/ë„í‚¹ì—ì„œë„ ì±„íŒ…(ë¦¬ìŠ¤íŠ¸+ì…ë ¥)ì´ ì ˆëŒ€ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ë ˆì´ì•„ì›ƒ ê³ ì • */
.sidebar{
  display:flex !important;
  flex-direction:column !important;
  gap:12px !important;
  min-height:0 !important;
}
#dashboardCard{ flex:0 0 auto !important; }
#chatCard{
  flex:1 1 auto !important;
  min-height:0 !important;
  display:flex !important;
  flex-direction:column !important;
}
#chatCard > h3{ flex:0 0 auto !important; }
#chatCard .body.chatBody{
  flex:1 1 auto !important;
  min-height:0 !important;
  display:flex !important;
  flex-direction:column !important;
  overflow:hidden !important;
}
#chatList{
  flex:1 1 auto !important;
  min-height:0 !important;
  overflow:auto !important;
}
#chatCard .chatInputRow{ flex:0 0 auto !important; }

/* ì ‘ê¸° ì‹œ: ëŒ€ì‹œë³´ë“œ ì¹´ë“œì˜ 'í˜„í™©/ë°”ë¡œê°€ê¸°'ë§Œ ìˆ¨ê¹€ */
.dashFoldBody.isHidden{ display:none !important; }


/* ===== ì¶œê·¼(ì¶œì„) íŒì—… ëª¨ë‹¬ ===== */
.attModal{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;}
.attModal.hidden{display:none !important;}
.attModal .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.62); backdrop-filter: blur(6px);}
.attModal .panel{
  position:relative; z-index:1;
  width:min(860px, 94vw); height:min(720px, 86vh);
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(20, 12, 18, .82);
  box-shadow: 0 22px 60px rgba(0,0,0,.55);
  overflow:hidden;
  display:flex; flex-direction:column;
}
.attModal .head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.12);
}
.attModal .head .ttl{font-weight:1100; letter-spacing:-.3px;}
.attModal .head .xBtn{
  min-height:40px; border-radius:12px;
  padding:10px 12px;
  background: rgba(255,255,255,.06);
}
.attModal iframe{flex:1; width:100%; border:0; background:#fff;}


    /* âœ… í”„ë¡œí•„ ëª¨ë‹¬: ì¢Œì¸¡ ì •ë ¬ë¡œ (ì´ëª¨ì§€ ì‚ì£½ ë°©ì§€) */
    #profileModal .modalBody .row{justify-content:flex-start; text-align:left;}
    #profileModal .modalBody .row textarea{width:100%;}

  
/* âœ… ë¡œì»¬ í—¬í¼ ìƒíƒœ í‘œì‹œ */
.helperDot{
  width: 12px;
  height: 12px;
  border-radius: 999px;
  display: inline-block;
  box-shadow: 0 0 0 2px rgba(255,255,255,.08) inset, 0 0 12px rgba(255,105,180,.18);
}
.helperDot.on{ background: #43d17a; }
.helperDot.wait{ background: #ffd166; }
.helperDot.off{ background: rgba(255,255,255,.22); }

</style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <span class="dot" title="ë°© ë¶ˆ"></span>
      <div class="brandTitle">ğŸ’—ë§ˆëë§ˆğŸ’—</div>
    </div>

    <!-- ê°€ìš´ë°: ìƒíƒœí‘œì‹œ + ë‚´í”„ë¡œí•„ -->
    <div class="topCenter" aria-label="ì‘ì—… ìƒíƒœ">
      <button id="checkInBtn" class="ghost" disabled>ğŸ’Œì¶œê·¼ğŸ’Œ</button>
      <button id="statusBtn" class="primary" disabled>âœï¸ ì‘ì—…ì¤‘ â–¾</button>

      <div id="statusMenu" class="statusMenu hidden" role="menu" aria-label="ìƒíƒœ ì„ íƒ">
        <div class="statusBtns">
          <button id="btnWork" class="primary" disabled>âœï¸ ì‘ì—…ì¤‘</button>
          <button id="btnBreak" class="ghost" disabled>â˜• íœ´ì‹ì¤‘</button>
          <button id="btnIdle" class="ghost" disabled>ğŸŒ™ ìë¦¬ë¹„ì›€</button>
        </div>

        

      </div>


      <div class="topPills">
        <div class="pill miniPill">ğŸ•’ <span id="lastSync">-</span></div>
      </div>

      <button id="onlineBtn" class="ghost miniOnline" disabled title="ì ‘ì† ì¸ì›">ğŸ‘¥ <span id="countOnline">0</span>ëª…</button>
      <button id="profileBtn" class="ghost">ğŸªª ë‚´ í”„ë¡œí•„</button>
    </div>

    <div class="actions">
      <input id="name" placeholder="ë‹‰ë„¤ì„" maxlength="7" style="width:180px">
      <input id="roomPass" placeholder="ì…ì¥í‚¤" type="password" style="width:120px">
      <button id="joinBtn" class="primary">ì…ì¥</button>
      <button id="leaveBtn" class="primary" disabled>í‡´ì¥</button>
      <span class="meMini" id="meHint">â€”</span>
      <button id="menuBtn" class="ghost" disabled title="ì‘ì—…ë°© ì„¤ì •">â˜°</button>
    </div>
  </div>

  <div class="wrap">
    <main>
      <div class="gridHead">
        <div class="title">âœ’ï¸ì§€ê¸ˆ ì‹œê°„ <span id="nowClockMain">--:--:--</span></div>
        <div class="right"><button id="layoutToggleBtn" class="ghost layoutToggle" type="button" title="íƒ€ì¼ ì •ë ¬ ëª¨ë“œ ë³€ê²½" aria-label="íƒ€ì¼ ì •ë ¬ ëª¨ë“œ ë³€ê²½">ë¯¸ë‹ˆ ë³´ê¸°</button></div>
      </div>

      <div id="grid" class="grid"></div>
    </main>

    <aside class="sidebar">
      <div class="card" id="dashboardCard">
        <div class="dashHead">
          <h3>ğŸ’— ëŒ€ì‹œë³´ë“œ</h3>
          <div class="dashHeadRight">
            <div class="dashSuccess" title="ì˜¤ëŠ˜ ë¯¸ì…˜ ì„±ê³µ ì¸ì›">ğŸ‘‘ <span id="missionSuccessCount">0</span></div>
            <button id="dashFoldBtn" class="dashFoldBtn dashFoldBtnSmall" type="button" title="í˜„í™©/ë°”ë¡œê°€ê¸° ì ‘ê¸°/í¼ì¹˜ê¸°">
              <span id="dashFoldIcon">â–´</span>
              <span class="dashFoldTxt">ì ‘ê¸°</span>
            </button>
          </div>
        </div>
        <div class="body">
          <div id="dashFoldBody" class="dashFoldBody">
          <div class="dashRow">
            <div class="dashBox">
              <div class="dashTitle">â° ê³µìš© ë½€ëª¨</div>
              <div class="dashBig"><span id="pomoCount">â€”</span><span style="font-size:16px;font-weight:900;margin-left:6px">ëª…</span></div>
              <div class="btnRow">
                <button id="goPomo" class="primary dashGo" title="ë°”ë¡œê°€ê¸°">ğŸ‘‰ğŸ’—</button>
              </div>
              <div class="dashFoot">
                <span>ì—°ê²°: <b id="pomoOk">ì—°ê²°ë¨</b></span>
                <span class="chip">LIVE</span>
              </div>
            </div>

            <div class="dashBox">
              <div class="dashTitle">ğŸ’£ í­íŒŒ ìˆ˜ë‹¤</div>
              <div class="dashBig"><span id="sudaCount">â€”</span><span style="font-size:16px;font-weight:900;margin-left:6px">ëª…</span></div>
              <div class="btnRow">
                <button id="goSuda" class="primary dashGo" title="ë°”ë¡œê°€ê¸°">ğŸ‘‰ğŸ’—</button>
              </div>
              <div class="dashFoot">
                <span>ì—°ê²°: <b id="sudaOk">ì—°ê²°ë¨</b></span>
                <span class="chip">LIVE</span>
              </div>
            </div>
          </div>

          <div class="btnRow">
            <button id="goChool" class="ghost" title="ì¶œê·¼ë¶€">ğŸ”¥<span class="btnLabel">ì¶œê·¼ë¶€</span></button>
            <button id="goSheet" class="ghost" title="ë½€ëª¨ ì‹œíŠ¸">ğŸ“<span class="btnLabel">ë½€ëª¨ì‹œíŠ¸</span></button>
          </div>
        </div>
      </div>

      <div class="card chatCard" id="chatCard">
        <h3>ğŸ’¬ ì±„íŒ… <span class="tiny">ì§§ê²Œ, ë¹ ë¥´ê²Œ</span></h3>
        <div class="body chatBody">
          
          <div id="embedBar" class="embedBar" style="display:none">
            <div class="left">
              <span class="pill">ğŸ«§ ì„ë² ë“œ</span>
              <span id="embedTitle" class="tiny">ì—´ë¦° ì°½</span>
            </div>
            <div class="right" style="display:flex; gap:8px; align-items:center">
              <button id="embedOpen" class="ghost tight">ìƒˆ ì°½</button>
              <button id="embedClose" class="ghost tight">ë‹«ê¸°</button>
            </div>
          </div>
          <iframe id="embedFrame" class="embedFrame" style="display:none" loading="lazy" referrerpolicy="no-referrer"></iframe>

          <div id="chatList" class="chatList"></div>
          <div id="chatNewBar" class="chatNewBar" style="display:none">
            <button id="chatJumpBtn" class="ghost chatJumpBtn" type="button">
              â¬‡ï¸ ìƒˆ ë©”ì‹œì§€ <span id="chatUnseenCount">1</span> Â· ë°”ë¡œê°€ê¸°
            </button>
          </div>
          <div class="chatInputRow">

            <input id="chatInput" placeholder="ë©”ì‹œì§€â€¦" disabled />
            <button id="sendBtn" class="primary" disabled>ì „ì†¡</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="t">ğŸªª ë‚´ í”„ë¡œí•„</div>
        <button id="closeProfile" class="ghost">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <label>ì´ëª¨ì§€</label>
          <input id="emoji" placeholder="ì˜ˆ: âœï¸, ğŸ’“, ğŸ§ " maxlength="4" style="width:120px">
          <span class="tiny">í”„ë¡œí•„ íƒ€ì¼ì— í‘œì‹œë¼ìš”.</span>
        </div>

        <div class="row">
          <label>ì´ëª¨ì§€ í¬ê¸°</label>
          <input id="emojiSize" type="range" min="26" max="100" value="40" style="flex:1">
          <input id="emojiSizeNum" type="number" min="26" max="100" value="40" style="width:76px">
        </div>

        <div class="row">
          <label>ğŸ’“ ì‚¬ì§„ ì—…ë¡œë“œ</label>
          <input id="photoFile" type="file" accept="image/*,.gif" />
          <button id="uploadPhotoBtn" class="primary tight">ì—…ë¡œë“œ</button>
        </div>

        <div class="row">
          <label>ì‚¬ì§„ í¬ê¸°</label>
          <input id="photoSize" type="range" min="52" max="100" value="68" style="flex:1">
          <input id="photoSizeNum" type="number" min="52" max="100" value="68" style="width:76px">
        </div>

        <div class="row">
          <label>ì´ëª¨ì§€ ë°°ê²½</label>
          <div class="colorControls">
            <input id="emojiBgPicker" type="color" value="#2b2b2b" />
            <input id="emojiBgColor" value="#2b2b2b" style="width:110px" />
          </div>
          <span class="tiny">íˆ¬ëª… ì—†ìŒ(ì›ìƒ‰).</span>
        </div>

        <div class="row" style="align-items:flex-start;">
          <label>ğŸ’“ ë°°ê²½ìƒ‰</label>
          <div id="swatches" class="swatches" style="display:none"></div>
          <div class="colorControls">
            <input id="bgPicker" type="color" value="#ffd0e2" />
            <input id="bgColor" value="#ffd0e2" style="width:110px" />
          </div>
        </div>

        <div class="row">
          <label>ë‹‰ë„¤ì„</label>
          <input id="profileNick" type="text" maxlength="20" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 20ì)">
          <span class="tiny">ì €ì¥í•˜ë©´ ìƒë‹¨/ì±„íŒ…/ì ‘ì†ì ëª©ë¡ì— ì¦‰ì‹œ ë°˜ì˜ë¼ìš”.</span>
        </div>


        <div class="row">
          <label>ë°°ê²½ íŒ¨í„´</label>
          <select id="bgPattern" class="ghost" style="flex:1; background:#111; color:#fff; border:1px solid rgba(255,255,255,.18);">
            <option value="none">ì—†ìŒ</option>
            <option value="dots">ë„íŠ¸</option>
            <option value="hearts">í•˜íŠ¸</option>
            <option value="stars">ë³„</option>
            <option value="moon">ë‹¬</option>
            <option value="flowers">ê½ƒ</option>
            <option value="clouds">êµ¬ë¦„</option>
            <option value="catpaws">ê³ ì–‘ì´ ë°œë°”ë‹¥</option>
            <option value="dogpaws">ê°•ì•„ì§€ ë°œë°”ë‹¥</option>
            <option value="stripes">ìŠ¤íŠ¸ë¼ì´í”„</option>
            <option value="grid">ê·¸ë¦¬ë“œ</option>
            <option value="papergrid">ì¢…ì´ ê·¸ë¦¬ë“œ</option>
            <option value="waves">ì›¨ì´ë¸Œ</option>
          </select>
          <span class="tiny">ì„ íƒì°½ ë°°ê²½ë„ ì–´ë‘¡ê²Œ.</span>
        </div>


<div class="row">
  <label>íŒ¨í„´ ìƒ‰</label>
  <div class="colorControls">
    <input id="patternPicker" type="color" value="#ffffff" />
    <input id="patternColor" value="#ffffff" style="width:110px" />
  </div>
  <span class="tiny">íŒ¨í„´(ë„íŠ¸/í•˜íŠ¸/ì¤„ë¬´ëŠ¬ ë“±) ìƒ‰ë§Œ ë°”ê¿”ìš”.</span>
</div>

<div class="row">
          <label>ë§í’ì„  ê¸€(ìµœëŒ€ 15ì)</label>
          <textarea id="bubbleText" placeholder="ì§€ê¸ˆ ìƒíƒœ í•œ ë§ˆë””!" maxlength="15"></textarea>
        </div>

        <div class="row">
          <label>ë§í’ì„  ë°°ê²½</label>
          <div class="colorControls">
            <input id="bubblePicker" type="color" value="#ffd0e2" />
            <input id="bubbleColor" value="#ffd0e2" style="width:110px" />
          </div>
        </div>

        <div class="row">
          <label>ğŸ’“ ì‹œê°„ ìƒ‰</label>
          <div class="colorControls">
            <input id="timePicker" type="color" value="#ffffff" />
            <input id="timeColor" value="#ffffff" style="width:110px" />
          </div>
          <span class="tiny">ì§‘ì¤‘=ì„ íƒìƒ‰, íœ´ì‹/ìë¦¬ë¹„ì›€=íšŒìƒ‰ ê³ ì •</span>
        </div>

        
        <div class="row">
          <label>í—¬í¼ ìƒíƒœ</label>
          <div class="helperStatusLine" style="width:100%; display:flex; align-items:center; gap:10px;">
            <span id="helperStatusDot" class="helperDot off" aria-hidden="true"></span>
            <span id="helperStatusText" class="tiny" style="font-weight:900; letter-spacing:.2px;">ë¯¸ì—°ê²°</span>
          </div>
          <span class="tiny">PC í™œë™ ê°ì§€ìš© ë¡œì»¬ í—¬í¼ê°€ ì¼œì ¸ ìˆìœ¼ë©´ â€˜ì—°ê²°ë¨â€™ìœ¼ë¡œ í‘œì‹œë¼ìš”.</span>
        </div>


        <div class="row">
          <label>í—¬í¼ ëª¨ë“œ</label>
          <div style="display:flex; gap:10px; width:100%; flex-wrap:wrap; align-items:center;">
            <select id="helperMode" style="width:170px; font-weight:1000;">
              <option value="manual">ìˆ˜ë™(ì•ˆì „)</option>
              <option value="auto">ìë™(ì—°ë™)</option>
            </select>
            <span id="helperDebugText" class="tiny" style="font-weight:900; opacity:.9;"></span>
          </div>
          <span class="tiny">ìë™=ë¬´ë°˜ì‘ ì‹œ íœ´ì‹/ìë¦¬ë¹„ì›€ ì „í™˜. ìˆ˜ë™=ë²„íŠ¼ìœ¼ë¡œë§Œ ìƒíƒœ ë³€ê²½(í—¬í¼ëŠ” í‘œì‹œ/ë³µê·€ë§Œ).</span>
        </div>

<div class="row autoSwitchRow" style="display:flex" aria-hidden="false">
          <label>ìë™ ì „í™˜</label>
          <div style="display:flex; gap:10px; width:100%; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; justify-content:center; text-align:center; gap:8px;">
              <span class="tiny" style="min-width:86px; opacity:.9;">íœ´ì‹(ë¶„)</span>
              <input id="autoBreakMin" type="number" min="1" max="180" value="10" style="width:76px" disabled>
            </div>
            <div style="display:flex; align-items:center; justify-content:center; text-align:center; gap:8px;">
              <span class="tiny" style="min-width:86px; opacity:.9;">ìë¦¬ë¹„ì›€(ë¶„)</span>
              <input id="autoIdleMin" type="number" min="1" max="180" value="15" style="width:76px" disabled>
            </div>
          </div>
          <span class="tiny">ì‘ì—…ì¤‘ì¼ ë•Œë§Œ ì ìš©ë¼ìš”. (ê¸°ë³¸: 10/15ë¶„)</span>
        </div>

<div class="row">
          <button id="applyProfile" class="ghost">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Room Settings Modal (Admin) -->
  <div id="settingsModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="t">âš™ï¸ ì‘ì—…ë°© ì„¤ì •</div>
        <button id="closeSettings" class="ghost">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="hint">
          ì²˜ìŒ ì„¤ì •í•˜ëŠ” ì‚¬ëŒì€ â€œê´€ë¦¬ì ë¹„ë²ˆâ€ì„ ë“±ë¡í•˜ê³ , ì´í›„ë¶€í„°ëŠ” ë¹„ë²ˆì´ ìˆì–´ì•¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.
        </div>
        <div class="row">
          <input id="adminPass" type="password" placeholder="ê´€ë¦¬ì ë¹„ë²ˆ" />
          <button id="adminUnlock" class="primary tight">í™•ì¸</button>
        </div>

        <div id="adminArea" style="display:none">
          <div class="hr"></div>
          <div class="hint">ëŒ€ì‹œë³´ë“œ ë§í¬(ë£¸ ê³µìš©)</div>
          <div class="row">
            <input id="pomoUrl" placeholder="â° ê³µìš© ë½€ëª¨ ë§í¬" />
            <input id="sudaUrl" placeholder="ğŸ’£ í­íŒŒ ìˆ˜ë‹¤ ë§í¬" />
          </div>
          <div class="row">
            <input id="choolUrl" placeholder="ğŸ”¥ ì¶œê·¼ë¶€ ë§í¬" />
            <input id="sheetUrl" placeholder="ğŸ”— ë½€ëª¨ ì‹œíŠ¸ ë§í¬" />
          </div>
          <div class="row">
            <input id="dashApiUrl" placeholder="ğŸ“¡ ëŒ€ì‹œë³´ë“œ ì¸ì› API (Apps Script .../exec?api=counts&callback=cb)" />
          </div>
          <div class="row">
            <button id="saveDash" class="primary">ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div id="ctxMenu" class="ctxMenu hidden" role="menu" aria-hidden="true">
    <div class="title" id="ctxTitle">í”„ë¡œí•„</div>
    <button id="ctxKick" class="danger" type="button">ğŸš« ê°•í‡´</button>
    <button id="ctxClose" type="button">ë‹«ê¸°</button>
  </div>

  <div id="toast" class="toast">ì €ì¥í–ˆì–´!</div>

  
  <!-- Mission Modal -->
  <div id="missionModal" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="t">ğŸ¯ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</div>
        <button id="closeMission" class="ghost" type="button">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <label>ë¯¸ì…˜</label>
          <input id="missionText" placeholder="ì˜ˆ: 2000ì ì“°ê¸° / 25ë¶„ 2ì„¸íŠ¸" maxlength="60" style="flex:1">
        </div>
        <div class="row">
          <label>ì„±ê³µ</label>
          <label style="display:flex;align-items:center;gap:10px; font-weight:900;">
            <input id="missionDone" type="checkbox" />
            ì˜¤ëŠ˜ ë¯¸ì…˜ ì™„ë£Œí–ˆì–´ìš” ğŸ‘‘
          </label>
        </div>
        <div class="tiny" style="opacity:.8; line-height:1.4;">
          - ìì •(KST)ì— ìë™ ì´ˆê¸°í™”ë¼ìš”.<br>
          - ì„±ê³µ ì²´í¬í•˜ë©´ ë²„íŠ¼ì´ ë°˜ì§ + í›ˆì¥ + ì‘ì€ í­ì£½!
        </div>
      </div>
      <div class="modalFooter">
        <button id="saveMission" class="primary" type="button">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- FX layer for fireworks -->
  <div id="fxLayer" aria-hidden="true"></div>

<script type="module">
    // BOOT FLAG (module ok)
    window.__MK_BOOT_OK__ = true;

    // -----------------------------
    // ê³ ì • ë£¸ ì•„ì´ë”” (í†µì¼)
    // -----------------------------
    const FIXED_ROOM_ID = "magamm";
    // -----------------------------
    // âœ… í´ë¼ì´ì–¸íŠ¸ ì…ì¥í‚¤(ê°„ì´ ê²Œì´íŠ¸)
    // - ë³´ì•ˆ "ê°•í™”"ìš©(ì™„ì „ ì°¨ë‹¨ì€ Firestore Rules/ì¸ì¦ì´ í•„ìš”)
    // -----------------------------
    
    // âœ… í´ë¼ì´ì–¸íŠ¸ ì…ì¥í‚¤(ê°„ì´ ê²Œì´íŠ¸)
    // - GitHubì— 'ë¹„ë°€ë²ˆí˜¸(í‰ë¬¸)'ê°€ ë°•íˆì§€ ì•Šê²Œ: í‰ë¬¸ ëŒ€ì‹  SHA-256 í•´ì‹œë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
    // - âš ï¸ ì •ì  ì›¹ì€ ì½”ë“œê°€ ê³µê°œë˜ë¯€ë¡œ 'ì™„ì „ ë³´ì•ˆ'ì€ ë¶ˆê°€. ì§„ì§œ ì°¨ë‹¨ì€ Firebase Rules/ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.
    const ROOM_PASS_HASH = "0a34102dc560b97344f99ed8369092fc9921804a4a6101118485ac946f0739e8"; // sha256("mkm1919")

    async function sha256Hex(str){
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    async function isRoomPassValid(pass){
      const p = (pass ?? "").toString().trim();
      if(!p) return false;
      try{
        const h = await sha256Hex(p);
        return h === ROOM_PASS_HASH;
      }catch(e){
        return false;
      }
    }

    

    // âœ… Root helpers (module ìµœìƒë‹¨) â€” ìŠ¤ì½”í”„ ê¼¬ì„/ì¤‘ë³µ ì„ ì–¸ ë°©ì§€
    function showToast(msg, ms=1600){
      try{
        const el = document.getElementById("toast");
        if(!el){ console.log("toast:", msg); return; }
        el.textContent = msg;
        el.classList.add("show");
        if(window.__toastTimer) clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=>el.classList.remove("show"), ms);
      }catch(e){
        console.log("toast:", msg);
      }
    }

    // âœ… ì§‘ì¤‘ì‹œê°„(24ì‹œê°„ ëˆ„ì , ìì • ë¦¬ì…‹) â€” ìµœìƒë‹¨ ì „ì—­ ìœ í‹¸
    const __LS_FOCUS_DAY = "mk_focus_day";
    const __LS_FOCUS_SEC = "mk_focus_sec";
    function __seoulDateKey(){
      try{
        const now = new Date();
        const utc = now.getTime() + now.getTimezoneOffset()*60000;
        const kst = new Date(utc + 9*3600000);
        const y = kst.getFullYear();
        const m = String(kst.getMonth()+1).padStart(2,"0");
        const d = String(kst.getDate()).padStart(2,"0");
        return `${y}-${m}-${d}`;
      }catch(e){
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      }
    }

    // âœ… ì¶œê·¼(ì¶œì„) ë²„íŠ¼ ìƒíƒœ(ë¡œì»¬): ì˜¤ëŠ˜ ì¶œê·¼í–ˆëŠ”ì§€ í‘œì‹œìš©
    const __LS_CHECKIN_DAY = "mk_checkin_day";
    let __lastCheckinUIKey = ""; // ë‚ ì§œ ë°”ë€” ë•Œ UI ê°±ì‹ 

    function __isCheckedInToday(){
      try{
        const today = __seoulDateKey();
        return (localStorage.getItem(__LS_CHECKIN_DAY) || "") === today;
      }catch(e){ return false; }
    }
    function __markCheckedInToday(){
      try{ localStorage.setItem(__LS_CHECKIN_DAY, __seoulDateKey()); }catch(e){}
    }
    function __applyCheckInBtnUI(btn){
      if(!btn) return;
      const done = __isCheckedInToday();
      if(done){
        btn.textContent = "âœ…ì¶œê·¼ì™„ë£Œ";
        btn.classList.add("checkinDone");
        btn.classList.remove("checkinPulse");
        btn.setAttribute("data-checkin","done");
      }else{
        btn.textContent = "ğŸ’Œì¶œê·¼ğŸ’Œ";
        btn.classList.remove("checkinDone");
        btn.classList.add("checkinPulse");
        btn.setAttribute("data-checkin","need");
      }
    }

    function focusLoadSeconds(){
      const today = __seoulDateKey();
      try{
        const day = localStorage.getItem(__LS_FOCUS_DAY) || "";
        const sec = Number(localStorage.getItem(__LS_FOCUS_SEC) || 0);
        if(day !== today){
          localStorage.setItem(__LS_FOCUS_DAY, today);
          localStorage.setItem(__LS_FOCUS_SEC, "0");
          return 0;
        }
        return isFinite(sec) ? Math.max(0, sec) : 0;
      }catch(e){
        return 0;
      }
    }
    function focusSaveSeconds(sec){
      const today = __seoulDateKey();
      try{
        localStorage.setItem(__LS_FOCUS_DAY, today);
        localStorage.setItem(__LS_FOCUS_SEC, String(Math.max(0, Math.floor(Number(sec)||0))));
      }catch(e){}
    }

    function getRemoteMissionInfoByName(name){
      try{
        const n = String(name||"").trim();
        if(!n) return null;
        const mp = state.missionLastByName;
        if(!mp || !(mp instanceof Map)) return null;
        return mp.get(n) || null;
      }catch(e){ return null; }
    }
    function updateMissionBtnForTile(btn, p){
      try{
        if(!btn) return;
        const isMe = (btn.dataset.me==="1") || ((btn.dataset.owner||"") && state.uid && (btn.dataset.owner===state.uid));
        btn.classList.remove("isHot","isDone");
        btn.textContent = "";

        // âœ… ë¯¸ì…˜ ë²„íŠ¼: ë‚´ ê²ƒë§Œ ë…¸ì¶œ (ìƒëŒ€ë°© ë²„íŠ¼ì€ ìˆ¨ê¹€)
        if(!isMe){
          btn.style.display = "none";
        }else{
          btn.style.display = "flex";
        }

        const today = seoulDateKey();

        // --- ë‚´ íƒ€ì¼ ---
        if(isMe){
          const m = state.myMission || loadMissionLocal();
          if(m && m.done){
            btn.classList.add("isDone");
            btn.textContent = "ğŸ‘‘";
            btn.title = `ë¯¸ì…˜ ì„±ê³µ! ${m.text||""}`.trim();
            btn.setAttribute("aria-label", `ë¯¸ì…˜ ì„±ê³µ: ${m.text||"ì˜¤ëŠ˜ì˜ ë¯¸ì…˜"}`);
          }else{
            btn.classList.add("isHot");
            const text = (m && m.text) ? String(m.text) : "";
            btn.title = text ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${text}` : "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì„¤ì •í•˜ê¸°";
            btn.setAttribute("aria-label", text ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${text}` : "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì„¤ì •í•˜ê¸°");
          }
          return;
        }

        // --- ë‹¤ë¥¸ ì‚¬ëŒ íƒ€ì¼ ---
        // ìƒëŒ€ë°© ë¯¸ì…˜ ë²„íŠ¼ì€ ìˆ¨ê¹€ (ì´í™íŠ¸/ë©”ë‹¬ í‘œì‹œëŠ” ë³„ë„ ë¡œì§ ìœ ì§€)
        return;


        // fallback: mission ì´ë²¤íŠ¸ ê¸°ë°˜
        const info = getRemoteMissionInfoByName(fullName);
        if(info && info.action==="done"){
          btn.classList.add("isDone");
          /* â£ ìƒì‹œ í‘œì‹œ(ìƒëŒ€ë°©) */
          btn.title = info.text ? `${fullName} ë¯¸ì…˜ ì„±ê³µ! ${info.text}` : `${fullName} ë¯¸ì…˜ ì„±ê³µ!`;
          btn.setAttribute("aria-label", info.text ? `${fullName} ë¯¸ì…˜ ì„±ê³µ: ${info.text}` : `${fullName} ë¯¸ì…˜ ì„±ê³µ`);
        }else if(info && info.text){
          btn.classList.add("isHot");
          btn.title = `${fullName} ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${info.text}`;
          btn.setAttribute("aria-label", `${fullName} ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${info.text}`);
        }else{
          btn.title = `${fullName} ì•„ì§ ë¯¸ì…˜ ì—†ìŒ`;
          btn.setAttribute("aria-label", `${fullName} ì•„ì§ ë¯¸ì…˜ ì—†ìŒ`);
        }
      }catch(e){}
    }

    function refreshAllMissionButtons(){
      try{
        document.querySelectorAll(".missionBtn").forEach(btn=>{
          const owner = btn.dataset.owner || "";
          const p = (owner && state.currentParticipants && state.currentParticipants.get)
            ? (state.currentParticipants.get(owner) || null)
            : null;
          updateMissionBtnForTile(btn, p || { id: owner, name: btn.dataset.name || "" });
        });
      }catch(e){}
    }

    // âœ… ì´ë¦„ìœ¼ë¡œ íƒ€ì¼ ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ê¸°(í­ì£½/ë©”ë‹¬ í‘œì‹œìš©)

    function findTileElByName(name){
      try{
        const n = String(name||"").trim();
        if(!n) return null;
        const esc = (window.CSS && CSS.escape) ? CSS.escape(n) : n.replace(/["\\]/g, "\\$&");
        return document.querySelector(`.tile[data-name="${esc}"]`);
      }catch(e){ return null; }
    }
    // âœ… íƒ€ì¼ ë©”ë‹¬(ğŸ‘‘) í‘œì‹œ ì—…ë°ì´íŠ¸ â€” ë¯¸ë‹ˆëª¨ë“œì—ì„œë„ ë³´ì´ê²Œ
    function updateMissionMedalForTile(medalEl, p){
      try{
        if(!medalEl) return;

        const fullName = normalizeNick(p?.name || p?.id || "");
        const isMe = (p && p.id && state.uid) ? (p.id === state.uid) : false;

        const today = seoulDateKey();
        let done = false;
        let text = "";

        if(isMe){
          const m = state.myMission || loadMissionLocal();
          done = !!(m && m.done);
          text = String(m?.text||"").trim();
        }else if(p && p.mission && String(p.mission.dayKey||"") === String(today)){
          done = !!p.mission.done;
          text = String(p.mission.text||"").trim();
        }else{
          // fallback: mission ì´ë²¤íŠ¸ ê¸°ë°˜
          const info = getRemoteMissionInfoByName(fullName);
          done = !!(info && info.action==="done");
          text = String(info?.text||"").trim();
        }

        medalEl.textContent = "ğŸ‘‘";
        medalEl.title = done
          ? (text ? `${fullName} ë¯¸ì…˜ ì„±ê³µ! ${text}` : `${fullName} ë¯¸ì…˜ ì„±ê³µ!`)
          : (text ? `${fullName} ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${text}` : `${fullName} ë¯¸ì…˜ ë¯¸ì™„ë£Œ`);
        medalEl.classList.toggle("hidden", !done);
      }catch(e){}
    }

    function refreshAllMissionMedals(){

      try{
        for(const [uid, rec] of state.lastRendered.entries()){
          if(!rec?.el) continue;
          const p = state.currentParticipants.get(uid);
          if(!p) continue;
          const medal = rec.el.querySelector(".missionMedal");
          updateMissionMedalForTile(medal, p);
        }
      }catch(e){}
    }

    function persistMyFocusToLocal(){
      try{ focusSaveSeconds((state && state.focusSecondsTotal) || 0); }catch(e){}
    }

const PASS_TTL_MS = 24 * 60 * 60 * 1000; // 24h
    const LS_PASS = "mk_room_pass";
    const LS_PASS_EXP = "mk_room_pass_exp";
    const LS_PASS_OK = "mk_room_pass_ok";
    const LS_PROFILE = "mk_profile_pref_v1";

    // âœ… ì§‘ì¤‘ì‹œê°„(24ì‹œê°„ ëˆ„ì , ìì • ë¦¬ì…‹)
    const LS_FOCUS_DAY = "mk_focus_day";
    const LS_FOCUS_SEC = "mk_focus_sec";

    // âœ… ëŒ€ì‹œë³´ë“œ ì‹¤ì‹œê°„ API ê¸°ë³¸ê°’
    // - ì„¤ì •ì—ì„œ ë¹„ì›Œë„ ì´ ê°’ìœ¼ë¡œ ìë™ ì‚¬ìš©
    const DEFAULT_DASH_API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhCZiB9bWPP17OFdi8Iun-HZQ2m-_RV3MTXTyoLlkhP1tZh7Ezl6woyiCzx7OeNnJ7qIjVyMaYns_7dHcxYaqak8uJPcJmkjDfdVWKJErRsnFO_T98PyWjMHLA_XFClehZR9s1-3hnRXdXGh2fPETxMzfsTY-ugf7XlXmml3xX2DCIqNFxTmUIM8u61FWKdtZCUjnEXANH8TaPp0BfGbqLSmz8IfiaAd3c8C0zNAIjLfw-AIpndxPgDHsGQCnDR5qxsI_cVfkbbAWkcmJPRxVVrWNKlcYtpRmeLUjzjo324hiSgKFEAnBA9p353E1pTH3vDi1N8&lib=MvZy7pc3gESHKkPg0RUcEYKjZiy7tesAR";

    // âœ… ë¡œì»¬ í—¬í¼(PC ì „ì—­ í™œë™)ìš© Realtime Database
    const RTDB_BASE_URL = "https://magamm00-5baee-default-rtdb.asia-southeast1.firebasedatabase.app";


    let els = {};
    // -----------------------------
    // âœ… Tile layout modes (default / compact5)
    // -----------------------------
    const LS_LAYOUT_MODE = "mk_layout_mode_v1";
    function getLayoutMode(){
      try{ return localStorage.getItem(LS_LAYOUT_MODE) || "default"; }catch(e){ return "default"; }
    }
    function setLayoutMode(mode){
      try{ localStorage.setItem(LS_LAYOUT_MODE, mode); }catch(e){}
    }
    function applyLayoutMode(mode){
      const g = els.grid;
      if(!g) return;
      if(mode === "compact5"){
        g.classList.add("compact5");
      }else{
        g.classList.remove("compact5");
        mode = "default";
      }
      // Button label
      if(els.layoutToggleBtn){
        els.layoutToggleBtn.textContent = (mode === "compact5") ? "ê¸°ë³¸ ë³´ê¸°" : "ë¯¸ë‹ˆ ë³´ê¸°";
      }
    }
    function toggleLayoutMode(){
      const cur = getLayoutMode();
      const next = (cur === "compact5") ? "default" : "compact5";
      setLayoutMode(next);
      applyLayoutMode(next);
    }
    

    function loadPassOK(){
      try{
        const ok = (localStorage.getItem(LS_PASS_OK) === "1");
        const exp = Number(localStorage.getItem(LS_PASS_EXP) || 0);
        if(ok && exp && Date.now() <= exp){
          document.body.classList.add("passok");
          return true;
        }
        // ë§Œë£Œ/ê¹¨ì§ì´ë©´ ì •ë¦¬
        if(exp && Date.now() > exp){
          localStorage.removeItem(LS_PASS_OK);
          localStorage.removeItem(LS_PASS_EXP);
        }
      }catch(e){}
      return false;
    }

function savePassOK(pass){
      try{
        // ğŸ”’ í‰ë¬¸ì€ 'ë‚´ ì»´í“¨í„° ë¡œì»¬'ì—ë§Œ ì €ì¥(ì¬ì…ë ¥ ê·€ì°®ìŒ ë°©ì§€)
        localStorage.setItem(LS_PASS, String(pass || ""));
        localStorage.setItem(LS_PASS_OK, "1");
        localStorage.setItem(LS_PASS_EXP, String(Date.now() + PASS_TTL_MS));
      }catch(e){}
      document.body.classList.add("passok");
      try{ if(els.roomPass) els.roomPass.value = ""; }catch(e){}
    }

    function clearPassOK(){
      try{
        localStorage.removeItem(LS_PASS);
        localStorage.removeItem(LS_PASS_OK);
        localStorage.removeItem(LS_PASS_EXP);
      }catch(e){}
      document.body.classList.remove("passok");
    }

async function requirePassOK(){
      if(loadPassOK()) return true;
      const typed = (els.roomPass?.value || "").trim();
      let stored = "";
      try{ stored = (localStorage.getItem(LS_PASS) || "").trim(); }catch(e){}

      if(typed){
        const ok = await isRoomPassValid(typed);
        if(!ok){
          showToast("ì…ì¥í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì¤˜!", 2500);
          try{ els.roomPass?.focus(); }catch(e){}
          return false;
        }
        savePassOK(typed);
        return true;
      }

      if(stored){
        const ok = await isRoomPassValid(stored);
        if(ok){
          savePassOK(stored);
          return true;
        }
      }

      showToast("ì…ì¥í‚¤ë¥¼ ì…ë ¥í•´ì¤˜!", 2500);
      try{ els.roomPass?.focus(); }catch(e){}
      return false;
    }

function loadLocalProfile(){
      try{
        const raw = localStorage.getItem(LS_PROFILE);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return null;
        return obj;
      }catch(e){ return null; }
    }
    function saveLocalProfile(obj){
      try{
        localStorage.setItem(LS_PROFILE, JSON.stringify(obj || {}));
      }catch(e){}
    }


    // -----------------------------
    // Firebase ì„¤ì • (ì—¬ê¸°ë§Œ ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´)
    // -----------------------------
   const firebaseConfig = {
    apiKey: "AIzaSyAmhsxF7syCPNfgIVb2ZIQBxgGV_rZ2nDI",
    authDomain: "magamm00-5baee.firebaseapp.com",
    projectId: "magamm00-5baee",
    storageBucket: "magamm00-5baee.firebasestorage.app",
    messagingSenderId: "829544685832",
    appId: "1:829544685832:web:7ae0a5a2cd48cb62a6ccbd",
    measurementId: "G-CFQ6KZ7R7B"
  };

    // Firebase imports (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
      collection, onSnapshot, serverTimestamp, addDoc, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

; (async ()=>{


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // DOM
    const $ = (id) => document.getElementById(id);
    els = {
      name: $("name"),
      roomPass: $("roomPass"),
      joinBtn: $("joinBtn"),
      leaveBtn: $("leaveBtn"),
      menuBtn: $("menuBtn"),
      grid: $("grid"),
      countOnline: $("countOnline"),
      lastSync: $("lastSync"),
      nowClockMain: $("nowClockMain"),
      layoutToggleBtn: $("layoutToggleBtn"),

      ctxMenu: $("ctxMenu"),
      ctxTitle: $("ctxTitle"),
      ctxKick: $("ctxKick"),
      ctxClose: $("ctxClose"),

      dashUpdated: $("dashUpdated"),
      pomoCount: $("pomoCount"),
      sudaCount: $("sudaCount"),
      pomoOk: $("pomoOk"),
      sudaOk: $("sudaOk"),
      goPomo: $("goPomo"),
      goPomoMini: $("goPomoMini"),
      goSudaMini: $("goSudaMini"),
      statusRosterList: $("statusRosterList"),
      goSuda: $("goSuda"),
      goChool: $("goChool"),
      goSheet: $("goSheet"),

      chatList: $("chatList"),
      chatNewBar: $("chatNewBar"),
      chatJumpBtn: $("chatJumpBtn"),
      chatUnseenCount: $("chatUnseenCount"),
      chatInput: $("chatInput"),
      sendBtn: $("sendBtn"),
      embedBar: $("embedBar"),
      embedTitle: $("embedTitle"),
      embedOpen: $("embedOpen"),
      embedClose: $("embedClose"),
      embedFrame: $("embedFrame"),
      embedModal: $("embedModal"),
      closeEmbedModal: $("closeEmbedModal"),
      embedModalTitle: $("embedModalTitle"),
      embedModalOpen: $("embedModalOpen"),
      embedModalFrame: $("embedModalFrame"),

      btnWork: $("btnWork"),
      btnBreak: $("btnBreak"),
      btnIdle: $("btnIdle"),
      checkInBtn: $("checkInBtn"),
      statusBtn: $("statusBtn"),
      statusMenu: $("statusMenu"),
      profileBtn: $("profileBtn"),
      onlineBtn: $("onlineBtn"),
      meHint: $("meHint"),

      profileModal: $("profileModal"),
      closeProfile: $("closeProfile"),
      emoji: $("emoji"),
      emojiBgPicker: $("emojiBgPicker"),
      emojiBgColor: $("emojiBgColor"),
      emojiSize: $("emojiSize"),
      emojiSizeNum: $("emojiSizeNum"),
      photoSize: $("photoSize"),
      photoSizeNum: $("photoSizeNum"),
      swatches: $("swatches"),
      bgPicker: $("bgPicker"),
      bgColor: $("bgColor"),
      bgPattern: $("bgPattern"),
      patternPicker: $("patternPicker"),
      patternColor: $("patternColor"),
      bubbleText: $("bubbleText"),
      bubblePicker: $("bubblePicker"),
      bubbleColor: $("bubbleColor"),
      timePicker: $("timePicker"),
      timeColor: $("timeColor"),
      helperStatusDot: $("helperStatusDot"),
      helperStatusText: $("helperStatusText"),
      helperMode: $("helperMode"),
      helperDebugText: $("helperDebugText"),
      photoFile: $("photoFile"),
      uploadPhotoBtn: $("uploadPhotoBtn"),
      profileNick: $("profileNick"),
      autoBreakMin: $("autoBreakMin"),
      autoIdleMin: $("autoIdleMin"),
      applyProfile: $("applyProfile"),

      dashboardCard: $("dashboardCard"),
      chatCard: $("chatCard"),

      settingsModal: $("settingsModal"),
      closeSettings: $("closeSettings"),
      adminPass: $("adminPass"),
      adminUnlock: $("adminUnlock"),
      adminArea: $("adminArea"),
      pomoUrl: $("pomoUrl"),
      sudaUrl: $("sudaUrl"),
      choolUrl: $("choolUrl"),
      sheetUrl: $("sheetUrl"),
      saveDash: $("saveDash"),

      toast: $("toast"),
    };

    
    function isConfigPlaceholder(v){
      return typeof v === "string" && (v.startsWith("YOUR_") || v.includes("YOUR_PROJECT"));
    }
    function validateFirebaseConfig(){
      const missing = [];
      if(!firebaseConfig || typeof firebaseConfig !== "object"){ missing.push("firebaseConfig"); return missing; }
      const keys = ["apiKey","authDomain","projectId","storageBucket"];
      for(const k of keys){
        const v = firebaseConfig[k];
        if(!v || isConfigPlaceholder(v)) missing.push(k);
      }
      return missing;
    }
    function friendlyAuthHint(code){
      if(!code) return "";
      if(code.includes("auth/operation-not-allowed")) return "â¡ï¸ Firebase Authenticationì—ì„œ 'ìµëª…(Anonymous)' ë¡œê·¸ì¸ í™œì„±í™”ê°€ í•„ìš”í•´.";
      if(code.includes("auth/invalid-api-key")) return "â¡ï¸ firebaseConfigì˜ apiKeyê°€ ì˜ëª»ëì–´.";
      if(code.includes("auth/invalid-credential")) return "â¡ï¸ firebaseConfigê°€ í”„ë¡œì íŠ¸ì™€ ë§ëŠ”ì§€ í™•ì¸í•´ì¤˜.";
      if(code.includes("auth/network-request-failed")) return "â¡ï¸ ë„¤íŠ¸ì›Œí¬/ë°©í™”ë²½ ë¬¸ì œì¼ ìˆ˜ ìˆì–´. ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ë¡œë„ í…ŒìŠ¤íŠ¸í•´ë´.";
      return "";
    }

    const state = {
      myMission: null,
      uid: null,
      roomId: FIXED_ROOM_ID,
      unsubParticipants: null,
      _lastDayKey: null,
      unsubRoom: null,
      unsubChat: null,
            focusPersistTimer: null,
      didFocusMerge: false,
      sfxInitDone: false,
      lastSfxTs: 0,
chatUnseen: 0,
      chatUserNearBottom: true,

      unsubKick: null,
      unsubMissions: null,
      missionDayKey: null,
      missionSuccessCount: 0,
      tickTimer: null,
      hbTimer: null,
      currentParticipants: new Map(),
      myPhotoUrl: "",
      adminOk: false,
      adminHash: null,
      roomSettings: {
        dashboard: {pomoUrl:"", sudaUrl:"", choolUrl:"", sheetUrl:"", dashApiUrl: DEFAULT_DASH_API_URL},
        dashCounts: {pomoCount:null, sudaCount:null, updatedAtMs:null},
        adminHash: null
      },
      localDashCounts: {pomoCount:null, sudaCount:null, updatedAtMs:null},
      dashPollTimer: null,
      dashPollUrl: "",
      lastRendered: new Map(),
      lastActivityMs: Date.now(),
      helperWatchTimer: null,
      helperActive: false,
      _prevHelperActive: false,
      helperLastTs: 0,
      helperLastSeenMs: 0,
      helperMode: 'auto',
      helperIdleSec: null,
      helperIdleSecPresent: false,
      helperIdleZeroStreak: 0,
      _helperInactiveSinceMs: 0,
      activityWatchTimer: null,
      activityThrottleMs: 0,
      joined: false,
      ctxTarget: { uid:null, name:null },

    };

    // Helpers

    // âœ… Nickname rules
    const NICK_MAX = 7;
    function normalizeNick(raw){
      const s = (raw ?? "").toString().trim().replace(/\s+/g, "");
      const arr = Array.from(s);
      return arr.slice(0, NICK_MAX).join("");
    }
    function miniNick(raw){
      const s = normalizeNick(raw);
      const arr = Array.from(s);
      if(arr.length <= 3) return s;
      return arr.slice(0, 3).join("") + "â€¦";
    }

    function shortNick(raw, maxChars=4){
      const s = normalizeNick(raw);
      const arr = Array.from(s);
      if(arr.length <= maxChars) return s;
      return arr.slice(0, maxChars).join("") + "â€¦";
    }


    

    function setMyNickUI(nick){
      try{
        const n = normalizeNick(nick);
        state.nickname = n;
        try{ if(els.name && els.name.value !== n) els.name.value = n; }catch(e){}
        if(!n) return;
        // ìƒë‹¨ ë‹‰ë„¤ì„ pill (ìˆë‹¤ë©´)
        if(els.nickPill) els.nickPill.textContent = n;
        // ì°¸ê°€ì ëª©ë¡/íƒ€ì¼ì€ Firestore ì—…ë°ì´íŠ¸ë¡œ ìë™ ë°˜ì˜ë˜ì§€ë§Œ,
        // ë¡œì»¬ stateì—ë„ ë°˜ì˜í•´ë‘ë©´ ì¦‰ì‹œ í‘œì‹œê°€ ìì—°ìŠ¤ëŸ¬ì›€
      }catch(e){}
    }
function toast(msg, ms=1600){
      try{
        els.toast.textContent = msg;
        els.toast.classList.add("show");
        if(window.__toastTimer) clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=>els.toast.classList.remove("show"), ms);
      }catch(e){
        console.log("toast:", msg);
      }
    }

    // onSnapshot ì—°ê²°ì´ ë£°/ê¶Œí•œ ë¬¸ì œë¡œ í„°ì ¸ë„ ì…ì¥ ìì²´ê°€ ì£½ì§€ ì•Šê²Œ ë³´í˜¸
    function safeOnSnapshot(refOrQuery, next){
      try{
        return onSnapshot(refOrQuery, next, (err)=>{
          console.warn('onSnapshot error', err);
        });
        // âœ… ë‚´ ì „ì†¡ ì§í›„ ë°”ë‹¥ìœ¼ë¡œ ì´ë™(ì í”„ ìµœì†Œí™”)
        try{ els.chatList.scrollTop = els.chatList.scrollHeight; }catch(e){}
      }catch(err){
        console.warn('onSnapshot attach failed', err);
        return ()=>{};
      }
    }


    // --- ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ---
    function hideCtxMenu(){
      if(!els.ctxMenu) return;
      els.ctxMenu.classList.add("hidden");
      els.ctxMenu.setAttribute("aria-hidden","true");
      state.ctxTarget = {uid:null, name:null};
    }
    function openCtxMenu(x, y, p){
      if(!els.ctxMenu) return;
      state.ctxTarget = { uid: p.id, name: p.name || p.id };
      els.ctxTitle.textContent = `${state.ctxTarget.name}`;
      const canKick = !!(state.joined && state.uid && p.id && p.id !== state.uid);
      els.ctxKick.disabled = !canKick;

      const m = els.ctxMenu;
      m.classList.remove("hidden");
      m.setAttribute("aria-hidden","false");

      // ìœ„ì¹˜: í™”ë©´ ë°–ìœ¼ë¡œ íŠ€ì§€ ì•Šê²Œ ë³´ì •
      const vw = window.innerWidth || 0;
      const vh = window.innerHeight || 0;
      m.style.left = "0px"; m.style.top = "0px";
      const rect = m.getBoundingClientRect();
      let left = x, top = y;
      if(left + rect.width + 10 > vw) left = Math.max(10, vw - rect.width - 10);
      if(top + rect.height + 10 > vh) top = Math.max(10, vh - rect.height - 10);
      left = Math.max(10, left);
      top = Math.max(10, top);
      m.style.left = `${left}px`;
      m.style.top = `${top}px`;
    }

    const KICK_BLOCK_MS = 2 * 60 * 60 * 1000; // 2ì‹œê°„ ì¬ì…ì¥ ì°¨ë‹¨(ì›í•˜ë©´ ì¡°ì ˆ ê°€ëŠ¥)

    async function requestKick(targetUid, targetName){
      if(!state.roomId || !state.uid || !targetUid) return;
      try{
        const now = Date.now();
        await setDoc(kickRef(state.roomId, targetUid), {
          kickedAtMs: now,
          expiresAtMs: now + KICK_BLOCK_MS,
          byUid: state.uid,
          byName: (els.meHint?.textContent || "ìµëª…"),
          targetName: targetName || ""
        }, {merge:true});
        showToast("ğŸš« ê°•í‡´ ì²˜ë¦¬í–ˆì–´");
      }catch(e){
        console.error(e);
        showToast("ê°•í‡´ ì‹¤íŒ¨(ê¶Œí•œ/ë£° í™•ì¸)");
      }
    }

    function subscribeKicks(){
      if(state.unsubKick) state.unsubKick();
      state.unsubKick = null;
      if(!state.roomId || !state.uid) return;

      // ë£°ì— /kicks ë§¤ì¹˜ê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ê¶Œí•œ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´.
      // ê·¸ ê²½ìš°ì—ë„ ì…ì¥/ì±„íŒ… ë“± ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ë™ì‘í•˜ë„ë¡ 'ì•ˆì „'í•˜ê²Œ ë¶™ì¸ë‹¤.
      state.unsubKick = safeOnSnapshot(kickRef(state.roomId, state.uid), (snap)=>{
        if(!snap.exists()) return;
        const k = snap.data() || {};
        const exp = Number(k.expiresAtMs || 0);
        const now = Date.now();
        if(exp && exp < now) return; // ë§Œë£Œ
        const by = k.byName || "ëˆ„êµ°ê°€";
        if(state.joined){
          showToast(`ğŸš« ${by}ë‹˜ì´ ê°•í‡´í–ˆì–´`);
          setTimeout(()=>{ if(state.joined) leaveRoom(); }, 350);
        }
      });
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtHMS(sec){
      sec = Math.max(0, Math.floor(sec || 0));
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }
    function nowTimeStr(withSeconds=true){
      const opt = withSeconds ? { timeZone: "Asia/Seoul", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false }
                              : { timeZone: "Asia/Seoul", hour:"2-digit", minute:"2-digit", hour12:false };
      return new Intl.DateTimeFormat("ko-KR", opt).format(new Date());
    }
    function updateClocks(){
      const tFull = nowTimeStr(true);
      const tShort = nowTimeStr(true);
      if(els.lastSync) els.lastSync.textContent = tFull;
      if(els.nowClockMain) els.nowClockMain.textContent = tShort;
      // âœ… ë‚ ì§œê°€ ë°”ë€Œë©´ ì¶œê·¼ ë²„íŠ¼ ìƒíƒœë„ ê°±ì‹ 
      try{
        const dk = __seoulDateKey();
        if(dk !== __lastCheckinUIKey){
          __lastCheckinUIKey = dk;
          if(els.checkInBtn) __applyCheckInBtnUI(els.checkInBtn);
        }
      }catch(e){}
    }

    
    // -----------------------------
    // âœ… ì˜¤ëŠ˜ì˜ ë¯¸ì…˜(ë¡œì»¬ ì €ì¥ + ìì • ë¦¬ì…‹)
    // -----------------------------
    const MK_MISSION_KEY = "mk_mission_v1";
    function loadMissionLocal(){
      try{
        const raw = localStorage.getItem(MK_MISSION_KEY);
        if(!raw) return { dayKey:"", text:"", done:false, doneAt:"" };
        const obj = JSON.parse(raw);
        return {
          dayKey: (obj.dayKey||"").toString(),
          text: (obj.text||"").toString(),
          done: !!obj.done,
          doneAt: (obj.doneAt||"").toString()
        };
      }catch(e){
        return { dayKey:"", text:"", done:false, doneAt:"" };
      }
    }
    function saveMissionLocal(m){
      try{ localStorage.setItem(MK_MISSION_KEY, JSON.stringify(m||{})); }catch(e){}
    }
    function openMissionModal(){
  try{
    const overlay = document.getElementById("missionModal");
    if(!overlay) return;

    // âœ… a11y: ëª¨ë‹¬ ì—´ê¸° ì „ í¬ì»¤ìŠ¤ ê¸°ì–µ
    state._missionReturnFocus = document.activeElement;

    const dayKey = seoulDateKey();
    const cur = state.myMission || loadMissionLocal();
    if(cur.dayKey !== dayKey){
      state.myMission = { dayKey, text:"", done:false, doneAt:"" };
      saveMissionLocal(state.myMission);
    }else{
      state.myMission = cur;
    }

    const txt = document.getElementById("missionText");
    const chk = document.getElementById("missionDone");
    if(txt) txt.value = (state.myMission?.text||"");
    if(chk) chk.checked = !!state.myMission?.done;

    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    try{ overlay.inert = false; }catch(e){}

    // âœ… ëª¨ë‹¬ ë‚´ë¶€ë¡œ í¬ì»¤ìŠ¤ ì´ë™
    setTimeout(()=>{ try{ (txt || chk || overlay).focus?.(); }catch(e){} }, 0);
  }catch(e){}
}
function closeMissionModal(){
  try{
    const overlay = document.getElementById("missionModal");
    if(!overlay) return;

    // âœ… a11y: aria-hidden í•˜ê¸° ì „ì— í¬ì»¤ìŠ¤ê°€ ëª¨ë‹¬ ì•ˆì— ë‚¨ì•„ìˆìœ¼ë©´ ë¨¼ì € ë¹¼ê¸°
    try{
      const active = document.activeElement;
      if(active && overlay.contains(active)){
        active.blur?.();
      }
    }catch(e){}

    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    try{ overlay.inert = true; }catch(e){}

    // âœ… ì—´ê¸° ì „ í¬ì»¤ìŠ¤ë¡œ ë³µê·€
    try{
      const ret = state._missionReturnFocus;
      if(ret && typeof ret.focus === "function") ret.focus();
    }catch(e){}
    state._missionReturnFocus = null;
  }catch(e){}
}

    function setMissionButtonState(){
      try{
        const btn = document.querySelector(".missionBtn[data-me=\"1\"]");
        if(!btn) return;
        const m = state.myMission || loadMissionLocal();
        btn.classList.remove("isHot","isDone");
        btn.textContent = "";
        if(m.done){
          btn.classList.add("isDone");
          btn.textContent = "ğŸ‘‘";
          btn.title = `ë¯¸ì…˜ ì„±ê³µ! ${m.text||""}`.trim();
          btn.setAttribute("aria-label", `ë¯¸ì…˜ ì„±ê³µ: ${m.text||"ì˜¤ëŠ˜ì˜ ë¯¸ì…˜"}`);
        }else{
          btn.classList.add("isHot");
          btn.title = m.text ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${m.text}` : "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì„¤ì •í•˜ê¸°";
          btn.setAttribute("aria-label", m.text ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${m.text}` : "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì„¤ì •í•˜ê¸°");
        }
      }catch(e){}
    }
    
    // -----------------------------
// âœ… ì˜¤ëŠ˜ì˜ ë¯¸ì…˜(ì›ê²© ë™ê¸°í™”) â€” Firestore Rules ê±´ë“œë¦¬ì§€ ì•Šê³  ë™ê¸°í™”
//    â—/missions ì„œë¸Œì»¬ë ‰ì…˜ì€ ë£°ì— ë§‰í˜€ì„œ(ê¶Œí•œ ì˜¤ë¥˜) ì±„íŒ… ì»¬ë ‰ì…˜ì— 'ë¯¸ì…˜ ì´ë²¤íŠ¸'ë¥¼ ë‚¨ê¸°ëŠ” ë°©ì‹ìœ¼ë¡œ ì „í™˜
//    - rooms/{roomId}/messages ì— type:"mission" ì´ë²¤íŠ¸ë¥¼ ê¸°ë¡
//    - ì„±ê³µ ì¸ì›ì€ ìµœê·¼ Nê°œì˜ ë©”ì‹œì§€ì—ì„œ ì˜¤ëŠ˜(dayKey) ë¯¸ì…˜ ì´ë²¤íŠ¸ë¥¼ ì§‘ê³„(ë‹‰ë„¤ì„ ê¸°ì¤€)
//    - ë¡œê·¸ì•„ì›ƒ/ì¬ì…ì¥í•´ë„ ë©”ì‹œì§€ëŠ” ë‚¨ìœ¼ë‹ˆ ì¹´ìš´íŠ¸ ìœ ì§€
//    - ìì •(KST) ì§€ë‚˜ë©´ dayKeyê°€ ë°”ë€Œì–´ ìë™ ë¦¬ì…‹
// -----------------------------
function renderMissionSuccessCount(n){
  try{
    const el = document.getElementById("missionSuccessCount");
    if(el) el.textContent = String(Number(n||0));
  }catch(e){}
}

function buildMissionEvent(action, m){
  const name = (state.nickname || els.name?.value || "").trim();
  const dayKey = (m?.dayKey) || seoulDateKey();
  return {
    type: "mission",
    action: action || "done",              // "set" | "done" | "undo"
    dayKey,
    name: name || "ìµëª…",
    text: (m?.text || "").trim().slice(0, 60),
    uid: state.uid || null,
    tsMs: Date.now()
  };
}

async function emitMissionEvent(action, m){
  try{
    if(!state.roomId) return;
    const name = (state.nickname || els.name?.value || "").trim();
    if(!name) return;
    // ë©”ì‹œì§€ ì»¬ë ‰ì…˜ì€ ì´ë¯¸ ì±„íŒ…ì—ì„œ ì“°ê³  ìˆìœ¼ë¯€ë¡œ(ë£° í†µê³¼), ì—¬ê¸°ë¡œ ì´ë²¤íŠ¸ë¥¼ ë‚¨ê¸´ë‹¤
    await addDoc(chatCol(state.roomId), buildMissionEvent(action, m));
  }catch(e){
    console.warn("[mission] event write failed", e);
    // ì‚¬ìš©ì UXëŠ” ìœ ì§€ (ë¡œì»¬ì€ ì´ë¯¸ ì €ì¥ë¨)
  }
}

function computeMissionSuccessFromMsgs(msgs, dayKey){
  // ë‹‰ë„¤ì„ë³„ ê°€ì¥ "ê²°ì •ì ì¸" ë¯¸ì…˜ ìƒíƒœ(ì˜¤ëŠ˜ ê¸°ì¤€)
  // - ë™ì¼ tsMsì—ì„œ 'set'ê³¼ 'done'ì´ ì¶©ëŒí•  ë•Œë„ ì•ˆì •ì ìœ¼ë¡œ 'done'ì´ ì´ê¸°ë„ë¡ ìš°ì„ ìˆœìœ„ ì ìš©
  // action: "set" | "done" | "undo"
  const prio = (a)=>{
    if(a==="done") return 3;
    if(a==="undo") return 2;
    return 1; // set or others
  };

  const bestByName = new Map();

  for(let i=0;i<msgs.length;i++){
    const m = msgs[i] || {};
    if(m.type !== "mission") continue;
    if(String(m.dayKey||"") !== String(dayKey)) continue;

    const name = (typeof normalizeNick==="function") ? normalizeNick(m.name||"") : String(m.name||"").trim();
    if(!name) continue;

    const action = String(m.action||"set");
    const tsMs = Number(m.tsMs||0);
    const text = String(m.text||"").trim();

    const prev = bestByName.get(name);
    if(!prev){
      bestByName.set(name, { action, text, tsMs });
      continue;
    }

    // ë” ìµœì‹  tsMsê°€ ì´ê¹€. tsMsê°€ ê°™ìœ¼ë©´ action ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ìª½ì´ ì´ê¹€.
    if(tsMs > prev.tsMs || (tsMs === prev.tsMs && prio(action) > prio(prev.action))){
      bestByName.set(name, { action, text, tsMs });
    }
  }

  let doneCount = 0;
  for(const v of bestByName.values()){
    if(v && v.action === "done") doneCount++;
  }
  return { doneCount, lastByName: bestByName };
}


function subscribeMissionFeed(){
  try{
    if(state.unsubMissionFeed) state.unsubMissionFeed();
    state.unsubMissionFeed = null;

    const dayKey = seoulDateKey();
    state.missionDayKey = dayKey;
    if(!state.roomId) return;

    // âœ… whereë¥¼ ê±¸ì§€ ì•Šê³ (ì¸ë±ìŠ¤/ë£° ì´ìŠˆ ìµœì†Œí™”) ìµœê·¼ 600ê°œì—ì„œ ì§‘ê³„
    const q = query(chatCol(state.roomId), orderBy("tsMs","desc"), limit(600));
    state.unsubMissionFeed = safeOnSnapshot(q, (qs)=>{
      const items = [];
      qs.forEach(d=>items.push(d.data()));
      // itemsëŠ” tsMs desc
      const prevLastByName = state.missionLastByName;
      const { doneCount, lastByName } = computeMissionSuccessFromMsgs(items, dayKey);
      state.missionLastByName = lastByName;
      state.missionSuccessCount = doneCount;
      renderMissionSuccessCount(doneCount);
      refreshAllMissionButtons();
      refreshAllMissionMedals();

      // âœ… ëˆ„êµ°ê°€ 'ë¯¸ì…˜ ì„±ê³µ'ìœ¼ë¡œ ë°”ë€ ìˆœê°„ì—ë§Œ í­ì£½(ì‹¤ì‹œê°„, 1íšŒ)
      try{
        const prevMap = (prevLastByName && (prevLastByName instanceof Map)) ? prevLastByName : new Map();
        for(const [n, info] of lastByName.entries()){
          if(info && info.action==="done"){
            const prev = prevMap.get(n);
            if(!prev || prev.action!=="done"){
              const tileEl = findTileElByName(n);
              if(tileEl) fxFireworksAt(tileEl);
            }
          }
        }
      }catch(e){}

      // ë‚´ ë¯¸ì…˜ ìƒíƒœë„ ì›ê²© ì´ë²¤íŠ¸ì—ì„œ ë³´ì •(ë‹‰ë„¤ì„ ê¸°ì¤€)
      try{
        const myName = (state.nickname || els.name?.value || "").trim();
        if(myName){
          for(const m of items){
          if(!(m && m.type==="mission")) continue;
            if(m?.type==="mission" && String(m.dayKey||"")===String(dayKey) && ( (typeof normalizeNick==="function") ? normalizeNick(m.name||"") : String(m.name||"").trim() ) === ( (typeof normalizeNick==="function") ? normalizeNick(myName) : myName )){
              const cur = state.myMission || loadMissionLocal();
              const merged = {
                dayKey,
                text: (cur.text || m.text || "").slice(0,60),
                done: (String(m.action||"done")==="done"),
                doneAt: (cur.doneAt || (m.tsMs ? new Date(m.tsMs).toISOString() : ""))
              };
              state.myMission = merged;
              saveMissionLocal(merged);
              setMissionButtonState();
              break;
            }
          }
        }
      }catch(e){}
    });
  }catch(e){}
}

function scheduleMissionDayWatcher(){
  try{
    if(state._missionDayTimer) clearTimeout(state._missionDayTimer);

    // ì„œìš¸ ìì •(+3ì´ˆ)ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
    const now = new Date();
    const seoulNow = new Date(now.toLocaleString("en-US", { timeZone:"Asia/Seoul" }));
    const next = new Date(seoulNow);
    next.setHours(24, 0, 3, 0);
    const ms = next.getTime() - seoulNow.getTime();

    state._missionDayTimer = setTimeout(()=>{
      const dayKey = seoulDateKey();
      state.myMission = { dayKey, text:"", done:false, doneAt:"" };
      saveMissionLocal(state.myMission);
      try{ setMissionButtonState(); }catch(e){}
      // âœ… ìƒˆ dayKeyë¡œ ì¬êµ¬ë… â†’ ì¹´ìš´íŠ¸ ìë™ ë¦¬ì…‹
      subscribeMissionFeed();
      scheduleMissionDayWatcher();
    }, Math.max(2000, ms));
  }catch(e){}
}


function fxFireworksAt(el){
      try{
        const layer = document.getElementById("fxLayer");
        if(!layer || !el) return;
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width/2;
        const cy = r.top + r.height/2;
        const pops = 18;
        for(let i=0;i<pops;i++){
          const p = document.createElement("div");
          p.className = "fxPop";
          const ang = (Math.PI*2) * (i/pops);
          const dist = 24 + Math.random()*22;
          const dx = Math.cos(ang)*dist;
          const dy = Math.sin(ang)*dist;
          p.style.left = cx + "px";
          p.style.top = cy + "px";
          p.style.setProperty("--dx", dx + "px");
          p.style.setProperty("--dy", dy + "px");
          layer.appendChild(p);
          setTimeout(()=>{ try{ p.remove(); }catch(e){} }, 900);
        }
      }catch(e){}
    }

    // -----------------------------
    // âœ… ëŒ€ì‹œë³´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸°
    // -----------------------------
    const MK_DASH_FOLD_KEY = "mk_dash_fold_v1";
    function loadDashFold(){ try{ return localStorage.getItem(MK_DASH_FOLD_KEY)==="1"; }catch(e){ return false; } }
    function saveDashFold(v){ try{ localStorage.setItem(MK_DASH_FOLD_KEY, v?"1":"0"); }catch(e){} }
function seoulDateKey(){
      const parts = new Intl.DateTimeFormat("sv-SE", {
        timeZone: "Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(new Date()).reduce((a,p)=> (a[p.type]=p.value, a), {});
      return `${parts.year}-${parts.month}-${parts.day}`;
    }
    const ONLINE_TTL_MS = 5 * 60 * 1000; // 5ë¶„: ë°±ê·¸ë¼ìš´ë“œ íƒ­/íƒ€ì´ë¨¸ ì“°ë¡œí‹€ë§ ëŒ€ë¹„
    function isOnline(lastSeenAtMs){
      if(!lastSeenAtMs) return false;
      return (Date.now() - lastSeenAtMs) < ONLINE_TTL_MS;
    }
    function openUrl(url){
      if(!url){ showToast("ì„¤ì •ëœ ë§í¬ê°€ ì—†ì–´! (â˜°ì—ì„œ ì €ì¥)"); return; }
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // -----------------------------
    // ëŒ€ì‹œë³´ë“œ ì‹¤ì‹œê°„ ì¸ì›(ì•±ìŠ¤í¬ë¦½íŠ¸) JSONP í´ë§
    // - CORS íšŒí”¼ìš©: Apps Script doGetì—ì„œ callback ì§€ì›ì´ í•„ìš”í•´ìš”.
    // -----------------------------
    function loadJsonp(url, cb){
      try{
        const cbName = "__mk_cb_" + Math.random().toString(36).slice(2);
        window[cbName] = (data)=>{
          try{ cb(null, data); } finally {
            delete window[cbName];
          }
        };
        const hasQ = url.includes("?");
        const withCb = url + (hasQ ? "&" : "?") + "callback=" + cbName + "&_=" + Date.now();
        const sc = document.createElement("script");
        sc.src = withCb;
        sc.async = true;
        sc.onerror = ()=>{ try{ cb(new Error("jsonp error")); } finally { delete window[cbName]; } };
        document.head.appendChild(sc);
        // cleanup later
        setTimeout(()=>{ if(sc.parentNode) sc.parentNode.removeChild(sc); }, 15_000);
      }catch(err){ cb(err); }
    }

    
    async function loadJsonAny(url, cb){
      // 1) try CORS JSON fetch (works with script.googleusercontent.com/macros/echo... í˜•íƒœë„ ê°€ëŠ¥)
      try{
        const u = new URL(url, location.href);
        u.searchParams.set("_", String(Date.now()));
        const res = await fetch(u.toString(), { cache:"no-store", credentials:"omit", mode:"cors" });
        if(res && res.ok){
          const ct = (res.headers.get("content-type") || "").toLowerCase();
          const txt = await res.text();
          // JSON only
          try{
            const data = JSON.parse(txt);
            cb(null, data);
            return;
          }catch(e){
            // not JSON â†’ fallthrough to JSONP
          }
        }
      }catch(e){
        // fetch blocked â†’ fallthrough to JSONP
      }
      // 2) fallback JSONP (requires callback ì§€ì›)
      loadJsonp(url, cb);
    }
function ensureDashPolling(){
      const url = (state.roomSettings.dashboard && state.roomSettings.dashboard.dashApiUrl) ? state.roomSettings.dashboard.dashApiUrl.trim() : "";
      if(!url){
        if(state.dashPollTimer){ clearInterval(state.dashPollTimer); state.dashPollTimer=null; }
        state.dashPollUrl = "";
        state.localDashCounts = {pomoCount:null, sudaCount:null, updatedAtMs:null};
        return;
      }
      if(state.dashPollUrl === url && state.dashPollTimer) return;
      state.dashPollUrl = url;
      if(state.dashPollTimer) clearInterval(state.dashPollTimer);

      const tick = ()=>{
        loadJsonAny(url, (err, data)=>{
          if(err) return;
          if(!data || typeof data !== "object") return;
          const pomo = (data.pomo != null) ? data.pomo : (data.pomoCount != null ? data.pomoCount : null);
          const suda = (data.suda != null) ? data.suda : (data.sudaCount != null ? data.sudaCount : null);
          const upd  = data.updatedAtMs || Date.now();
          state.localDashCounts = {pomoCount: pomo, sudaCount: suda, updatedAtMs: upd};
          renderDashboard();
        });
      };
      tick();
      state.dashPollTimer = setInterval(tick, 10_000);
    }

    // ---------- Embeds (optional) ----------
    function openInlineEmbed(title, url){
      openUrl(url);
    }
    function closeInlineEmbed(){
      els.embedBar.style.display = "none";
      els.embedFrame.style.display = "none";
      els.embedFrame.src = "about:blank";
      els.chatList.style.display = "block";
      const row = els.chatInput.closest(".chatInputRow");
      if(row) row.style.display = "";
    }
    function openEmbedModal(title, url){
      openUrl(url);
    }
    function closeEmbedModal(){
      hideModal(els.embedModal);
      els.embedModalFrame.src = "about:blank";
    }

    
    // -----------------------------
    // Dashboard docking: stick dashboard card right under the settings (â˜°) button
    // - On wide screens: dashboard becomes fixed and follows the button's position
    // - On small screens: dashboard returns to normal flow (so it doesn't cover the UI)
    // -----------------------------
    
    function ensureChatLayout(){
      try{
        const card = document.getElementById("chatCard");
        if(!card) return;
        // ê°•ì œë¡œ 'ì±„íŒ… ë¦¬ìŠ¤íŠ¸ + ì…ë ¥' ë ˆì´ì•„ì›ƒ ìœ ì§€ (ì ‘ê¸°/ë„í‚¹ì— ì˜í•´ ë¬´ë„ˆì§€ëŠ” ê²ƒ ë°©ì§€)
        const body = card.querySelector(".body.chatBody");
        const list = document.getElementById("chatList");
        const row  = card.querySelector(".chatInputRow");
        if(body){
          body.style.display = "flex";
          body.style.flexDirection = "column";
          body.style.flex = "1 1 auto";
          body.style.minHeight = "0";
          body.style.overflow = "hidden";
        }
        if(list){
          list.style.flex = "1 1 auto";
          list.style.minHeight = "0";
          list.style.overflow = "auto";
        }
        if(row){
          row.style.display = "flex";
          row.style.flex = "0 0 auto";
        }
      }catch(e){}
    }

function dockRightRail(){
      const dash = els.dashboardCard || document.getElementById("dashboardCard");
      const chat = els.chatCard || document.getElementById("chatCard");
      const anchor = els.menuBtn;
      if(!dash || !anchor) return;

      const wide = window.innerWidth > 980;

      const reset = (el, cls)=>{
        if(!el) return;
        el.classList.remove(cls);
        el.style.position = "";
        el.style.top = "";
        el.style.right = "";
        el.style.left = "";
        el.style.width = "";
        el.style.maxHeight = "";
        el.style.height = "";
        el.style.overflow = "";
      };

      if(!wide){
        reset(dash, "docked");
        reset(chat, "dockedChat");
        return;
      }

      const r = anchor.getBoundingClientRect();
      const right = Math.max(10, window.innerWidth - r.right);
      const top = Math.max(12, r.bottom + 18);     // âœ… ìƒë‹¨ë°”â†”ëŒ€ì‹œë³´ë“œ ì—¬ë°±
      const gap = 12;                               // âœ… ëŒ€ì‹œë³´ë“œâ†”ì±„íŒ… ì—¬ë°±

      dash.classList.add("docked");
      dash.style.top = top + "px";
      dash.style.right = right + "px";
      dash.style.maxHeight = `calc(100vh - ${top + 18}px)`;
      dash.style.overflow = "auto";

      if(chat){
        // chat should sit right under dashboard, same width, and stretch down.
        const dr = dash.getBoundingClientRect();
        const chatTop = Math.max(dr.bottom + gap, top + 56);
        const bottomPad = 14;

        chat.classList.add("dockedChat");
        ensureChatLayout();
        chat.style.position = "fixed";
        chat.style.right = right + "px";
        chat.style.top = chatTop + "px";
        chat.style.width = dr.width + "px";
        chat.style.height = `calc(100vh - ${chatTop + bottomPad}px)`;
        chat.style.maxHeight = `calc(100vh - ${chatTop + bottomPad}px)`;
        chat.style.overflow = "hidden";
      }
    }



    function setControlsEnabled(joined){
      els.leaveBtn.disabled = !joined;
      els.joinBtn.disabled = joined;
      els.name.disabled = joined;
      els.menuBtn.disabled = !joined;

      // hide/show nickname & pass area on join
      els.name.style.display = joined ? "none" : "";
      if(els.roomPass) els.roomPass.style.display = (joined || document.body.classList.contains("passok")) ? "none" : "";
      els.joinBtn.style.display = joined ? "none" : "";
      els.leaveBtn.style.display = joined ? "" : "";
      els.meHint.style.display = joined ? "" : "";

      els.btnWork.disabled = !joined;
      els.btnBreak.disabled = !joined;
      els.btnIdle.disabled = !joined;
      if(els.checkInBtn) els.checkInBtn.disabled = !joined;
      els.statusBtn.disabled = !joined;
      // í”„ë¡œí•„ì€ ì…ì¥ ì „ì—ë„ ê¾¸ë°€ ìˆ˜ ìˆê²Œ í•­ìƒ í™œì„±
      els.profileBtn.disabled = false;
      if(els.onlineBtn) els.onlineBtn.disabled = !joined;

      els.chatInput.disabled = !joined;
      els.sendBtn.disabled = !joined;

      // lamp
      document.body.classList.toggle("joined", joined);
      state.joined = joined;
      // keep dashboard positioned under â˜°
      dockRightRail();
    }
    
    function syncMyStatusUI(){
      const me = state.currentParticipants.get(state.uid);
      const st = (me && me.status) ? me.status : "idle";
      const label = (st==="work") ? "âœï¸ ì‘ì—…ì¤‘" : (st==="break") ? "â˜• íœ´ì‹ì¤‘" : "ğŸŒ™ ìë¦¬ë¹„ì›€";
      if(els.statusBtn) els.statusBtn.textContent = `${label} â–¾`;
      if(els.btnWork) els.btnWork.className = (st==="work") ? "primary" : "ghost";
      if(els.btnBreak) els.btnBreak.className = (st==="break") ? "primary" : "ghost";
      if(els.btnIdle) els.btnIdle.className = (st==="idle") ? "primary" : "ghost";
    }

function showModal(el){ el.classList.add("show"); }
    function hideModal(el){ el.classList.remove("show"); }

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const hashBuf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(hashBuf));
      return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    function clampNum(v, min, max, def){
      const n = Number(v);
      if(!Number.isFinite(n)) return def;
      return Math.min(max, Math.max(min, n));
    }

    function clampHexColor(s){
      s = (s||"").trim();
      if(!s) return "#ffd0e2";
      if(/^#[0-9a-fA-F]{6}$/.test(s)) return s;
      if(/^#[0-9a-fA-F]{3}$/.test(s)){
        return "#" + s.slice(1).split("").map(c=>c+c).join("");
      }
      return "#ffd0e2";
    }

    function hexToRgba(hex, a){
      const c = clampHexColor(hex);
      const r = parseInt(c.slice(1,3),16);
      const g = parseInt(c.slice(3,5),16);
      const b = parseInt(c.slice(5,7),16);
      const alpha = (a===undefined || a===null) ? 1 : Math.max(0, Math.min(1, Number(a)));
      return `rgba(${r},${g},${b},${alpha})`;
    }

    const DEFAULT_SWATCHES = [
      "#ffffff",
      "#dedede",
      "#b3b3b3",
      "#666666",
      "#262626",
      "#000000",
      "#ffd0e2",
      "#fe9dc0",
      "#ff5b98",
      "#ff005e",
      "#ffcdfe",
      "#fd92fa",
      "#ff41f9",
      "#fe00f6",
      "#e2c6ff",
      "#c185ff",
      "#9e42ff",
      "#7b00ff",
      "#d2e3ff",
      "#96bdff",
      "#4a90ff",
      "#0060ff",
      "#c8f7ff",
      "#87ecff",
      "#46e1ff",
      "#01d6fe",
      "#c6fff8",
      "#8ffff1",
      "#4bfee8",
      "#00ffdf",
      "#ccffc6",
      "#9eff94",
      "#63ff54",
      "#15ff00",
      "#f5ffcb",
      "#ebff9e",
      "#ddff51",
      "#cbff00",
      "#feffd3",
      "#fbfa9d",
      "#feff75",
      "#ffff00",
      "#fff1dc",
      "#fddeaf",
      "#ffc162",
      "#ff9a00",
      "#ffe5d8",
      "#fdc19f",
      "#fa8649",
      "#ff5800",
      "#ffc9c9",
      "#fe9c9b",
      "#fb5352",
      "#fe0000",
      "#fff8e8",
      "#fff1d6",
      "#ffe5b4",
      "#e2c490",
      "#efc2ab",
      "#d49b7e",
      "#a46b4e",
      "#835136"
    ];

    function setBgColorAll(hex){
      const c = clampHexColor(hex);
      if(els.bgColor) els.bgColor.value = c;
      if(els.bgPicker) els.bgPicker.value = c;
      // active swatch highlight
      if(els.swatches){
        [...els.swatches.querySelectorAll(".swatch")].forEach(s=>{
          s.classList.toggle("active", s.dataset.hex.toLowerCase() === c.toLowerCase());
        });
      }
    }

    function initPalette(){
      if(!els.swatches || !els.bgPicker || !els.bgColor) return;

      // render swatches once
      if(!els.swatches.dataset.ready){
        els.swatches.innerHTML = "";
        for(const hex of DEFAULT_SWATCHES){
          const b = document.createElement("button");
          b.type = "button";
          b.className = "swatch";
          b.style.background = hex;
          b.dataset.hex = hex;
          b.title = hex;
          b.addEventListener("click", ()=>setBgColorAll(hex));
          els.swatches.appendChild(b);
        }
        els.swatches.dataset.ready = "1";
      }
      function setEmojiBgAll(hex){
        const c = clampHexColor(hex || "#2b2b2b");
        if(els.emojiBgColor) els.emojiBgColor.value = c;
        if(els.emojiBgPicker) els.emojiBgPicker.value = c;
      }
      function setBubbleColorAll(hex){
        const fallback = (els.bgColor && els.bgColor.value) ? els.bgColor.value : "#ffd0e2";
        const c = clampHexColor(hex || fallback);
        if(els.bubbleColor) els.bubbleColor.value = c;
        if(els.bubblePicker) els.bubblePicker.value = c;
      }


      function setTimeColorAll(hex){
        const c = clampHexColor(hex || "#ffffff");
        if(els.timeColor) els.timeColor.value = c;
        if(els.timePicker) els.timePicker.value = c;
      }


      // sync: picker -> code
      els.bgPicker.addEventListener("input", ()=>setBgColorAll(els.bgPicker.value));
      // sync: code -> picker (on blur + enter)
      els.bgColor.addEventListener("change", ()=>setBgColorAll(els.bgColor.value));
      els.bgColor.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){ e.preventDefault(); setBgColorAll(els.bgColor.value); }
      });

      // initial
      setBgColorAll(els.bgColor.value || els.bgPicker.value || "#ffd0e2");
      // emoji bg color controls
      if(els.emojiBgPicker && els.emojiBgColor){
        els.emojiBgPicker.addEventListener("input", ()=>setEmojiBgAll(els.emojiBgPicker.value));
        els.emojiBgColor.addEventListener("change", ()=>setEmojiBgAll(els.emojiBgColor.value));
        els.emojiBgColor.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); setEmojiBgAll(els.emojiBgColor.value); }
        });
        setEmojiBgAll(els.emojiBgColor.value || els.emojiBgPicker.value || "#2b2b2b");
      }

      // bubble color controls
      if(els.bubblePicker && els.bubbleColor){
        els.bubblePicker.addEventListener("input", ()=>setBubbleColorAll(els.bubblePicker.value));
        els.bubbleColor.addEventListener("change", ()=>setBubbleColorAll(els.bubbleColor.value));
        els.bubbleColor.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); setBubbleColorAll(els.bubbleColor.value); }
        });
        setBubbleColorAll(els.bubbleColor.value || els.bubblePicker.value || (els.bgColor ? els.bgColor.value : "#ffd0e2"));
      }

      // time color controls (work time only)
      if(els.timePicker && els.timeColor){
        els.timePicker.addEventListener("input", ()=>setTimeColorAll(els.timePicker.value));
        els.timeColor.addEventListener("change", ()=>setTimeColorAll(els.timeColor.value));
        els.timeColor.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); setTimeColorAll(els.timeColor.value); }
        });
        
// pattern color controls
function setPatternColorAll(v){
  if(!els.patternPicker || !els.patternColor) return;
  const hex = clampHexColor(v || "#ffffff");
  els.patternPicker.value = hex;
  els.patternColor.value = hex;
}

    
    function normalizeHexInput(v){
      try{
        let s = (v || "").toString().trim();
        if(!s) return "";
        if(!s.startsWith("#")) s = "#" + s;
        // allow shorthand
        if(/^#([0-9a-fA-F]{3})$/.test(s)){
          const a = s[1], b = s[2], c = s[3];
          s = "#" + a+a + b+b + c+c;
        }
        if(/^#([0-9a-fA-F]{6})$/.test(s)) return s.toLowerCase();
        return "";
      }catch(e){ return ""; }
    }
    function attachColorSync(textEl, pickerEl){
      if(!textEl || !pickerEl) return;
      const sync = ()=>{
        const norm = normalizeHexInput(textEl.value) || clampHexColor(textEl.value);
        if(norm){
          textEl.value = norm;
          pickerEl.value = norm;
        }
      };
      textEl.addEventListener("change", sync);
      textEl.addEventListener("blur", sync);
      textEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ sync(); textEl.blur(); }});
      pickerEl.addEventListener("input", ()=>{
        textEl.value = pickerEl.value;
      });
    }
// âœ… ì´ëª¨ì§€ 1ê°œë§Œ í—ˆìš© (grapheme ê¸°ì¤€)
    function firstEmojiGrapheme(str){
      try{
        const s = (str || "").toString().trim();
        if(!s) return "";
        if(typeof Intl !== "undefined" && Intl.Segmenter){
          const seg = new Intl.Segmenter("en", { granularity: "grapheme" });
          for(const it of seg.segment(s)){
            return it.segment;
          }
          return "";
        }
        // fallback: ì²« codepoint
        const cp = Array.from(s);
        return cp[0] || "";
      }catch(e){
        return "";
      }
    }
    try{ window.firstEmojiGrapheme = firstEmojiGrapheme; }catch(e){}


    // âœ… ì§‘ì¤‘ì‹œê°„(24ì‹œê°„ ëˆ„ì , ìì • ë¦¬ì…‹) â€” ì „ì—­ ìœ í‹¸
    function loadFocusSeconds(){
      const today = seoulDateKey();
      // âœ… ë¯¸ì…˜ ë¡œì»¬ ë¡œë“œ + ë‚ ì§œ ë¶ˆì¼ì¹˜ë©´ ì´ˆê¸°í™”
      try{
        const m0 = loadMissionLocal();
        if(m0.dayKey !== today){
          state.myMission = { dayKey: today, text:"", done:false, doneAt:"" };
          saveMissionLocal(state.myMission);
        }else{
          state.myMission = m0;
        }
      }catch(e){ state.myMission = { dayKey: today, text:"", done:false, doneAt:"" }; }

      try{
        const day = localStorage.getItem(LS_FOCUS_DAY) || "";
        const sec = Number(localStorage.getItem(LS_FOCUS_SEC) || 0);
        if(day !== today){
          localStorage.setItem(LS_FOCUS_DAY, today);
          localStorage.setItem(LS_FOCUS_SEC, "0");
          return 0;
        }
        return isFinite(sec) ? Math.max(0, sec) : 0;
      }catch(e){
        return 0;
      }
    }
    function saveFocusSeconds(sec){
      const today = seoulDateKey();
      try{
        localStorage.setItem(LS_FOCUS_DAY, today);
        localStorage.setItem(LS_FOCUS_SEC, String(Math.max(0, Math.floor(Number(sec)||0))));
      }catch(e){}
    }
    function persistMyFocusToLocal(){
      try{
        const me = state.currentParticipants.get(state.uid);
        if(!me) return;
        const totalNow = computeDisplayedTotal(me); // seconds
        focusSaveSeconds(totalNow);
      }catch(e){}
    }


    // (dedup) focus helpers already declared above

if(els.patternPicker && els.patternColor){
  els.patternPicker.addEventListener("input", ()=>setPatternColorAll(els.patternPicker.value));
  els.patternColor.addEventListener("change", ()=>setPatternColorAll(els.patternColor.value));
  els.patternColor.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); setPatternColorAll(els.patternColor.value); }
  });
  setPatternColorAll(els.patternColor.value || els.patternPicker.value || "#ffffff");
}

setTimeColorAll(els.timeColor.value || els.timePicker.value || "#ffffff");
      }

      // size controls (emoji/photo)
      function setEmojiSizeAll(v){
        if(!els.emojiSize || !els.emojiSizeNum) return;
        const n = clampNum(v, 26, 100, 40);
        els.emojiSize.value = String(n);
        els.emojiSizeNum.value = String(n);
      }
      function setPhotoSizeAll(v){
        if(!els.photoSize || !els.photoSizeNum) return;
        const n = clampNum(v, 52, 100, 68);
        els.photoSize.value = String(n);
        els.photoSizeNum.value = String(n);
      }
      if(els.emojiSize && els.emojiSizeNum){
        els.emojiSize.addEventListener("input", ()=>setEmojiSizeAll(els.emojiSize.value));
        els.emojiSizeNum.addEventListener("change", ()=>setEmojiSizeAll(els.emojiSizeNum.value));
        els.emojiSizeNum.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); setEmojiSizeAll(els.emojiSizeNum.value); }
        });
        setEmojiSizeAll(els.emojiSize.value || els.emojiSizeNum.value || 54);
      }
      if(els.photoSize && els.photoSizeNum){
        els.photoSize.addEventListener("input", ()=>setPhotoSizeAll(els.photoSize.value));
        els.photoSizeNum.addEventListener("change", ()=>setPhotoSizeAll(els.photoSizeNum.value));
        els.photoSizeNum.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); setPhotoSizeAll(els.photoSizeNum.value); }
        });
        setPhotoSizeAll(els.photoSize.value || els.photoSizeNum.value || 68);
      }


    }

    function bgStyle(color, pattern, patColor){
      const c = clampHexColor(color);
      const p = (pattern || "none").trim();

      const pc = clampHexColor(patColor || "#ffffff");
      const pc32 = hexToRgba(pc, 0.32);
      const pc30 = hexToRgba(pc, 0.30);
      const pc28 = hexToRgba(pc, 0.28);
      const pc26 = hexToRgba(pc, 0.26);
      const pc24 = hexToRgba(pc, 0.24);
      const pc22 = hexToRgba(pc, 0.22);
      const pc20 = hexToRgba(pc, 0.20);
      const pc18 = hexToRgba(pc, 0.18);
      const pc16 = hexToRgba(pc, 0.16);
      const pc14 = hexToRgba(pc, 0.14);
      const pc12 = hexToRgba(pc, 0.12);
      const pc10 = hexToRgba(pc, 0.10);
      const pc08 = hexToRgba(pc, 0.08);


      // pattern layers (top-most first)
      const layers = [];

      const base = `linear-gradient(0deg, ${c}, ${c})`;

      if(p === "dots"){
        layers.push(`radial-gradient(circle at 9px 9px, ${pc32} 2px, transparent 2.4px)`);
        layers.push(`radial-gradient(circle at 19px 19px, ${pc22} 2px, transparent 2.4px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "microdots"){
        layers.push(`radial-gradient(circle at 6px 6px, ${pc28} 1.2px, transparent 1.6px)`);
        layers.push(`radial-gradient(circle at 14px 14px, ${pc18} 1.2px, transparent 1.6px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "grid"){
        layers.push(`linear-gradient(${pc18} 1px, transparent 1px)`);
        layers.push(`linear-gradient(90deg, ${pc18} 1px, transparent 1px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "papergrid"){
        layers.push(`linear-gradient(${pc08} 1px, transparent 1px)`);
        layers.push(`linear-gradient(90deg, ${pc08} 1px, transparent 1px)`);
layers.push(base);
        return layers.join(", ");
      }
      if(p === "stripes"){
        layers.push(`repeating-linear-gradient(45deg, ${pc22} 0 10px, transparent 10px 20px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "diagonal"){
        layers.push(`repeating-linear-gradient(135deg, ${pc22} 0 8px, transparent 8px 18px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "checker"){
        layers.push(`linear-gradient(45deg, ${pc18} 25%, transparent 25% 75%, ${pc18} 75%)`);
        layers.push(`linear-gradient(45deg, ${pc10} 25%, transparent 25% 75%, ${pc10} 75%)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "waves"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="40" viewBox="0 0 80 40">
          <path d="M0 20c10-10 20-10 30 0s20 10 30 0 20-10 30 0" fill="none" stroke="${pc22}" stroke-width="3" stroke-linecap="round"/>
          <path d="M0 32c10-10 20-10 30 0s20 10 30 0 20-10 30 0" fill="none" stroke="${pc14}" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "sparkles"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
          <g fill="${pc26}">
            <path d="M30 10l2.3 6.7L39 19l-6.7 2.3L30 28l-2.3-6.7L21 19l6.7-2.3z"/>
            <circle cx="12" cy="14" r="1.6" fill="${pc22}"/>
            <circle cx="48" cy="40" r="1.9" fill="${pc18}"/>
            <circle cx="18" cy="46" r="1.3" fill="${pc18}"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "confetti"){
        layers.push(`radial-gradient(circle at 12px 10px, ${pc30} 2px, transparent 2.4px)`);
        layers.push(`radial-gradient(circle at 26px 24px, ${pc20} 2px, transparent 2.4px)`);
        layers.push(`radial-gradient(circle at 44px 14px, ${pc08} 2px, transparent 2.4px)`);
        layers.push(`repeating-linear-gradient(0deg, ${pc10} 0 1px, transparent 1px 16px)`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "stars"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
          <g fill="${pc24}">
            <path d="M12 14l1.7 4.8L18 20l-4.3 1.2L12 26l-1.7-4.8L6 20l4.3-1.2z"/>
            <path d="M44 10l2 5.6L51 17l-5 1.4L44 24l-2-5.6L37 17l5-1.4z" fill="${pc18}"/>
            <path d="M50 44l1.8 5.2L56 51l-4.2 1.2L50 58l-1.8-5.2L44 51l4.2-1.2z"/>
            <circle cx="26" cy="46" r="1.5" fill="${pc18}"/>
            <circle cx="18" cy="34" r="1.2" fill="${pc16}"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      if(p === "moon"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 72 72">
          <g>
            <path d="M46 12c-6.5 2.6-11 9-11 16.5 0 10 8 18 18 18 2.4 0 4.7-.5 6.8-1.3C57.8 54.3 49 60.5 38.8 60.5 24.8 60.5 13.5 49.2 13.5 35.2 13.5 22.7 22.3 12.1 33.9 9.4c4.1-1 8.3-.7 12.1 2.6z"
              fill="${pc22}"/>
            <circle cx="18" cy="18" r="1.3" fill="${pc16}"/>
            <circle cx="24" cy="12" r="1.0" fill="${pc12}"/>
            <circle cx="14" cy="30" r="1.1" fill="${pc14}"/>
            <circle cx="56" cy="18" r="1.2" fill="${pc12}"/>
            <circle cx="60" cy="30" r="1.0" fill="${pc10}"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      if(p === "flowers"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 72 72">
          <g fill="none" stroke="none">
            <g transform="translate(10 10)">
              <g>
                <path d="M10 12c2-3 6-3 8 0 3-2 7 0 6 4 3 2 2 6-2 7 0 4-4 6-7 4-3 2-7 0-7-4-4-1-5-5-2-7-1-4 3-6 6-4z" fill="${pc18}"/>
                <circle cx="14" cy="18" r="3" fill="${pc30}"/>
              </g>
            </g>
            <g transform="translate(38 30) scale(0.9)">
              <path d="M10 12c2-3 6-3 8 0 3-2 7 0 6 4 3 2 2 6-2 7 0 4-4 6-7 4-3 2-7 0-7-4-4-1-5-5-2-7-1-4 3-6 6-4z" fill="${pc14}"/>
              <circle cx="14" cy="18" r="3" fill="${pc26}"/>
            </g>
            <g transform="translate(30 6) scale(0.7)">
              <path d="M10 12c2-3 6-3 8 0 3-2 7 0 6 4 3 2 2 6-2 7 0 4-4 6-7 4-3 2-7 0-7-4-4-1-5-5-2-7-1-4 3-6 6-4z" fill="${pc12}"/>
              <circle cx="14" cy="18" r="3" fill="${pc22}"/>
            </g>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      if(p === "clouds"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="96" height="64" viewBox="0 0 96 64">
          <g fill="${pc18}">
            <path d="M30 42c-7 0-12-5-12-11 0-5 3-9 8-10 2-8 9-14 18-14 9 0 17 6 19 15 6 1 11 6 11 12 0 7-6 13-13 13H30z" opacity="0.9"/>
            <path d="M10 54c-5 0-9-4-9-8 0-4 2-7 6-8 1-6 7-10 13-10 7 0 13 5 14 12 5 1 8 4 8 9 0 5-4 9-9 9H10z" opacity="0.65"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      if(p === "catpaws"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
          <g fill="${pc22}">
            <circle cx="18" cy="20" r="4"/>
            <circle cx="28" cy="16" r="4"/>
            <circle cx="38" cy="16" r="4"/>
            <circle cx="48" cy="20" r="4"/>
            <path d="M32 30c-7 0-12 6-12 12 0 6 5 10 12 10s12-4 12-10c0-6-5-12-12-12z" fill="${pc18}"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      if(p === "dogpaws"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
          <g fill="${pc22}">
            <ellipse cx="18" cy="18" rx="4.2" ry="5.0"/>
            <ellipse cx="28" cy="14" rx="4.2" ry="5.0"/>
            <ellipse cx="36" cy="14" rx="4.2" ry="5.0"/>
            <ellipse cx="46" cy="18" rx="4.2" ry="5.0"/>
            <path d="M32 28c-8 0-14 7-14 14 0 7 6 12 14 12s14-5 14-12c0-7-6-14-14-14z" fill="${pc16}"/>
          </g>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }
      if(p === "hearts"){
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">
          <path d="M18 30s-9-5.6-12.3-10.7C3 14.6 5.4 10 10 10c2.2 0 4.1 1.1 5.2 2.7C16.2 11.1 18.1 10 20.3 10 24.9 10 27.3 14.6 30.3 19.3 27 24.4 18 30 18 30z"
            fill="rgba(255,255,255,0.28)"/>
        </svg>`;
        layers.push(`url("data:image/svg+xml,${encodeURIComponent(svg)}")`);
        layers.push(base);
        return layers.join(", ");
      }

      // none
      return base;
    }



    // Firestore paths
    function roomRef(roomId){ return doc(db, "rooms", roomId); }
    function meRef(roomId, uid){ return doc(db, "rooms", roomId, "participants", uid); }
    function participantsCol(roomId){ return collection(db, "rooms", roomId, "participants"); }
    function chatCol(roomId){ return collection(db, "rooms", roomId, "messages"); }
    function kicksCol(roomId){ return collection(db, "rooms", roomId, "kicks"); }
    function kickRef(roomId, uid){ return doc(db, "rooms", roomId, "kicks", uid); }

    async function ensureRoom(roomId){
      const r = roomRef(roomId);
      const snap = await getDoc(r);
      if(!snap.exists()){
        await setDoc(r, {
          createdAt: serverTimestamp(),
          title: roomId,
          adminHash: null,
          dashboard: { pomoUrl:"", sudaUrl:"", choolUrl:"", sheetUrl:"", dashApiUrl: DEFAULT_DASH_API_URL },
          dashCounts: { pomoCount:null, sudaCount:null, updatedAtMs: null }
        });
      }
    }
    function defaultTheme(){
      const lp = loadLocalProfile();
      if(lp && lp.theme){
        return {
          emoji: (lp.theme.emoji || "âœï¸").trim(),
          bgColor: clampHexColor(lp.theme.bgColor || "#ffd0e2"),
          pattern: (lp.theme.pattern || lp.theme.bgPattern || "none"),
          patternColor: clampHexColor(lp.theme.patternColor || "#ffffff"),
          photoUrl: (lp.theme.photoUrl || ""),
          emojiBg: clampHexColor(lp.theme.emojiBg || "#2b2b2b"),
          bubbleColor: clampHexColor(lp.theme.bubbleColor || lp.theme.bgColor || "#ffd0e2"),
          timeColor: clampHexColor(lp.theme.timeColor || "#ffffff"),
          emojiSize: Number(lp.theme.emojiSize || 40),
          photoSize: Number(lp.theme.photoSize || 68)
        };
      }
      return { emoji: "âœï¸", bgColor: "#ffd0e2", pattern: "none", patternColor:"#ffffff", photoUrl: "", emojiBg:"#2b2b2b", bubbleColor:"#ffd0e2", timeColor:"#ffffff", emojiSize:40, photoSize:68 };
    }
    async function ensureMeDoc(){
      const ref = meRef(state.roomId, state.uid);
      const snap = await getDoc(ref);
      const today = seoulDateKey();
      if(!snap.exists()){
        await setDoc(ref, {
          name: els.name.value.trim(),
          dateKey: today,
          status: "break",
          totalSecondsToday: focusLoadSeconds(),
          sessionStartedAtMs: null,
          bubbleText: (((loadLocalProfile()||{}).bubbleText || "").toString().trim().slice(0,15)),
          theme: defaultTheme(),
          mission: state.myMission || { dayKey: today, text:"", done:false, doneAt:"" },
          lastSeenAtMs: Date.now(),
          updatedAt: Date.now(),
        });
      } else {
        const data = snap.data();
        // âœ… ê¸°ì¡´ ë°ì´í„°ì—ë„ ë¯¸ì…˜ í•„ë“œ ë™ê¸°í™”(êµ¬ë²„ì „ í˜¸í™˜)
        try{
          const m = state.myMission || loadMissionLocal();
          const need = (!data.mission) || (data.mission?.dayKey !== today);
          if(need){
            const m2 = (m.dayKey===today) ? m : { dayKey: today, text:"", done:false, doneAt:"" };
            state.myMission = m2;
            saveMissionLocal(m2);
            await updateDoc(ref, { mission: m2, updatedAt: Date.now(), lastSeenAtMs: Date.now() });
          }
        }catch(e){}

        // âœ… bubbleTextê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´(êµ¬ë²„ì „ ë°ì´í„°) ë¡œì»¬ì— ì €ì¥ëœ ë§í’ì„ ì„ 1íšŒ ì‹œë“œ
        if((data.bubbleText === undefined || data.bubbleText === null) ){
          try{
            const lp = loadLocalProfile() || {};
            const bt = (lp.bubbleText || "").toString().trim().slice(0,15);
            if(bt) await updateDoc(ref, { bubbleText: bt, updatedAt: Date.now(), lastSeenAtMs: Date.now() });
          }catch(e){}
        }
        if(data.dateKey !== today){
          focusSaveSeconds(0);
          await updateDoc(ref, {
            dateKey: today,
            totalSecondsToday: 0,
            sessionStartedAtMs: null,
            status: "break",
            updatedAt: Date.now(),
          });
        }
      }
    }
    async function heartbeat(){
      if(!state.roomId || !state.uid) return;
      try{
        await updateDoc(meRef(state.roomId, state.uid), {
          lastSeenAtMs: Date.now(),
          updatedAt: Date.now(),
        });
      }catch(e){}
    }
    function computeDisplayedTotal(p){
      const base = Number(p.totalSecondsToday || 0);
      if(p.status === "work" && p.sessionStartedAtMs){
        return base + Math.max(0, (Date.now() - p.sessionStartedAtMs)/1000);
      }
      return base;
    }

    // --- í™œë™ ê°ì§€ (ì§‘ì¤‘ ì‹œê°„ ìë™ ì „í™˜) ---
    function bumpActivity(){
      const now = Date.now();
      // ë„ˆë¬´ ì¦ì€ ì´ë²¤íŠ¸ëŠ” ì‚´ì§ ì¤„ì´ê¸°
      if(now - (state.activityThrottleMs || 0) < 800) return;
      state.activityThrottleMs = now;
      state.lastActivityMs = now;
    }
    ["mousemove","mousedown","keydown","scroll","touchstart"].forEach((ev)=>{
      window.addEventListener(ev, bumpActivity, {passive:true});
    });
    document.addEventListener("visibilitychange", ()=>{
      try{
        if(document.visibilityState === "hidden"){
          // âœ… íƒ­ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë„ ì˜¤ëŠ˜ ì‘ì—…ì‹œê°„ ë¡œì»¬ì— ì €ì¥
          if(state && state.joined) persistMyFocusToLocal();
        }else if(document.visibilityState === "visible"){
          bumpActivity();
        }
      }catch(e){}
    });

    function stopActivityWatch(){
      if(state.activityWatchTimer){
        clearInterval(state.activityWatchTimer);
        state.activityWatchTimer = null;
      }
      if(state.helperWatchTimer){
        clearInterval(state.helperWatchTimer);
        state.helperWatchTimer = null;
      }
      if(state.dayWatchTimer){
        clearInterval(state.dayWatchTimer);
        state.dayWatchTimer = null;
      }
    }

    // âœ… ë¡œì»¬ í—¬í¼(PC ì „ì—­ ë§ˆìš°ìŠ¤ í™œë™) heartbeat í´ë§
    // - í—¬í¼ê°€ active=true ë¥¼ ë³´ë‚´ë©´, ì‘ì—…ë°© íƒ­ì´ ë°±ê·¸ë¼ìš´ë“œì—¬ë„ lastActivityMsë¥¼ ê°±ì‹ í•´ì„œ
    //   ìë™ íœ´ì‹/ìë¦¬ë¹„ì›€ ì „í™˜ì„ ë§‰ìŠµë‹ˆë‹¤(=ì›¹ ë°– ì‘ì—…ë„ ì‘ì—…ì¤‘ ìœ ì§€).
    // - ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ 'ì‘ì—…ì¤‘'ìœ¼ë¡œ ì˜¬ë¦¬ì§„ ì•ŠìŠµë‹ˆë‹¤(ìˆ˜ë™/ê¸°ì¡´ ê·œì¹™ ìœ ì§€).
    
        const HELPER_HEARTBEAT_FRESH_MS = 15000; // í—¬í¼ heartbeat ì‹ í˜¸ ìœ íš¨ì‹œê°„(ms) (ê¸°ë³¸ 15ì´ˆ)
function helperPairKey(){
      const nick = (state.nickname || "").trim();
      state.helperKeyInvalid = false;
      if(!nick) return "";
      // RTDB key ì œí•œ: . # $ [ ] / ëŠ” ë¶ˆê°€ ('.'ê°€ ìˆìœ¼ë©´ í—¬í¼ ê²½ë¡œê°€ ê¹¨ì ¸ìš”)
      if(nick.includes(".")){
        state.helperKeyInvalid = true;
        return "";
      }
      return nick;
    }

    // âœ… ë¡œì»¬ í—¬í¼ ì—°ê²° ìƒíƒœ UI
    function updateHelperStatusUI(){
      try{
        if(!els.helperStatusDot || !els.helperStatusText) return;

        const now = Date.now();
        const lastFresh = Number(state.helperLastFreshMs || 0);
        const connected = !!(lastFresh && (now - lastFresh) <= HELPER_HEARTBEAT_FRESH_MS);
        const active = !!(state.helperActive && connected);

        let cls = "helperDot off";
        let text = "ë¯¸ì—°ê²°";

        if(state.helperKeyInvalid){
          cls = "helperDot off";
          text = "ë‹‰ë„¤ì„ì— '.' í¬í•¨ â†’ í—¬í¼ì—°ë™ ë¶ˆê°€";
        }else if(state.helperAuthError){
          cls = "helperDot off";
          text = "ì½ê¸°ê¶Œí•œ ì—†ìŒ (rules)";
        }else if(connected && active){
          cls = "helperDot on";
          text = "ì—°ê²°ë¨ (í™œë™ì¤‘)";
        }else if(connected && !active){
          cls = "helperDot wait";
          text = "ì—°ê²°ë¨ (ëŒ€ê¸°)";
        }

        els.helperStatusDot.className = cls;
        els.helperStatusText.textContent = text;

        // âœ… ë””ë²„ê·¸(ë¬¸ì œ ì§„ë‹¨ìš©): active/idleSec/mode í‘œì‹œ
        try{
          if(els.helperDebugText){
            const mode = getHelperMode();
            const idleSec = (state.helperIdleSecPresent && Number.isFinite(state.helperIdleSec)) ? state.helperIdleSec : null;
            const z = Number(state.helperIdleZeroStreak || 0);
            let extra = `mode:${mode}`;
            if(state.helperAuthError) extra += " | rules";
            if(state.helperKeyInvalid) extra += " | key";
            if(state.helperConnected){
              extra += ` | active:${state.helperActive ? "Y" : "N"}`;
              if(idleSec !== null){
                extra += ` | idleSec:${idleSec}`;
                if(!state.helperActive && idleSec === 0 && z >= 6) extra += " âš ï¸idle0";
              }else{
                // idleSec ë¯¸ì œê³µì´ë©´ ì›¹ì´ ìì²´ ëˆ„ì 
                if(state._helperInactiveSinceMs){
                  const s = Math.floor((Date.now() - state._helperInactiveSinceMs)/1000);
                  extra += ` | idle~${s}s`;
                }
              }
            }
            els.helperDebugText.textContent = extra;
          }
        }catch(e){}

      }catch(e){}
    }


    // âœ… í—¬í¼ ëª¨ë“œ: manual(ìˆ˜ë™/ì•ˆì „) / auto(ìë™ì „í™˜)
    function getHelperMode(){
      try{
        const lp = loadLocalProfile() || {};
        const m = String(lp.helperMode || state.helperMode || "auto");
        return (m === "manual" || m === "auto") ? m : "auto";
      }catch(e){ return (state.helperMode || "auto"); }
    }
    function setHelperMode(mode, save=true){
      const m = (mode === "manual") ? "manual" : "auto";
      state.helperMode = m;
      try{
        if(els.helperMode) els.helperMode.value = m;
        // ìë™ì¼ ë•Œë§Œ ìë™ì „í™˜ ë¶„ ì…ë ¥ í™œì„±í™”
        const en = (m === "auto");
        if(els.autoBreakMin) els.autoBreakMin.disabled = !en;
        if(els.autoIdleMin)  els.autoIdleMin.disabled  = !en;
      }catch(e){}
      if(save){
        try{
          const lp = loadLocalProfile() || {};
          lp.helperMode = m;
          saveLocalProfile(lp);
        }catch(e){}
      }
    }

async function pollHelperHeartbeat(){
      try{
        if(!state.joined) return;

        const key = helperPairKey();
        if(!key){
          state.helperConnected = false;
          state.helperActive = false;
          updateHelperStatusUI();
          return;
        }

        // âœ… í—¬í¼/ì‘ì—…ë°© ê°„ ìŠ¤í‚¤ë§ˆ ì°¨ì´ë¥¼ í¡ìˆ˜í•˜ê¸° ìœ„í•´, heartbeatë§Œì´ ì•„ë‹ˆë¼ pair ì „ì²´ë¥¼ ì½ìŠµë‹ˆë‹¤.
        // - ì–´ë–¤ í—¬í¼ëŠ” /heartbeat ì•ˆì— tsë¥¼ ë„£ê³ 
        // - ì–´ë–¤ í—¬í¼ëŠ” /helperPairs/{nick}/ts ê°™ì€ ë£¨íŠ¸ì— tsë¥¼ ë‘¡ë‹ˆë‹¤.
        const url = `${RTDB_BASE_URL}/helperPairs/${encodeURIComponent(key)}.json?_=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });

        // ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œë¡œ ì½ê¸° ì‹¤íŒ¨ â†’ ë§ˆì§€ë§‰ ì •ìƒ ì‹ í˜¸ê°€ ì—†ìœ¼ë©´ ë¯¸ì—°ê²° ì²˜ë¦¬
        if(!res.ok){
          const now = Date.now();

          // âœ… rules ê¶Œí•œ ë¬¸ì œ(401/403) ì•ˆë‚´
          if(res.status === 401 || res.status === 403){
            state.helperConnected = false;
            state.helperActive = false;
            state.helperAuthError = true;
            updateHelperStatusUI();

            if(!state._helperAuthWarned){
              showToast("í—¬í¼ ìƒíƒœ ì½ê¸° ê¶Œí•œì´ ì—†ì–´ìš”(401/403). RTDB rulesì—ì„œ helperPairs ì½ê¸° í—ˆìš©ì´ í•„ìš”í•´ìš”.");
              state._helperAuthWarned = true;
            }
            return;
          }

          const lastFresh = Number(state.helperLastFreshMs || 0);
          const connected = !!(lastFresh && (now - lastFresh) <= HELPER_HEARTBEAT_FRESH_MS);
          state.helperConnected = connected;
          if(!connected) state.helperActive = false;
          updateHelperStatusUI();
          return;
        }

        state.helperAuthError = false;

        const raw = await res.json();
        if(!raw){
          const now = Date.now();
          const lastFresh = Number(state.helperLastFreshMs || 0);
          const connected = !!(lastFresh && (now - lastFresh) <= HELPER_HEARTBEAT_FRESH_MS);
          state.helperConnected = connected;
          if(!connected) state.helperActive = false;
          updateHelperStatusUI();
          return;
        }

        // âœ… ìŠ¤í‚¤ë§ˆ í˜¸í™˜: hbëŠ” raw.heartbeatê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„ 
        const hb = (raw && typeof raw === "object" && raw.heartbeat && typeof raw.heartbeat === "object")
          ? raw.heartbeat
          : raw;

        // âœ… active í˜¸í™˜
        const activeRaw = (hb.active ?? raw.active ?? hb.isActive ?? hb.is_active ?? hb.moving ?? hb.isMoving ?? hb.activity ?? hb.state ?? hb.status);
        let activeBool = false;
        if(typeof activeRaw === "boolean") activeBool = activeRaw;
        else if(typeof activeRaw === "number") activeBool = activeRaw > 0;
        else if(typeof activeRaw === "string"){
          const s = activeRaw.toLowerCase();
          activeBool = (s === "active" || s === "work" || s === "working" || s === "moving" || s === "move" || s === "on" || s === "true" || s === "1");
        }

        // âœ… ts í˜¸í™˜(heartbeat ë‚´ë¶€/ë£¨íŠ¸/cfg ë“±)
        const tsRaw = (
          hb.ts ?? raw.ts ??
          hb.timestamp ?? raw.timestamp ??
          hb.time ?? raw.time ??
          hb.t ?? raw.t ??
          hb.serverTs ?? raw.serverTs ??
          hb.server_ts ?? raw.server_ts ??
          hb.lastSeenAtMs ?? raw.lastSeenAtMs ?? raw.lastSeenAt ?? raw.last_seen_at_ms ??
          raw.cfg?.ts ?? raw.cfg?.timestamp ?? raw.cfg?.serverTs ?? raw.cfg?.server_ts ??
          hb.cfg?.ts ?? hb.cfg?.timestamp ?? hb.cfg?.serverTs ?? hb.cfg?.server_ts
        );
        const ts = Number(tsRaw || 0);

        // âœ… idleSec í˜¸í™˜(ìˆìœ¼ë©´ ë” ì •í™•í•˜ê²Œ ìƒíƒœ ë™ê¸°í™”)
        const idleSecRaw = (
          hb.idleSec ?? raw.idleSec ??
          raw.cfg?.idleSec ?? raw.cfg?.idle_sec ??
          hb.cfg?.idleSec ?? hb.cfg?.idle_sec
        );
        const idleSec = Number(idleSecRaw || 0);

        // í—¬í¼ê°€ ì„œë²„ timestampë¥¼ ì“°ë¯€ë¡œ, tsëŠ” ì„œë²„ì‹œê°„(ms)
        const now = Date.now();
        const fresh = ts && Math.abs(now - ts) <= HELPER_HEARTBEAT_FRESH_MS;

        // âœ… fresh ì‹ í˜¸ì¼ ë•Œë§Œ 'ë§ˆì§€ë§‰ ì •ìƒ ì‹ í˜¸' ì‹œê°ì„ ê°±ì‹ 
        if(fresh) state.helperLastFreshMs = now;

        const lastFresh = Number(state.helperLastFreshMs || 0);
        const connected = !!(lastFresh && (now - lastFresh) <= HELPER_HEARTBEAT_FRESH_MS);

        state.helperConnected = connected;
        state.helperActive = !!(activeBool && connected);
        state.helperLastTs = ts || 0;

        updateHelperStatusUI();

                // âœ… idleSec/ë¬´ë°˜ì‘ ëˆ„ì  ì²˜ë¦¬(í—¬í¼ê°€ idleSecë¥¼ ëª» ì˜¬ë¦¬ê±°ë‚˜ 0ìœ¼ë¡œ ê³ ì •ë˜ëŠ” ì¼€ì´ìŠ¤ ë°©ì–´)
        state.helperIdleSecPresent = (idleSecRaw !== undefined && idleSecRaw !== null && idleSecRaw !== "");
        state.helperIdleSec = (Number.isFinite(idleSec) ? idleSec : null);

        if(connected){
          if(state.helperActive){
            state.lastActivityMs = now;
            state._helperInactiveSinceMs = 0;
            state.helperIdleZeroStreak = 0;
          }else{
            // inactive ìƒíƒœê°€ ìœ ì§€ë˜ë©´ ì›¹ì—ì„œ ìì²´ì ìœ¼ë¡œ ë¬´ë°˜ì‘ ì‹œê°„ì„ ëˆ„ì (í—¬í¼ idleSecê°€ ê³ ì¥ë‚˜ë„ ë™ì‘)
            if(!state._helperInactiveSinceMs) state._helperInactiveSinceMs = now;

            // idleSecê°€ 0ìœ¼ë¡œ ë°˜ë³µë˜ë©´ ì´ìƒ ì‹ í˜¸ë¡œ ê°„ì£¼(ëª‡ ë²ˆê¹Œì§€ë§Œ ì‹ ë¢°)
            if(state.helperIdleSecPresent && state.helperIdleSec === 0){
              state.helperIdleZeroStreak = Number(state.helperIdleZeroStreak || 0) + 1;
            }else{
              state.helperIdleZeroStreak = 0;
            }

            // idleSecê°€ ìœ íš¨(>0)ë©´ ë§ˆì§€ë§‰ í™œë™ ì‹œê°ì„ ë³´ì •í•´ì¤Œ(ë°±ê·¸ë¼ìš´ë“œ íƒ­ì—ì„œë„ ì •í™•)
            if(state.helperIdleSecPresent && Number.isFinite(state.helperIdleSec) && state.helperIdleSec > 0){
              const impliedLast = now - (state.helperIdleSec * 1000);
              state.lastActivityMs = Math.max(Number(state.lastActivityMs || 0), impliedLast);
              state._helperInactiveSinceMs = Math.min(state._helperInactiveSinceMs || now, impliedLast);
            }
          }
        }

// âœ… helperActiveê°€ 'êº¼ì¡Œë‹¤ê°€ ì¼œì§ˆ ë•Œ'(=ì›€ì§ì„ ì¬ê°ì§€) ìë™ ë³µê·€ ê·œì¹™
        // - ë‹¨, ë‚´ê°€ 'ìë™ ì „í™˜(auto*)' ë•Œë¬¸ì— íœ´ì‹/ìë¦¬ë¹„ì›€ì´ ëœ ê²½ìš°ì—ë§Œ workë¡œ ë³µê·€
        const prevActive = !!state._prevHelperActive;
        state._prevHelperActive = !!state.helperActive;

        const me = state.currentParticipants ? state.currentParticipants.get(state.uid) : null;
        const status = me?.status || "idle";
        const src = String(me?.statusSource || "");

        // 1) ì‘ì—…ì¤‘ì´ë©´: í—¬í¼ active ë™ì•ˆì€ ë§ˆì§€ë§‰ í™œë™ì„ ê°±ì‹ (ìë™ break/idle ë°©ì§€)
        if(status === "work" && state.helperActive){
          state.lastActivityMs = now;
          return;
        }

        // 2) ìë™ìœ¼ë¡œ break/idle ëœ ìƒíƒœì—ì„œ, í—¬í¼ê°€ ë‹¤ì‹œ active(ì¬ê°ì§€) ë˜ë©´ ì‘ì—…ì¤‘ìœ¼ë¡œ ë³µê·€
        if(state.helperActive && !prevActive && (status === "break" || status === "idle") && src.startsWith("auto")){
          transitionTo("work","helperResume");
          state.lastActivityMs = now;
          showToast("í—¬í¼ ì›€ì§ì„ ê°ì§€ â†’ ì‘ì—…ì¤‘ ë³µê·€", 1800);
        }
      }catch(e){
        const now = Date.now();
        const lastFresh = Number(state.helperLastFreshMs || 0);
        const connected = !!(lastFresh && (now - lastFresh) <= HELPER_HEARTBEAT_FRESH_MS);
        state.helperConnected = connected;
        if(!connected) state.helperActive = false;
        updateHelperStatusUI();
      }
    }
function startHelperWatch(){
      // helperëŠ” 5ì´ˆë§ˆë‹¤ ì˜¬ë¦¬ë„ë¡ ì„¤ê³„(í—¬í¼ ê¸°ë³¸ ping_seconds=5)
      if(state.helperWatchTimer) clearInterval(state.helperWatchTimer);
      state.helperWatchTimer = setInterval(pollHelperHeartbeat, 5000);
      // ì¦‰ì‹œ 1íšŒ
      pollHelperHeartbeat();
    }

    function startActivityWatch(){
      stopActivityWatch();
      startHelperWatch();
      state.activityWatchTimer = setInterval(()=>{
        if(!state.joined || !state.roomId || !state.uid) return;

        const me = state.currentParticipants ? state.currentParticipants.get(state.uid) : null;
        const status = me?.status || "idle";
        if(status !== "work") return;

                // âœ… ìë™/ìˆ˜ë™ ëª¨ë“œ
        const mode = getHelperMode();
        if(mode !== "auto") return;

        // âœ… ë¬´ë°˜ì‘ ì‹œê°„ ê³„ì‚°(í—¬í¼ idleSecê°€ ê³ ì¥ë‚˜ë„, inactive ì‹œì‘ ì‹œê°ìœ¼ë¡œ ëˆ„ì )
        let idleMs = Date.now() - (state.lastActivityMs || Date.now());
        if(state.helperConnected){
          if(state.helperActive){
            idleMs = 0;
          }else{
            // 1) í—¬í¼ê°€ idleSecë¥¼ ì •í™•íˆ ì˜¬ë ¤ì£¼ë©´ ê·¸ ê°’ì„ ìš°ì„  ì‚¬ìš©
            if(state.helperIdleSecPresent && Number.isFinite(state.helperIdleSec) && state.helperIdleSec > 0){
              idleMs = state.helperIdleSec * 1000;
            }else if(state._helperInactiveSinceMs){
              // 2) idleSecê°€ ì—†ê±°ë‚˜ 0ìœ¼ë¡œ ê³ ì •ë˜ë©´, inactiveSinceë¡œ ëˆ„ì (í—¬í¼ ì´ë²¤íŠ¸ ê¸°ë°˜)
              idleMs = Date.now() - state._helperInactiveSinceMs;
            }
          }
        }

        // âœ… ë¡œì»¬(ë‚´ í”„ë¡œí•„)ì—ì„œ ìë™ ì „í™˜ ì‹œê°„(ë¶„)ì„ ì½ì–´ ì ìš©
        let ab = 10, ai = 15;
        try{
          const lp = loadLocalProfile() || {};
          ab = Math.min(180, Math.max(1, Number(lp.autoBreakMin ?? 10)));
          ai = Math.min(180, Math.max(1, Number(lp.autoIdleMin ?? 15)));
          if(ai < ab) ai = Math.min(180, ab + 5);
        }catch(e){}
        if(idleMs >= ai*60*1000){
          transitionTo("idle","autoIdle");
          showToast(`${ai}ë¶„ ë¬´ë°˜ì‘ â†’ ìë¦¬ë¹„ì›€`);
        }else if(idleMs >= ab*60*1000){
          transitionTo("break","autoBreak");
          showToast(`${ab}ë¶„ ë¬´ë°˜ì‘ â†’ íœ´ì‹ì¤‘`);
        }
      }, 15000);

      // âœ… ìì •(KST) ë„˜ì–´ê°€ë©´ ì§‘ì¤‘ì‹œê°„ ë¡œì»¬/ë‚´ ë¬¸ì„œ ë¦¬ì…‹
      if(state.dayWatchTimer) clearInterval(state.dayWatchTimer);
      state._lastDayKey = state._lastDayKey || seoulDateKey();
      state.dayWatchTimer = setInterval(async ()=>{
        try{
          const dk = seoulDateKey();
          if(!state._lastDayKey) state._lastDayKey = dk;
          if(state._lastDayKey !== dk){
            state._lastDayKey = dk;
            focusSaveSeconds(0);
            // ë‚´ê°€ ë°©ì— ë“¤ì–´ì™€ ìˆëŠ” ìƒíƒœë©´ ë‚´ ë¬¸ì„œë„ ë¦¬ì…‹
            if(state.uid && state.roomId){
              const ref = meRef(state.roomId, state.uid);
              await updateDoc(ref, { dateKey: dk, status: "break", totalSecondsToday: 0, sessionStartedAtMs: null, updatedAt: Date.now(), lastSeenAtMs: Date.now() });
            }
          }
        }catch(e){}
      }, 60000);

    }

    async function transitionTo(nextStatus, source="manual"){
      // âœ… ìƒíƒœ ì „í™˜ ì§ì „ í˜„ì¬ ì§‘ì¤‘ì‹œê°„ì„ ë¡œì»¬ì— ëˆ„ì  ì €ì¥
      persistMyFocusToLocal();
      const ref = meRef(state.roomId, state.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const p = snap.data();
      const now = Date.now();
      const patch = { status: nextStatus, statusSource: source, updatedAt: now, lastSeenAtMs: now };
      if(nextStatus === "work") { state.lastActivityMs = now; }

      if(p.status === "work" && p.sessionStartedAtMs){
        const deltaSec = Math.max(0, Math.floor((now - p.sessionStartedAtMs)/1000));
        patch.totalSecondsToday = (p.totalSecondsToday || 0) + deltaSec;
        patch.sessionStartedAtMs = null;
      }
      if(nextStatus === "work" && p.status !== "work"){
        patch.sessionStartedAtMs = now;
      }
      await updateDoc(ref, patch);
    }
    async function applyProfile(){
      const theme = {
        emoji: ((window.firstEmojiGrapheme|| (typeof firstEmojiGrapheme==='function' ? firstEmojiGrapheme : null) || ((s)=>{ try{const a=Array.from(String(s||'').trim()); return a[0]||'';}catch(e){return '';} }))(els.emoji.value || "âœï¸")),
        bgColor: clampHexColor(els.bgColor.value),
        pattern: (els.bgPattern && els.bgPattern.value ? els.bgPattern.value : "none"),
        bgPattern: (els.bgPattern && els.bgPattern.value ? els.bgPattern.value : "none"),
        patternColor: clampHexColor((els.patternColor && els.patternColor.value) ? els.patternColor.value : "#ffffff"),
        photoUrl: state.myPhotoUrl || "",
        emojiBg: clampHexColor((els.emojiBgColor && els.emojiBgColor.value) ? els.emojiBgColor.value : "#2b2b2b"),
        bubbleColor: clampHexColor((els.bubbleColor && els.bubbleColor.value) ? els.bubbleColor.value : (els.bgColor ? els.bgColor.value : "#ffd0e2")),
        timeColor: clampHexColor((els.timeColor && els.timeColor.value) ? els.timeColor.value : "#ffffff"),
        emojiSize: 82,
        photoSize: 82
      };
      const bubbleText = (els.bubbleText.value || "").trim().slice(0, 15);
      const newNick = (els.profileNick?.value || "").trim().slice(0,20);
      if(newNick){
        state.nickname = newNick;
        if(els.name) els.name.value = newNick;
        try{ localStorage.setItem("mk_last_name", newNick); }catch(e){}
      }


      // âœ… ìë™ ì „í™˜(ë¶„) â€” ì‘ì—…ì¤‘ì¼ ë•Œë§Œ ì ìš©
      const autoBreakMin = Math.min(180, Math.max(1, Number(els.autoBreakMin?.value || 10)));
      const autoIdleMin  = Math.min(180, Math.max(1, Number(els.autoIdleMin?.value || 15)));
      if(autoIdleMin < autoBreakMin){ /* ì•ˆì „ì¥ì¹˜ */
        // ìë¦¬ë¹„ì›€ì´ íœ´ì‹ë³´ë‹¤ ë¹¨ë¼ì§€ë©´ íœ´ì‹+5ë¡œ ë³´ì •
        const fixed = Math.min(180, autoBreakMin + 5);
        if(els.autoIdleMin) els.autoIdleMin.value = String(fixed);
      }


      // âœ… í—¬í¼ ëª¨ë“œ ë°˜ì˜
      try{ setHelperMode((els.helperMode && els.helperMode.value==='manual')?'manual':'auto', true); }catch(e){}

      // âœ… ë¸Œë¼ìš°ì €ì— í”„ë¦¬ì…‹ ì €ì¥(ë¡œê·¸ì¸/ì…ì¥ ì „ì—ë„ ìœ ì§€)
      try{
        const lp = loadLocalProfile() || {};
        lp.theme = theme;
        lp.bubbleText = bubbleText;
        if(state.nickname) lp.nickname = state.nickname;
        lp.autoBreakMin = Math.min(180, Math.max(1, Number(els.autoBreakMin?.value || lp.autoBreakMin || 10)));
        lp.helperMode = (els.helperMode && els.helperMode.value==='manual') ? 'manual' : 'auto';
        lp.autoIdleMin  = Math.min(180, Math.max(1, Number(els.autoIdleMin?.value || lp.autoIdleMin || 15)));
        if(lp.autoIdleMin < lp.autoBreakMin) lp.autoIdleMin = Math.min(180, lp.autoBreakMin + 5);
        saveLocalProfile(lp);
      }catch(e){}

      // ì…ì¥ ì „(ì•„ì§ uid ì—†ìŒ)ì´ë©´ ë¡œì»¬ë§Œ ì €ì¥í•˜ê³  ë
      if(!state.uid || !state.roomId){
        showToast("ì €ì¥! (ì´ ë¸Œë¼ìš°ì €ì— ê¸°ì–µí•´ë‘˜ê²Œ)");
        hideModal(els.profileModal);
        return;
      }

      const ref = meRef(state.roomId, state.uid);
      await updateDoc(ref, { theme, bubbleText, name: (state.nickname || undefined), autoBreakMin, autoIdleMin: Math.min(180, Math.max(1, Number(els.autoIdleMin?.value || 15))), updatedAt: Date.now(), lastSeenAtMs: Date.now() });
      showToast("ì €ì¥!");
      hideModal(els.profileModal);
    }

    // Photo upload (Storage)
    async function uploadPhoto(){
      const f = els.photoFile.files?.[0];
      if(!f){ showToast("íŒŒì¼ ì„ íƒ!"); return; }
      if(f.size > 2 * 1024 * 1024){ showToast("2MB ì´í•˜ ì¶”ì²œ!"); return; }
      if(!/^image\//.test(f.type) && !/\.gif$/i.test(f.name)){ showToast("ì´ë¯¸ì§€ íŒŒì¼ë§Œ!"); return; }

      const path = `rooms/${state.roomId}/avatars/${state.uid}/profile`; // overwrite-friendly
      const ref = sRef(storage, path);

      try{
        await uploadBytes(ref, f, { contentType: f.type || "image/gif" });
        const url = await getDownloadURL(ref);
        state.myPhotoUrl = url;
        // âœ… ì—…ë¡œë“œ ì‹œ ë¡œì»¬ ì„¤ì •ì—ë„ ì¦‰ì‹œ ì €ì¥(ì¬ì…ì¥ ì‹œ ìœ ì§€)
        try{
          const lp = loadLocalProfile() || {};
          lp.theme = lp.theme || {};
          const oldUrl = (lp.theme.photoUrl || "");
          if(oldUrl && oldUrl !== url){
            try{
              localStorage.removeItem("mk_photo_cache_url_v1");
              localStorage.removeItem("mk_photo_cache_blob_v1");
            }catch(e){}
          }
          lp.theme.photoUrl = url;
          saveLocalProfile(lp);
          try{ localStorage.setItem("mk_photo_cache_url_v1", url); }catch(e){}
        }catch(e){}
        await updateDoc(meRef(state.roomId, state.uid), {
          "theme.photoUrl": url,
          updatedAt: Date.now(),
          lastSeenAtMs: Date.now()
        });
        showToast("ì—…ë¡œë“œ ì™„ë£Œ!");
      }catch(e){
        console.error(e);
        showToast("ì—…ë¡œë“œ ì‹¤íŒ¨(ìŠ¤í† ë¦¬ì§€ ê·œì¹™/ì„¤ì • í™•ì¸)");
      }
    }

    // Room subscribe (dashboard links)
    function coerceCount(v){
  if(v==null) return null;
  if(typeof v==="number" && isFinite(v)) return v;
  if(typeof v==="string"){
    const s=v.trim().replace(/,/g,"");
    if(s==="" ) return null;
    const n=Number(s);
    if(!Number.isNaN(n) && isFinite(n)) return n;
    return v; // fallback keep string
  }
  if(Array.isArray(v)) return v.length;
  if(typeof v==="object"){
    // common keys
    const keys = ["count","online","onlineCount","users","userCount","members","memberCount","value","total","n","num","size","length"];
    for(const k of keys){
      if(v[k]!=null){
        const r=coerceCount(v[k]);
        if(r!=null) return r;
      }
    }
    // first numeric-looking property
    for(const [k,val] of Object.entries(v)){
      const r=coerceCount(val);
      if(typeof r==="number") return r;
    }
    return null;
  }
  return null;
}

    function renderDashboard(){
  try{
    const d = (state.roomSettings && state.roomSettings.dashboard) ? state.roomSettings.dashboard : {};
    const cRemote = (state.roomSettings && state.roomSettings.dashCounts) ? state.roomSettings.dashCounts : {};
    const cLocal = state.localDashCounts || {};
    const c = (cLocal && (cLocal.pomoCount!=null || cLocal.sudaCount!=null)) ? cLocal : cRemote;

    const pomoVal = coerceCount(c.pomoCount);
    const sudaVal = coerceCount(c.sudaCount);

    if(els.pomoCount) els.pomoCount.textContent = (pomoVal!=null ? pomoVal : "â€”");
    if(els.sudaCount) els.sudaCount.textContent = (sudaVal!=null ? sudaVal : "â€”");

    // raw ê°’ì´ ê°ì²´ë©´ íˆ´íŒìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ
    if(els.pomoCount) els.pomoCount.title = (typeof c.pomoCount==="object" ? JSON.stringify(c.pomoCount) : "");
    if(els.sudaCount) els.sudaCount.title = (typeof c.sudaCount==="object" ? JSON.stringify(c.sudaCount) : "");

    const updated = c.updatedAtMs ? new Date(c.updatedAtMs).toLocaleString("ko-KR") : "-";
    if(els.dashUpdated) els.dashUpdated.textContent = updated;

    // ë§í¬ëŠ” ìƒˆ íƒ­ìœ¼ë¡œë§Œ (ì•±ìŠ¤í¬ë¦½íŠ¸/ë³´ì•ˆì •ì±… ë•Œë¬¸ì— ë‚´ë¶€ ì„ë² ë“œ ì œê±°)
    if(els.goPomo) els.goPomo.onclick = ()=>openUrl(d.pomoUrl);
    if(els.goPomoMini){ els.goPomoMini.disabled = !d.pomoUrl; els.goPomoMini.onclick = ()=>openUrl(d.pomoUrl); }
    if(els.goSuda) els.goSuda.onclick = ()=>openUrl(d.sudaUrl);
    if(els.goSudaMini){ els.goSudaMini.disabled = !d.sudaUrl; els.goSudaMini.onclick = ()=>openUrl(d.sudaUrl); }
    if(els.goChool) els.goChool.onclick = ()=>openUrl(d.choolUrl);
    if(els.goSheet) els.goSheet.onclick = ()=>openUrl(d.sheetUrl);

    if(els.pomoUrl) els.pomoUrl.value = d.pomoUrl || "";
    if(els.sudaUrl) els.sudaUrl.value = d.sudaUrl || "";
    if(els.choolUrl) els.choolUrl.value = d.choolUrl || "";
    if(els.sheetUrl) els.sheetUrl.value = d.sheetUrl || "";
    if(els.dashApiUrl) els.dashApiUrl.value = d.dashApiUrl || "";
  }catch(e){}
}

    function subscribeRoom(){
      if(state.unsubRoom) state.unsubRoom();
      state.unsubRoom = safeOnSnapshot(roomRef(state.roomId), (snap)=>{
        if(!snap.exists()) return;
        const r = snap.data();
        const _dash = Object.assign({pomoUrl:"", sudaUrl:"", choolUrl:"", sheetUrl:"", dashApiUrl: DEFAULT_DASH_API_URL}, (r.dashboard || {}));
      if(!_dash.dashApiUrl || !_dash.dashApiUrl.trim()) _dash.dashApiUrl = DEFAULT_DASH_API_URL;
      state.roomSettings.dashboard = _dash;
        ensureDashPolling();
        state.roomSettings.dashCounts = r.dashCounts || {pomoCount:null, sudaCount:null, updatedAtMs:null};
        state.roomSettings.adminHash = r.adminHash || null;
        state.adminHash = state.roomSettings.adminHash;
        renderDashboard();
      });
    }

    // Admin settings
    async function unlockAdmin(){
      const pass = (els.adminPass.value || "").trim();
      if(!pass){ showToast("ê´€ë¦¬ì ë¹„ë²ˆ ì…ë ¥"); return; }
      const hash = await sha256Hex(pass);

      if(!state.adminHash){
        await updateDoc(roomRef(state.roomId), { adminHash: hash });
        state.adminHash = hash;
        state.adminOk = true;
        els.adminArea.style.display = "block";
        showToast("ë¹„ë²ˆ ë“±ë¡!");
        return;
      }
      if(hash === state.adminHash){
        state.adminOk = true;
        els.adminArea.style.display = "block";
        showToast("í™•ì¸ ì™„ë£Œ!");
      }else{
        state.adminOk = false;
        els.adminArea.style.display = "none";
        showToast("ë¹„ë²ˆì´ ë‹¬ë¼â€¦");
      }
    }
    async function saveDashboard(){
      if(!state.adminOk){ showToast("ê´€ë¦¬ì í™•ì¸ë¶€í„°!"); return; }
      const dashboard = {
        pomoUrl: (els.pomoUrl.value || "").trim(),
        sudaUrl: (els.sudaUrl.value || "").trim(),
        choolUrl: (els.choolUrl.value || "").trim(),
        sheetUrl: (els.sheetUrl.value || "").trim(),
        dashApiUrl: (els.dashApiUrl && els.dashApiUrl.value ? els.dashApiUrl.value : "").trim(),
      };
      await updateDoc(roomRef(state.roomId), { dashboard });
      showToast("ì €ì¥!");
    }

    // Chat
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    const CHAT_MAX_VIEW = 70;
    // If mission events share the same collection, fetch a bit more so chat still shows up to 70.
    const CHAT_QUERY_LIMIT = 220;

    function makeMsgNode(m){
      const div = document.createElement("div");
      const isMe = (m.uid && state.uid && m.uid === state.uid);
      div.className = "msg " + (isMe ? "me" : "other");
      const p = (m.uid && state.currentParticipants) ? state.currentParticipants.get(m.uid) : null;
      const emoji = (p && p.theme && p.theme.emoji) ? String(p.theme.emoji) : "ğŸ’¬";
      const nick = (m.name || (p && p.name) || "ìµëª…");
      div.innerHTML = `
        <div class="meta"><span><span class="chatEmoji">${escapeHtml(emoji)}</span><span class="chatName">${escapeHtml(nick)}</span></span></div>
        <div class="text">${escapeHtml(m.text || "")}</div>
      `;
      return div;
    }

    function renderChatFull(list){
      els.chatList.innerHTML = "";
      const frag = document.createDocumentFragment();
      for(const m of list){
        frag.appendChild(makeMsgNode(m));
      }
      els.chatList.appendChild(frag);
    }

    function isChatNearBottom(){
      try{
        const el = els.chatList;
        if(!el) return true;
        const threshold = 24;
        return (el.scrollTop + el.clientHeight >= el.scrollHeight - threshold);
      }catch(e){ return true; }
    }
    function scrollChatToBottom(){
      try{
        const el = els.chatList;
        if(!el) return;
        el.scrollTop = el.scrollHeight;
      }catch(e){}
    }
    function showChatNewBar(){
      if(!els.chatNewBar || !els.chatUnseenCount) return;
      if(state.chatUnseen <= 0) return;
      els.chatUnseenCount.textContent = String(state.chatUnseen);
      els.chatNewBar.style.display = "flex";
    }
    function hideChatNewBar(reset=false){
      if(reset) state.chatUnseen = 0;
      if(els.chatNewBar) els.chatNewBar.style.display = "none";
    }

    function subscribeChat(){
      if(state.unsubChat) state.unsubChat();
      state.chatDisplayIds = [];

      // âœ… DBì—ì„œ ìµœëŒ€ 70ê°œë§Œ ê°€ì ¸ì˜¤ê³ (=CHAT_MAX_VIEW), í™”ë©´ì—ì„œë„ 70ê°œë§Œ ìœ ì§€
      //    â€» mission ì´ë²¤íŠ¸ê°€ ê°™ì€ ì»¬ë ‰ì…˜ì— ì„ì—¬ ìˆìœ¼ë©´ ì‹¤ì œ í‘œì‹œ ê°œìˆ˜ëŠ” 70ë³´ë‹¤ ì ì„ ìˆ˜ ìˆìŒ
      const q = query(chatCol(state.roomId), orderBy("tsMs", "desc"), limit(CHAT_QUERY_LIMIT));
      state.unsubChat = safeOnSnapshot(q, (qs)=>{
        const docs = [];
        qs.forEach(d=>{
          const data = d.data();
          docs.push({ id: d.id, ...data });
        });

        // newest first(desc) -> oldest first(asc)
// âœ… SFX(ì…ì¥/í‡´ì¥) ì´ë²¤íŠ¸ ì¬ìƒ
// - ìµœì´ˆ ë¡œë“œì—ì„œëŠ” ì˜ˆì „ ì´ë²¤íŠ¸ë¥¼ ì¬ìƒí•˜ì§€ ì•Šê³  ê¸°ì¤€(tsMs)ë§Œ ì¡ì•„ìš”.
// - ì´í›„ë¶€í„°ëŠ” ìƒˆë¡œ ì¶”ê°€ëœ sfxë§Œ ì¬ìƒí•©ë‹ˆë‹¤.
try{
  if(!state.sfxInitDone){
    let maxTs = 0;
    for(const m of docs){
      if(m && m.type === "sfx") maxTs = Math.max(maxTs, Number(m.tsMs||0));
    }
    state.lastSfxTs = Math.max(Number(state.lastSfxTs||0), maxTs);
    state.sfxInitDone = true;
  }else{
    qs.docChanges().forEach((ch)=>{
      if(ch.type !== "added") return;
      const d = ch.doc.data() || {};
      if(d.type !== "sfx") return;
      const ts = Number(d.tsMs || 0);
      if(!ts || ts <= (state.lastSfxTs || 0)) return;
      state.lastSfxTs = ts;

      // ë‚´ ì´ë²¤íŠ¸ëŠ” ë²„íŠ¼ í´ë¦­ ìˆœê°„ ì´ë¯¸ ì¬ìƒ -> ì¤‘ë³µ ë°©ì§€
      if(d.uid && state.uid && d.uid === state.uid) return;

      playSfx(d.kind);
    });
  }
}catch(e){}

        docs.reverse();

        // mission ì´ë²¤íŠ¸ëŠ” ì±„íŒ… ë Œë”ì—ì„œ ì œì™¸
        const list = docs.filter(m => !(m && (m.type === "mission" || m.type === "sfx"))).slice(-CHAT_MAX_VIEW);
        const newIds = list.map(m => m.id);

        // âœ… ì‚¬ìš©ìê°€ ê±°ì˜ ë°”ë‹¥ì— ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤
        const nearBottom = (()=>{
          try{
            const el = els.chatList;
            const threshold = 24;
            return (el.scrollTop + el.clientHeight >= el.scrollHeight - threshold);
          }catch(e){ return true; }
        })();

        const oldIds = state.chatDisplayIds || [];

        // âœ… ì½ëŠ” ì¤‘ì´ë©´(ë°”ë‹¥ì´ ì•„ë‹ˆë©´) ìë™ìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šê³ , ìƒˆ ë©”ì‹œì§€ ë°°ë„ˆë§Œ ë„ìš°ê¸°
        state.chatUserNearBottom = nearBottom;

        const same = (oldIds.length === newIds.length) && oldIds.every((id,i)=>id===newIds[i]);
        if(same){
          if(nearBottom){
            // ë ˆì´ì•„ì›ƒ ë³€ê²½ìœ¼ë¡œ ë†’ì´ê°€ ë°”ë€ŒëŠ” ê²½ìš°ë¥¼ ìœ„í•´ í•œ ë²ˆ ë” ë³´ì •
            requestAnimationFrame(()=>{ try{ els.chatList.scrollTop = els.chatList.scrollHeight; }catch(e){} });
          }
          return;
        }

        // âœ… ì¼€ì´ìŠ¤ 1) ìµœì´ˆ/ë¹„ì •í˜• ë³€í™” â†’ ì „ì²´ ë Œë”(70ê°œë¼ ê°€ë²¼ì›€)
        if(oldIds.length === 0){
          renderChatFull(list);
          state.chatDisplayIds = newIds;
          // ì²« ë¡œë“œ(ì…ì¥ ì§í›„)ëŠ” í•­ìƒ ìµœì‹  ì±„íŒ…ì´ ë³´ì´ê²Œ
          requestAnimationFrame(()=>{ scrollChatToBottom(); hideChatNewBar(true); });
        }else{
          // âœ… ì¼€ì´ìŠ¤ 2) ë¦¬ìŠ¤íŠ¸ê°€ 1ê°œ ì¦ê°€(70 ë¯¸ë§Œì¼ ë•Œë§Œ ê°€ëŠ¥) â†’ ë§¨ ë’¤ append
          const canAppend = (newIds.length === oldIds.length + 1) && oldIds.every((id,i)=>id===newIds[i]);

          // âœ… ì¼€ì´ìŠ¤ 3) 70ê°œ ìœˆë„ìš°ê°€ 1ì¹¸ ë°€ë¦¼(ë§¨ ì• 1ê°œ ë¹ ì§€ê³  ë§¨ ë’¤ 1ê°œ ì¶”ê°€) â†’ DOM 1ê°œ ì œê±° + 1ê°œ ì¶”ê°€
          const canSlide =
            (oldIds.length === CHAT_MAX_VIEW) &&
            (newIds.length === CHAT_MAX_VIEW) &&
            (oldIds.slice(1).every((id,i)=>id===newIds[i]));

          if(canSlide){
            try{
              if(els.chatList.firstChild) els.chatList.removeChild(els.chatList.firstChild);
            }catch(e){}
            const m = list[list.length-1];
            els.chatList.appendChild(makeMsgNode(m));
            state.chatDisplayIds = newIds;
          }else if(canAppend){
            const m = list[list.length-1];
            els.chatList.appendChild(makeMsgNode(m));
            state.chatDisplayIds = newIds;
          }else{
            renderChatFull(list);
            state.chatDisplayIds = newIds;
          }
        }

        // âœ… DOM 70ê°œ ìœ ì§€(í˜¹ì‹œë‚˜ ë°©ì–´)
        try{
          while(els.chatList.children.length > CHAT_MAX_VIEW){
            els.chatList.removeChild(els.chatList.firstChild);
          }
        }catch(e){}

        if(nearBottom){
          hideChatNewBar(true);
          requestAnimationFrame(()=>{ try{ els.chatList.scrollTop = els.chatList.scrollHeight; }catch(e){} });
        }else{
          // ìƒˆ ë©”ì‹œì§€ ê°œìˆ˜ ëˆ„ì  í›„ ë°°ë„ˆ í‘œì‹œ
          try{
            const oldSet = new Set(oldIds || []);
            const addCount = newIds.filter(id=>!oldSet.has(id)).length;
            if(addCount > 0){
              state.chatUnseen = (Number(state.chatUnseen)||0) + addCount;
              showChatNewBar();
            }
          }catch(e){}
        }
      });
    }


// ===== SFX(ì…ì¥) : ëª¨ë‘ì—ê²Œ ë“¤ë¦¬ê²Œ(ì±„íŒ… ì»¬ë ‰ì…˜ì— 'sfx' ì´ë²¤íŠ¸ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸) =====
// âš ï¸ ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ë•Œë¬¸ì—, 'ì²« í´ë¦­/í‚¤ì…ë ¥' ì „ì—ëŠ” ì¬ìƒì´ ë§‰í ìˆ˜ ìˆì–´ìš”.
//    ê·¸ë˜ì„œ ë§‰íˆë©´ íì— ìŒ“ì•„ë‘ê³ , ì²« ì‚¬ìš©ì ì…ë ¥ì—ì„œ í•œ ë²ˆì— ì¬ìƒí•©ë‹ˆë‹¤.

const __ENTER_SFX_SRC = "data:audio/wav;base64,UklGRmiBAABXQVZFZm10IBIAAAABAAEAIlYAAESsAAACABAAAABmYWN0BAAAAJtAAABkYXRhNoEAAAoADAAIAAkACAAGAAcABwALAAkACAAIAAYAAgAEAAIABgADAAQABwADAAYACQAGAAQABQAGAAYACQALAAUACQAKAAQABAAFAAIABAAFAAEABQAGAAAA//8GAAcABQACAAIABQAEAAMABwADAAQABQAJAAkABAAEAAYACAAGAAMAAgAEAAMABgAMAAgABwAJAAkADAAMAAgACwAMAAkAAwAFAAUABQAEAAUABwAIAAoACgAKAAYACwAHAAsACQAIAAUACgAIAAUACwAHAAcABgAIAAcACAAKAAgACQAKAAoACwAPAAoACQAMAAoACgAMABEADQAPABEADAAQABIADgAJAAgADgAMAA4ADAAKAAsAEgAQAA0AEAATABEACgAPABIAEAATAA4AEQAQABEAFQANABEADAAJAA8AEgASAA8AEQASAA0AEQANABIAEwAPABIADgARABIADwAXABgAFAATABIAFQASABkAGgARABAAEQATABMAEQAWABYAGQAXABoAGwAbABoAFwAWABoAGAAaABYAFAAUABcAGgAZABwAGQAcABwAHAAWABYAGAAUABMAGAAYABQADwAWABcAFgAXABQAEgAVABMAFAAOABAAEAARABEAFQAVAAsAEQASABMAEAAPABIADQAOAAsADAAQABIADwAPABAADgAPAAoADAANABAADQASABEACQAQAA4ADgAPABEAEQALAAwABwAMAA0AEAAQAA0ADQAKAAsADgAKAAgADwAMAAoACwALAA4AEAALAAkACQAFAAkADAANAAwABQAMAA8ABwAJAAgACQALAA8ABwAKAA4ACAAKAAsACQAMAA0ACwAKAAcACwALAAsACQAFAAwADwANABIADAAKAAoAEQAMAAoACgAJAAsACQANAA8AFAAPAA0ACAAHAAwACQANAAwACgARAAsACgAKAAoACgANAA0ADAANAAwADwAKAAwAEQAKAA0ADAAKAA0ACgAMAAgABgAJAAgADQALAA8ADwASAA4ADAAOAA8ADwAMABEADwARABAAEAARABEAEAALAAsACgAIAAoACgAOAAgABQAKAAgACgAOAAsACgAIAAoABgAGAA0ACgAHAAkACAAIAAsADgAGAAUACAAGAAoABgACAAAABQAFAAgADAAIAAgABQAEAAUACAAGAAgABwABAAcACQAFAAcABAAJAAkABQAGAAQADAAEAAYACAAEAAgABQAFAAUACAAGAAUABwAHAAkACAAEAAMABQACAAIAAQADAAEA/f8DAAQAAgD//wYABQAEAAEAAAACAAQA//8AAAMAAAAAAAIAAgACAAEA//8GAAUABAACAAIAAAAAAAAAAwABAAQABQABAAQAAwABAAEABgAIAAQABQAEAAQAAQACAAIABwAIAAMABQAEAAMACAAHAAsABgAGAAUABgAEAAIAAgACAAcABAAEAAcADAAJAAgABAALAAoACAAJAAcACAAHAAgABgAKAAUAAgAEAAcAAwD8/wUABAAAAAkABgAGAAMAAgAEAAEAAgACAAcACAAEAAUACAAGAAcAAwAGAAQAAgAKAAQAAgABAAIABAACAAIABQACAAMAAAAGAAcABQAEAAcABwAIAAQABQAMAAQABgAGAAcAAgADAAEABAADAAQACAADAAkABAACAAQABQAEAAYABQAJAAgABgAIAAIA//8BAAMAAwACAAEAAgADAAUAAgABAAMABAADAAIAAgD+/wUABgAAAP7/AAAEAAQABAAIAAcAAgADAAMABwADAAQACAAJAAUAAQACAP3///8DAAQABQAHAAYACwAIAAcABgAGAAgACAAMAAoACgAJAAgABgAEAAQACQAFAAwACQAFAAoABQAEAAgABwAHAAQAAwAIAAcACAAGAAgABwADAAIABgAEAAMA//8DAAUABgAHAAUABAAEAAkAAgADAAAABAAFAAYAAwABAAIABAAAAP//AgAAAP/////+/wIABwACAAIAAwACAAIABQAAAAEAAwABAAEABAAAAAIAAgD+/wAAAgAEAAEAAQABAAYABwACAAIAAQD/////AAD8//7/+P/3/wAA///6//3/+////wAAAAAEAAAA/f/+///////+/wAAAgD+//z/AgADAAIAAQAEAAIAAwADAP//AAADAAgAAQAFAAIABQAHAAAABQAEAAEAAQABAAQABgACAAMAAwAGAAUACAAIAAgABgACAAcABwAGAAYABQAEAAcADAAJAAIABAADAAQAAgAHAAsABwAGAAYABwAMAAsABgAKAAsADQALAAoABgANAAoADAANAAoADAALAAsACgAMABAADQALAAkACAALAAoADAAMAAoACwAIAAsADAAMAAwACgAIAAgADQAUAA8ADwAOABIAEwARABQAEAASAAoACgANAAoADQAOABAAEQAOABIAEQASABAAFQAXABIAEQASAA8AEgAMAA8AFAAVABAADAASABEAEQAQABQAEQASABUAEgASABIAFAAQABEAGAATABQADgAVABUAEgARABAAEAAOABAADQAPABQADQALAAkAEQALAAgADQAOAAsADgAOAA8ADgAJAAsADQAJAAwADgAKAA8ACwAMAAsACwAMAAwADAAKAAgACAALAAsACgALAAUABwAJAA0ACQAJAAgACQAJAAcADgAJAAsACgAIAAQABgAGAAgADAAIAAMAAwAEAAEAAwACAAIAAgAFAAMAAgACAAUABAD+/wMAAwAEAAAABAACAAIAAgAIAAcACAAIAAgABwAJAAQACQAGAAcABwAIAAYAAwAGAAMADAAIAAgADAAJAAYACQAJAA4ACwAKAAoABwALAAgACAAIAAYAAwAFAAkACAAIAAwABwALAA0ACQAOAAkADwANAAcACQAIAAoABwAJAAgACAAHAAcACAAGAAUAAgAFAAMAAQAAAAIAAwAGAAkAAQAFAAcAAgD//wUACQAGAAUABAAGAAYABgAGAAMAAgADAAQABwAHAAcAAwAEAAMABwAHAAoACgAEAAIAAwADAAQABAAFAAcABQAEAAUABQAEAAUAAwAFAAQACQAHAAUABwAKAAsACAAHAAcACAAJAAYACgALAAcACAALAAoACQALAAcABwAKAAcAAgAKAAYABgAHAAcADAAIAAcABQACAAQACwAKAAwADAAKAAcACAAJAAkACgAFAAQACgAJAAYACAAJAAYABgAIAAcABgAIAAgABgAEAAwABgAGAAkABAAFAAgACgAEAAQACgAFAAQABwAHAAcABwAFAAIABAADAAcABAADAAUABgAIAAkADAAMAAgACwAPAAoADQAIAAYADQAPABIADgAMAAwACwAJAAoADAAMAA8ACQAKAAcABwALAAwADAAMAAYACQALAAoADQAJAAUAAgAJAAoABgAKAAgABgAGAAMABwAHAAYABwAFAAkABwAFAAQABAAHAAcACwAIAAYACQAHAAYACAALAAwACAAOAAoACQAIAA0ADQAHAAsACQALAAgACwAHAAYADAAIAAoACgAMAAwAEAAOAAwAFQALAA8ADwAMABEAEwAOAA0AEgANAA4ADgAJABMADwARAA0ACQAMAAoADwAQABIADAAIAAkAEAANAAsAEwAOAAwADgASABQADQAMAA0AEwANABAAEQALABEAFAASABEAEwAPABMAFAARAAkADwAQAAkAEAAMAAkAFAAQAAkABgANAAwAEAASAAoAEwAPAA0AEAASAA8ADQAKAA0ADQALAA8AEAAPAAsAEQANAAsADQAJAA4ADwAOAA0ADAAPABAAEAAQAAsADgAWABAADwANAAoABgAMAAcACgAJAAsADQAQABQAEQAQAA4ADAAKABEAEAAQAAoACwANAA0ACwAQABIADAALAA8ADAALAAsADwAOAA0ADgALAAoACQAOAA0ADgAGAAkAEgAQAAwAEAAQAAwADgARABEADAANAA0ADQALAAoABwAJAAUABAAMAAYAAwAJAAYADAAKAAgABQAEAAgABQAIAAcABwAGAAYACgAFAAQABAAKAAUABAALAAYACQAKAA8ADwAKAAkADAAJAAUABgAFAAsACQAJAAkACQAJAAwACgAJAAsABwAJAAgABgAJAA4ADgAMAAwAEAAPABIADgAQABQAEwARAAwAEQASAA8AEwAVABEAFQARABIAEAAUABMAEgAQABAAFgALAAwAEAARAA8AEgASAA0ADAANAA4ADwAUABQADQAPAA8AEQAUABMAEgATABIAEgATABIADwARAA8AEAAQAA4AEwAUABAACwAPAA4ADQARAAwAFwAOAA8AEwAUABUAEwARAA4AEQAOABQADAAOAA8ADwAQABAAEAALAA8ADAALABAADgAIAAkADgANAAsADgAOAA4ACwALAAoAEgASAA0ADQANABAAEQAMAA8ACQANAAsACQAUABAADgAKABAAEAAPAA0ADwAQABIACwAOABMADgAOAA0AFQAOAAoACQALAAwACAAMABAAEgARAA8AEQASABAAEgAPAAwADAAOAA4ADQAOAAYADAAKAA0ACwAMAAsACwAHAAoACQAFAAwACgANAA0ADwAPAA8AFwAPAAwADAAJAAwADAAKAAkACQAKAA0ADQANAAgACgAOAA4AEAAKAAsACAAPAA4ADAAMAAkACgAJABAAAwAIABEABwAGAA0ADQAKAAoABQAGAAUABAAHAAgABgAFAAcADAAPAAQAAwAEAAYABAAEAAQAAQABAAIABAAEAAEAAwAJAAsABgAFAAQABgAJAAUACAAKAAkADAAHAAoACgAFAAgACwAJAAcACQAKAAcACwALAAoACgAKAAwACQALAAsABwAJAAsACgAKAAsACwALAAoAEgARAAsACQAIAAwADQAJAAkACQANABEADAAKAAUACgANAAgADgAIAAcACwAJAAYABgAJAAQABAAIAAgACAAJAAoABwAHAAwACwANAAcADgAJAAUABgADAAcABwALAAkACgAJAAgABAADAAgACAAIAAkACQAKAA0ADwAKAAcACAAOAAgACQALAAkABgAIAA0ABwAMAAwACwAOAAcACgAKAAoACgAMABEACwALAAwACQAOABAADgAQAA8ADgARABAABgAIAAgABwANAA4ACgALAAsACgAKAAkACAAKAA4ADQASAAwADgAMAAgACgAKAA0ABwALAAkADAALAAUABQAFAAkACAAJAAQABgAKAAkACQAJAAsADgAJAAoACwAJAAsADgALAA0AEAAKAAwACgAMAAgACgALAAYACgAKAAwADAALAAkADAANAA0ADgAIAAoADgAOAA8ADAAJAAsACwAQABEAEAAPABEAEAAUABQADQAQABAADQASABMAEgAQAA4ADAAOABMAEQAVABMAEQARABEADAAOABMAFQATABMAEwAVABQAFgAUABEAEgAOABIAEgASABAAEwASABIAFAATABgAEAASABEAEwAQABAAEAAPAA4AGAAWAA8AEQAUABIADwAVABEAFAAPABQAFAATABYAFgAVABkAFgATABUAEgAYABYADAAPABIAEgATAA8ADgATABMAEgARABQAFAASAA8ADAATABEAEAASAAsADwASAA8ADQANAA8ADgAOAA8AFAAUABAADgAPABIAEgASABgAGAAQABIAEQATABQAEQATAA4AFQASAA4ACgAOAAkACgARAAwAEQAOAA0ADQASABIAFAATABMAEwARABUAEgAVABQADwATABAAEAAZAA8AEAAWABMAFAATABEAEQAWABQAFAAUABIAEAATABEADwASABQAFgAUABUAFAAPAAwADAAMABIAFQAPAA8AFAAUAA8AFAAUABUAFgASABoAFAASABUAFAARABQAFQAYABQA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JQAuADEAMAAvAC4AJwAjAB4AEgASABEAEwAUABgAHAAbABcAFwAeACAAGQAcAB4AHgAcABsAFwAYABwAGgAaABwAHQAcACYAJQAjACYAKAAoAB8AKgA0AC4AKgA0ADMALAAyADcANgA1ADgAOgA5ADoAPQA+AEAAQABBAEMAQgBDAEYARgBFAEYARwBFAEsARwBEAEQARQBDAEMARwBEAEgATQBNAEwASwBHAEoATQBKAE8ASwBNAFAATwBQAFEATQBLAFMAUwBQAFAAUQBUAFkAVgBUAFkAVQBVAF4AXABbAF8AXgBgAFwAXgBaAFsAWwBeAGUAXQBeAGUAZQBkAGYAagBjAGUAZgBkAGQAZQBoAGgAZwBpAGUAaABqAGYAaQBnAGYAbwBuAGwAaQBvAG0AbQBvAGwAbABvAGwAawBwAG0AcgBrAHEAcgBuAG4AbQBuAGsAcgB0AHEAcgB0AHAAcQBvAHMAbwBvAG4AdABxAG4AcABwAHQAcQBzAHoAcwBzAHUAdQB6AHcAcwB0AHkAeQB2AHcAdgB0AHYAdgBxAHAAdwB6AHUAcgB2AHgAcwB5AHoAeQB7AH0AfAB9AIEAeQB8AH0AewB9AHgAeQB6AHQAewB3AH4AfAB4AIIAhACDAH8AhAB/AIAAfQB7AHsAfwB+AHsAeQB9AH8AgACHAIIAgACGAIcAgwCDAIcAhwCJAIcAhQCFAIIAfQCAAIEAgACCAIkAhgB9AIIAhgCCAIIAhgCEAIUAhgCKAIkAjQCJAIwAjQCIAIsAjQCQAI8AjgCOAI8AigCOAJEAkACKAI4AjACOAJIAhwCOAJQAjQCLAJIAjwCIAI0AjQCLAI8AjACMAI0AjgCBAIoAkACQAIkAiwCOAIoAjgCRAI4AkQCSAIwAkwCUAJAAkACNAI4AkgCUAJMAjwCVAJUAiwCOAI4AkgCNAIwAjwCPAI0AjgCTAI0AlQCNAJIAlACTAJgAlgCVAJgAmQCXAJEAmgCYAI4AkgCYAJUAlgCeAJQAkwCbAJ4AlACXAJYAlgCTAJYAlQCOAJIAkgCZAJQAmwCXAJIAlACdAJEAjgCWAJMAlgCUAJMAlACZAJgAlQCRAJcAnQCYAJQAkgCZAJQAmACVAJQAlgCOAJIAlACVAJQAnACYAJIAlgCTAJUAkwCTAJgAmQCUAJAAlACUAJAAkQCLAJIAjgCOAJMAkACRAI0AkACPAJAAkQCSAJIAjgCVAI8AjQCMAI4AjgCNAJIAkACOAI4AigCNAI0AjQCPAJAAiwCTAJMAiwCRAI4AjQCLAI8AjACOAI4AiwCMAI0AkQCOAJEAjwCLAIsAiQCIAIoAjQCRAI4AiwCHAIYAigCNAIoAjgCPAJIAkACQAI4AjQCQAJAAkQCRAJIAjgCSAJMAkgCRAJEAkQCTAJAAkACQAJAAkACWAJAAlACPAJUAlwCTAJgAlgCZAJoAlwCWAJQAkQCVAJMAkACSAJQAjwCPAJIAkQCTAJQAlACWAJYAkgCRAJQAlACSAJEAkACSAJAAkACTAJEAlQCVAJYAkgCVAJUAjwCWAJQAkQCTAJMAlwCSAJMAlACVAJUAlACXAJUAlgCVAJQAkACSAJEAkgCTAJUAmQCYAJoAlQCRAJQAjwCSAJIAjgCTAJIAkgCMAIoAjgCMAIsAjgCSAI4AkACSAJIAlQCRAJEAkACQAJcAlQCRAJIAkACPAJEAkgCUAJEAjwCQAI8AkQCSAJAAkgCTAJIAkgCLAI4AkACTAI8AmQCUAJIAlwCWAJYAkwCWAI8AlQCXAJIAkACQAJEAlwCRAI8AlwCWAI8AjwCQAJEAkgCMAI0AkACSAJAAkgCRAIwAkgCRAJUAkwCRAJMAjgCTAJIAkwCTAJQAlACSAJEAkQCUAJEAkACQAI8AjgCMAI0AjwCQAI4AjQCSAJYAjgCQAI4AiwCPAI0AjQCMAJEAjgCRAI4AigCPAJEAkgCOAJEAjQCQAJQAkQCTAJAAjwCLAJUAmgCXAJAAkQCUAJMAlACTAJMAkgCRAI4AkQCPAJAAkQCQAIwAkwCZAJQAkQCRAJUAjwCQAI8AjgCTAJEAmACSAJMAlQCUAJgAmgCQAIsAkwCVAJEAlACSAI8AlACWAJYAkwCTAJAAlQCZAJQAkgCQAIkAigCMAJAAkwCUAJEAjwCVAI8AkgCMAI0AkwCSAJEAkACLAJEAlACTAI4AjgCWAJMAkgCRAI4AkgCRAIoAjgCRAI8AjgCMAIoAjACJAIkAigCLAIgAjQCMAI0AiACIAIgAhgCJAIMAiACEAIkAhwCFAIoAhQCBAIcAiwCEAIMAhACCAIEAggCBAIAAhACCAIIAgwCBAIEAgwB9AHwAfAB/AH8AfgB9AHgAfAB/AH0AewB7AHkAegB9AHsAcwB0AHsAfwB+AHMAegB5AHwAeQBzAHQAeQB1AG4AcQBrAHAAcABtAG8AbgBwAHQAcABsAGwAbQBwAHAAbgBsAG4AaQBqAG0AbABpAGkAbgBsAG0AaQBmAGUAZwBqAGwAbgBnAGYAcABsAGgAZgBlAGEAYgBhAGEAYwBfAFoAXABdAGAAYABcAFsAWgBdAF4AXABdAFwAWwBfAFoAWQBcAF8AWwBbAF4AYABcAF4AXQBZAF8AXgBaAFUAXABaAFoAWQBTAFoAVQBVAFgAWgBVAFoAVABTAFcAUwBWAFEAWgBeAFwAWgBUAFgAWwBWAFoAWQBXAF0AVwBWAFUAVwBVAFQAWwBQAFcAWABWAFkAVwBTAFMAVgBNAFAAUABSAFEATgBUAE4AUABRAEwAUQBSAFAAUgBQAFEAUwBJAEkATwBNAFAAUABRAE8ATgBNAE8ATQBNAFQATQBOAEoAUgBTAE0ATQBNAFEATABSAFIAUwBPAE0AUQBXAFQAUABRAFAAUABTAFQAUQBSAFIAVQBVAFUAUABUAFUATQBWAFAASwBQAFEAWABQAFAAUgBVAFQAVABWAFYAUwBUAFkAVQBVAFUAUwBVAFQAVgBWAFUAVwBXAFMAVgBUAFUAWABYAFsAVgBVAFYAUQBVAFYAWQBbAFYAVgBVAFEAVABYAFQAVABYAFQAVgBZAFkAUgBXAFMATABNAFIAVwBWAFUAVABTAFUAVABZAFcAVABQAE4AUABVAFcAVQBSAFMAVwBTAFkAUwBVAFYAVwBYAFUAVwBTAFIAUwBQAFQAVQBUAFIAUABVAFUAVwBZAFoAUgBZAFsAVwBdAFoAWQBWAFcAWABaAFkAVwBYAFoAYABZAFkAWgBbAFwAWABWAFcAXABcAFgAVwBYAFQAWABXAFIAWABXAFUAUQBPAFAAUgBTAE8ATwBUAFYAUwBQAFEAVABPAE4AUABTAFIATwBUAFIATgBSAFAATQBOAFIATwBPAEoATQBTAFQAUABPAFEASwBNAFIAUABOAFMAUABPAFYATgBRAE8AUwBTAE4AUQBOAE0ASQBPAE0ATgBQAFEAUgBKAEwATABQAEoATQBMAEwASwBEAEgASwBIAEoASQBKAEoARwBKAEoATwBMAEoASQBJAEwASgBIAEoASgBLAE4ASgBMAE4ATgBPAE0ASQBPAEkASwBOAEkARwBIAFAARwBMAE0ATABMAE8ASgBHAE0ASABIAEcARwBGAEsARQBEAEkARwBHAEMARgBHAEwASABMAEgASgBOAE4ATABOAEoASgBNAE8ATABMAEkASABIAE0ASQBHAEsASQBKAEQARwBIAEcASQBNAEkASwBGAEsASABFAEQASABMAEcASwBKAEwASgBHAE0ASgBOAE4ASQBQAE8AUgBMAEoASABIAEsATABKAEwASwBEAEUARwBHAEsARwBLAEYARQBJAEMARQBCAEIARgBEAEcARwBFAEQAQwBEAEMARABBAEQARQA/AEYAQgBDAEkAQgBAAEMAQABBAEIAPAA9AEYARQBFAEEAQABEAEAAQgBFAEIAQQBFAD8ASQBCAD4ASABIAEYAPgBDAEAAQgA/AEYARwBCAEIAPAA+AEAAQABAAD8APgBGAD4APwA/AD0APwA9AEMAPwA7AD0APQA7AD4AQAA4ADoAPAA5AD0APgBAADwANgA3ADMANAA0ADMANAAvADAAMQA0ADgALwAxADIAMAA1ADEANAA1ADYANQA0ADYANQA0AC0AMgA0ADQAMAAyAC0ALwAyADIAMwAzADIAMAAxAC4AMAAtADMAMwA0ADMAMQA4ADYAMQA0ADMAMwA0ADEAOQA1ADYAOQA3ADgAOQA3ADcANwA3ADkAOAA1ADUAOAA5ADEAOAA6ADQANAAzADEAMgA5ADIAMgAzADMALwAvADYALwAxADMAMgAzADQALwAvADMANQA4ADEAMgAzADIAMgA0ADAAJwAuADEALQAsADAAKgAsADMALAAwAC0AMAApAC4AMgAxADAALwAyADEALAAuADIALgAwADEALgAtACwAKwAqACwALwAqACcALgAuACgALQApACUAKgApACoALAAoACsAJwAmACcAIwAoACwAKAAqACsAKAAtAC4ALgAuACkAKAAmACoAMAAmACkALAArACoAKgAnACgAKgAqACYAKAAnACYAKgAnACgAJgAtACsAJQAqAC0AKQAvAC4ALAAlACUAKQAsACsAKQApACkALAAsACwALgArACcALAArACgAKgAmACkALQAoACoALAAmACkAKAAtAC0AKAArACUAJgAsAC4AJwAtAC4AKQArACoALQAnACkAMAAtACsAJwAmACgAKQAmACoAKQApADAALAAoACgALQAsACoAKAAvACUAIQAnACkAKAAqACYAKQArACkAKAAnACcAJwAoACYALAAoACgALAArACYAKQAmACcAIwAfACcAKwAkACEAIQAhACUAIgAkACEAIwAiACQAJAAgACUAJQAgAB4AIgAmACgAJwAgACgAKAAqACcAJQAjACcAKAAjACcAIwAkACIAJAAjACMAIgAkACcAJwAqACoAJwAmACgAIQAjACIAJwAoACYAKAAkACIAJgAnACgAJAAeAB8AJAAkACMAJQAlACEAIwAnACUAJQAnACoAIAAfACEAGwAgACAAHgAdAB0AGAAdAB8AHQAjACAAIgAdAB4AHQAfABgAHgAcACEAHwAbACEAHQAeABoAHgAeAB8AJAAjACYAIAAbAB8AIQAjABsAHQAeAB8AIgAgACEAHQAcAB4AGgAdACQAIQAfACAAHAAhABwAGwAdACEAHQAfAB4AIAAiACIAJAAeACQAIgAiACAAIQAgACAAHQAZACEAIAAnACUAHAAfACIAIAAfACgAIgAfACUAHwAkACYAJgAeACIAHwAeACEAHwAgAB8AIgAgAB4AIAAcACMAIAAdAB8AHgAgABYAHwAgAB4AGgAXABkAGwAcAB0AIgAcABsAHQAcAB0AFQAbABgAFgAaABkAHAAgABkAGQAZABwAHAAdABwAFwAgAB0AHwAaABoAHAAZABkAHAAZABoAHwAbABkAHAAfAB8AHQAfAB0AGgAgACEAHQAjACEAHwAfACAAGwAbAB0AGgAZABoAHgAbABgAHAAbABwAHwAcABwAGwAhAB0AGAAfABwAGgAcABwAHgAZABsAGAAcABgAGQAZABgAFwAUABoAFAAXABoAGQAZABcAFwAYABMAGwAYABsAFgAXABwAGwAfABwAGAAgABoAHAAdABkAHwAfAB8AHAAdABoAHwAfABsAIAAfACUAIQAlACEAGQAfACYAIwAhACYAIgAiACEAIwAhACEAJwAiACAAIgAgABwAGAAhAB4AHAAgAB0AHwAbABoAGwAfACAAGwAbABsAGgAdACAAFgAXACAAHgAcABkAHgAaABwAGAAaABYAEwAWABMAEAAOABAADQAMABIADAALABIAFAAPABAAEwASABMAEQAQABIAEAAPABMAEwAVABAADgARABIAFwARABMAFQAVABYAFQAWABYAFQARABIADwAQAA8AEAARAAwAEQATAA4AEAAOAA4ADgANAA0ACQAMAAoADAAOAAgABQAHAAYACgAGAAgACwALABUADAAMAA0ADwAMAAcADQAKAAgABgALAAoADAAJAAkACAAHAAkABAAJAA0ACgAFAAkADAAKAAgACAADAAQABwAIAAQABAAGAAkACgAIAAcABAAKAAoACAAIAAYABwAIAAoACwAJAAsACQAHAAcAAQAAAAcAAwABAAcABgAHAAUACAACAAYABwAFAAQAAQAJAAwAAQADAAgACgAIAAYADgAKAAwADwAHAAkACgAHAAwACwAEAAgACwAIAAsACAAHAAkABgAHAAEABAAEAAMACAAGAAwABwAIAAkACAAIAAMABwAIAAcABAAGAAgABAAEAAgAAwAGAA0ACgAGAAIAAAAGAAIACQAFAAYACQAHAAkABgANAAwACAAJAAwADAALAAkACgAQABEACwAOAA0ACwAMAAkACQAHAAYADAAQAAwADAAKAA0ADAALAAoACgANAA4AEAAQABAADwAOAA4AEAAMAA4AEQARAA0ADwANABMAEQAPAA4ADAAOAAgACQAHAAoADQAKAAkACwAOAA4AEQASABEADQANABIAFAAOAA8AEwARABIAEgATABQAEwATAA0AEwARAAwACgAOABcAEwASAA0AEwARABAAEQASABYAEwARABMAGQAYAA0AFAAUABMAGQAVABgAFwAXABYAEwAZABoAGgAWABQAEwAYABgAGQAcABQAFgAYABQAFAAYABcAGgAVABIAGQAZABcAFwAYABkAFgAYABsAFwAbABsAEgAZABcAGAAXABUAFAAbABoAFQAUABYAGAAWABoAFQAUABsAHQAZABMAGwAVABYAGQAZABcAHAAVABUAGQARABIAFAAVABIAGgAaABUAGQAbABwAHwAZABsAGAAcAB0AHgAeABwAIAAhACIAJgAdACEAGwAgACAAHgAhACEAGgAaABsAGgAcAB4AIwAjACAAHAAfACAAIQAeABsAGwAfACAAIgAfAB8AIgAhACQAIAAbACMAJgAiAB4AIAAhAB8AIgAdAB0AIgAgACQAHwAfACUAIgAeACIAIgAkACUAJAAhACIAIwAlACAAIAAgACAAIAAaAB0AIQAlACEAGgAdACAAIAAeACYAJgAkACIAIAAkACUAJgAlACIAJgAiACUAKAAnACYAJgAmACMAJAAkACUAIAAjAC0AKAArACgAKgAnACsAJwAlACsAKAAmACYAIwAjACgAIQAkACIAJwAlACYAJQAjACgAJgAmACcAKAAnACgAKgAnACMAJgAqACcAJQApACoAKQAkACIAJQApACcAKgApACkAKQApACYAJgApACcAJQAgACQAJwArACYAJwAsACMAJAAmAC0ALgAsADAAKQAqAC4ALAAuAC8ALgAuAC8AMgAqACwAMgAtACwAJwAsADEALgAvAC0AMQAtAC4AMAAsAC8AKwAmACgAJgAvADIAKwAoACcAKgArACgALQAtAC0ALQAsACwALQAtAC4AKwAlACYALQAyACkAJgApAC8ALAAkACYAKgAtACkAKQAqACkALgAtAC0AKwAqACYAJwApACcAIgAmACcAJAAmACUAJwAgAB8AIwAjACMAIQAhACQAJAAnACQAIwAlACIAIwAgACEAJQAhACUAIgAeAB8AIQAdABwAHQAhAB8AIwAjAB4AIgAZAB0AIgAhACEAHAAcABwAHAAZABoAGAAaABkAFQAYABcAHAAZABQAFwATABAAEgAUABYAGgAVABQAFAAUABUAFgATABUAFgAXABIAEQATABMAEwAUABAAEgAUABQAEAARABoAGQAWABUAEQAVABQAEgAYABYAFgAXABMAEQAQABQAFAASABUAFAAUAAwADwAQABAAEQATABIADAAMAA0AEwANAAsACQANABEADgAOABEAEQASABEAEAARAA4AEAARABAADgAOAAwADAAOAAwADgANAAsADAANAA8ADAANAAsADgAPAAsACwALAAoACgAOAA8ADAAOAAwAEgAMABIADgAJAA0AEQATABEAFQAOAA4ADAAUAAsADgAOAAsAEQARAA4ACgARAAwACwAOABIADQASAA4AEAASAA0AEwAPABMAGwAUABIADgATABIADgAOAA8AEgAMABUAEgAQAA8ADAAVAA4ADgAQABIAEAAUAA8AEgAOAA4ADQAKAA4ADAARAAwADQAKAA0ADAAQABMAEQAUABEAEgAOAA8AEwARAAwACgANAA4ADAAMAAsADQASABAAEgANAA4ADgALAAkACAAOAA8AEAAQABAADQASAA8ACQALAAwACgALABEADwASAA0ADwAOAA8ADwAQABAAEwARABEAEwAQABUADQAPABEADwAPAAoADgAQABAAFAAQAA0ADgALAA4ADAALAAoADwATAAwAEQAOABAADgARABQADgARABEADAAKAA8AEAAMABEACQAJAAoADQAIAAwADwANAA0ADAAOABAAEQARAAwADwASAA4ADgAKAAkACQAJAAsADQAHAAsADgARAA0ADAASABEAEQAPAAoAEAAOABIAEwAOAA8AFgAUABAAEwAYABIADwATABEAEgAUABIAFAAUABQAFgAUABgAFAAUABIAFAAOAA8AEQARABMADwAUABMAFAATAA8ADwARAA8AEQAOAA0ADAAOABUAEAATABQAFAASAA8AEAAVABkAEwASABYAGAAaABoAHgAcAB8AGgAcACAAHgAbABoAGAAXABoAHAAaABUAGQAbABgAFQAWABUAGAAWABUAEAAMABMAEAAOABAAEQAQABQAEwASABIAFAATABUAEAARAAsADgAXABAAFQASAAsADgAMAA4ADAAPAA4AEQASABEAFAANAA8AEgASABMAEAARABQADwATABQAEwASABEAEgARABMAEgAVAAwAEAAZABYADQARABcADQAVAAwADgASAAwACwAPABEADwANAA8AFAAUABgAFAASABUAFAAUABAADQASABQAFwAaABQAEQAQABQAFgAPABAAFgATAA4AEQARABUAFAAXABcAEwAWABUAEwAXABcAEwAUABoAHAAUABcAFwAVABkAGQAZABQAFwAbABYAFgAbABkAEgAVABoAGQAbABgAFgAbABcAGQAcABoAGgAdABcAGQAYABgAGAAXABQAGgAbABUAGQAWABoAEwAVABUAGAAZABsAGAAWABYAFwAYABkAGgAXABcAHAAaABYAGwAaABsAFgASABUAHwAbABoAHQAaABYAGAAZABoAHQAZABoAFQAcABYAFwAYABgAHgAdAB0AHwAeABsAHQAcABwAGgAaABoAFwAYAB8AGwAdABwAHgAeABwAHQAhACEAGAAbAB4AGwAbABsAGwAbAB0AIAAfAB0AGQAYAB0AGwAcABwAHgAaABgAHQAZABYAFgAYABsAHQAYABYAFQAcABYAGAAYABYAGAAYABgAGQAdABMAFwAaABcAFAAQABgAFQARABIAGQAYABEAGQAaABYAGAAUABMAEwATABMADwASABgADwATABQADwATABUAGAAWABUAEgAUABQAEgATABEAEAAaABEADgAUABIAEgASABIAEQAUABAAFAASAA0AFQASABMAFAAPABAAEAAVABAAEAAXABMAEAATABMAFgASABAAEQATABIAEAAVAA8ADAANAAwADwALAAwAEQANAA0AEgANAA0AEQARAAsAEAAXABQAEAARABIAEwAUABAAEAAQAA0AEAAUAA4AEgATABMAEAARAA8AFAASAA4ACwALABEACwAPAAwACgALAAsADQAKAAkABwALAA0ACgALAAgACAAKAAoADAAGAAYACgAIAAoADQAMAA4ABwAPAAsADgAJAAwACQACAAMAAQAAAP7/BQABAAMABQAEAAQAAQADAAYACgAEAAQACQAHAAkACQAJAAMABgAGAAUACQALAAgACgAMAAkACQAGAAkACQAIAAkABgAHAAgADAAJAAYABwAIAAcABwAGAAUACgAHAAsACAAIAAQAAAAFAAUAAQAGAAUACgADAAQABQAEAAcABwAGAAQACgABAP//AAACAAIA///+/wIABAACAAUABAAFAAUABgAHAA0ADQAIAAoABQAIAAQABgAJAAMABAADAAIAAAAFAAgAAgAJAAgABwAKAA8AEQAOAAoADAAMAAsADAANAAsACwALAA4AEgAPAA8AEQAPAA0ADgAJABAADQAMAA0ACQAPABAAEgAQAA4AFQAOAA0AEAARABIAEwATABQAEgASABMAEQAPABIAFQATAA8ADwAVABYAEwAQAA4AEwAUABMAEwATABYAEwAOAA0AFQAPAA4ADgAQABMADAAOAA4ADQAMAAsABwAHAAgABAAEAAoACQALAAoADQANAA0ADQALAA8ADAAMAAgACQAKAAsAEAAMABAADwAOABIADQAHAA4ADwANAA8ADgAKAA0AEAALABEADwAUAA4ACwANAAgABAAHAA4ADQANAAgABgAJAAsABwACAAMABQAJAAoACgANAA4ADwAPAAsACgAJABAAEAAOABEAEgAQAA8ADwAPABYAEQAPABIAEwANAA4AEAANAAkACQAQAA8ADAANABEAEgATAAkAEAAQAAwAEAANABAADgAPAAkABwAHAAcABgAFAAgABgABAAYACAAFAAgACgAKAAwACwAOAAoACgAKAAYABwALAAgABgAKAAwACgAJAAsACgAMAAsACAALAAwACwALAAoACwAJAA0AEAALAAoACAAPABAADQADAAkADAAMAAoACAAJAAcADQAJAAQACgAIAAYACQAFAA0ACwAIAAkACQANAAUABAANAAQABQAFAAoACwAKAAgABgAGAAUABwAEAAMABgAEAAkAAgABAAUACAAPAAsACQAHAAcADAAGAAQAAwAFAAQABwAFAAUABQADAAIABwAKAAgABwAGAAoACwAKAAsACgAKAAoADAARAAwACwAKAAoADwAMAAsACAALAAQAAwAHAAIAAQADAAsABgACAAgACQAFAAsACAAEAAQABAADAAAABQAHAAEAAwAHAAYABgAIAAsADAAHAAgACQAJAAcACQAJAAgADgAJAAcABwAHAAoACgAIAAkACgAQAAwABgAIAAkADAAJAAoACwALAAkACAAMAAwADAANAAoADwAMAAYACAAOAAwAEAAPABIAEQAMAAkACQAQAAgACgAJAAsACAAJAAsABwAIAAgACAAKAAwACgANAA8ADAAJAA0ADAANAAoADgALAAsAEAARAAwADgAPABEADwAPAA8ACAAOAAsACwANABEAFAANABEAEAAOABQAEwASABAAEAAOABQAFwARABEAEAAVABIAEAAPAA4AEgARAA8ADwARABcAEwASABIAEwAWABQAFQAVABYAFAATABIADgAQABUAFAATABEAEAASABUAFgAQAA4AFQAVABIAEgASABUAEgAOABAAEQAQABEAEgAYABcAFwARABIAFwAUABYAGAAUAA0ADgAUABQAEAAKABMAFAAUABYADwASABQAEQATABQAEQAOABYAFAALABEAEgAQAA8AEwAVABMAFQARABEAEgAZABkAEwATAA8AEQARABYAEgANAAkADAASAAsACgALAA0AEwARAAwAEAASAA8ACQAMAAQACQAOAAgACgALAAYABgAJAAcABAAHAAYABgAIAAUABwAFAAsABQAAAAEABQAFAAQABQABAAMA//8CAP7/AwACAAAABAAAAAAAAQAHAP//AQADAP3/AQD//wAAAQABAP//AgACAP///v/7//v//v/9//z//f////r//f///wAAAQAAAPz//P8DAP7/AAABAP7/+//9//j/+//6//j/+P/7//r/+//5//3//v8CAAEAAAD+//z/AAD6////AAABAPv//P/6//v//P/9//7//P/9/////P/7//7//v/9//r/+f/+////+v/5//v//f/9//n/+////////f///wMAAgACAP7//v8AAP//AAD8//7/AgD/////AAACAAEAAAADAAIABAADAAcAAQAAAAIAAwAEAAIABAACAAEAAwABAAEA/P8DAAUAAAD+//7/BAD9////AAAAAP////8AAPz//v/8//z//P/9//z/AQACAPv/AAABAAUAAwABAAMAAwAAAP//AAADAAAAAgACAPz/BAAHAAYA/v8AAAQAAgABAAEAAAABAAIA/v/9/wAAAAACAAAAAQACAP//BQAEAAcABgAFAAQAAwAFAAMAAwAFAAsABwADAAIABAAIAAUABgAFAAgABQADAAUAAgACAAQAAwAEAAIABQAEAAQACgAGAAkAAgAFAAUABgAJAAcACAAMAAoADgALAAUACgACAAUACAAFAAUADAAKAAcABwADAAkACQAHAAIABAAJAAoACQADAAUABwAFAAYABgAHAAgABwABAAcABAAFAAcABgAIAAUADAAGAAoABgAGAA0ACAAIAP7/BQAIAAoABgAGAAgACQAMAAgACAAFAAgABQAIAAwADAAKAAYADgALAAoADgALAAgACwAOAAcACgALAAoADAAHAA0ADgAOAAwACQAJAA4ACwAOAA4ACQANABEADwAHAAsADgAJAAsADAAQAA0ADAAPAAwAEAAKAA4ACwAMAAwADQALAAwAEAAKAAsADAARAA8ADwAKAAoADgAOAA8ADAAKAAwADQAMABMACwAKABEAEAAOAAwACgAKAAwACAAKAAgAAwAFAAcABgAEAAcACwAHAAkADQAKAAwABgAKAAkADAAMAAoACQAIAAgABwAKAAkABgAEAAQABwAKAAsADQAHAAwACAANAAsACQALAAoACAAKAAgABgAOAAwACAALABEACgAPAAsADAAMAAkADgANAA8AEQARABIAEQAQAA8ADQAQABAAFQAUAA0AFAAWABQAFAAVABQAEwAVABUAFQAXABQAFgAZABIAEAATABAAFAATABEAEgAQAA0AEwATABcAFwATABgAFQAYABcAFQATABQAFAARAA8AEgARABEAFAAXABMADQASABAAEAANABAAFAASABEACgAMABIADgAOABUAFAAQAA0AEgAUAA8AEgARABIAFAAOABEAEgATAA8ADAARABIAEgATABMAFAAUABMAEwARABEADQATAAwADgAQABAAEAAKAA4AEAARAAsADAAQAAoAEAANABEADQANAA4ADwASAAwADgASAA8AEwAVAA4ADwAIAAsACgAKAAYADAALAA0AFAAPAA4ACwAPABIAEwAMAAgADQANAAkAEAAKAAUADgANAAYAEAAVAAoADAAOAA4ADgAJAAsADAASABUADAAJAAoADQAKAAsAEQAIAA4ADwAOABEACwALAAwACQAMABEACQAGAAUABgAJAAsACwAHAAoABgAFAAkACQALAAoADAAJAAkACQALAAoACgAPAAsABgAHAA8ADwALAAsACgAMAAgABwAKAAkACAANAAsAAgAMAA4ACQAIAAwAEQANAAsACwAOAAwACwAQAAkABgAKAAcACgAQAAkADAAKAA4ACgAMABQACwALABAAEgAPABUAEwAJAAsACQAJAAoADAAIAAoADQAMABEADwAOABAACwALABEADwAHAAkAEAAQAAsADgAVAA4AEAANABAADQAMABEADgAJABIAEgALAAoADgAKABAAEwAMABgAFQASABAAEwATABEAEAAVABUAEAASABsAGAASABMAGAASABQAFQAUAA4AEAAbABgAGQAWABkAHAAWABcAGQATABQAEgAVABIAEAARABAADwAUABUAFAAXABIAEwARABYAEwASABEAEQAYABAADQARABAAEAALAAwADQARABEADwAPAAcADgAMAA0ACgAHAAkACwAMAAcACQAIAAgABwALAAkABwAFAAUABgAFAAYABwAEAAYACQAJAAgACgAHAAYACQAGAAQABwAHAAgACgAHAAsACwAMAAoABgAKABAADQAJAAoACwANAAsACgAFAAUABwAMAAoACwAJAAgACwALAAsACQAJAAUABgAHAAgABgAJAAcABwAJAAwADgAEAAoADAAMAAwACQAMAA==";

let __audioUnlocked = false;
let __pendingSfx = [];
let __soundHinted = false;
let __enterAudioProto = null;

function __getEnterAudio(){
  try{
    if(!__enterAudioProto){
      __enterAudioProto = new Audio(__ENTER_SFX_SRC);
      __enterAudioProto.preload = "auto";
      __enterAudioProto.volume = 0.90;
    }
    const a = __enterAudioProto.cloneNode(true);
    a.volume = __enterAudioProto.volume;
    return a;
  }catch(e){
    return null;
  }
}

function __playEnterSfx(){
  const a = __getEnterAudio();
  if(!a) return Promise.reject(new Error("audio init failed"));
  try{ a.currentTime = 0; }catch(e){}
  return a.play();
}

function playSfx(kind){
  // í‡´ì¥ ì†Œë¦¬ëŠ” ì œê±°: enterë§Œ ì¬ìƒ
  if(kind !== "enter") return;

  // ìë™ ì¬ìƒ ì œí•œ ìƒíƒœë©´: íì— ìŒ“ì•„ë‘ê³ , ì‚¬ìš©ìì—ê²Œ "í•œ ë²ˆ í´ë¦­" ì•ˆë‚´
  if(!__audioUnlocked){
    __pendingSfx.push("enter");
    if(!__soundHinted){
      __soundHinted = true;
      try{ showToast("ğŸ”ˆ ì‚¬ìš´ë“œë¥¼ ì¼œë ¤ë©´ í™”ë©´ì„ í•œ ë²ˆ í´ë¦­í•´ì¤˜!", 2600); }catch(e){}
    }
    return;
  }

  __playEnterSfx().catch(()=>{
    // í˜¹ì‹œ ë˜ ë§‰íˆë©´ ë‹¤ì‹œ íë¡œ
    __audioUnlocked = false;
    __pendingSfx.push("enter");
  });
}

// âœ… ìë™ ì¬ìƒ ì œí•œ ëŒ€ë¹„: ì²« ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì˜¤ë””ì˜¤ í™œì„±í™” + ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš´ë“œ ì¬ìƒ
(function __wireAudioUnlock(){
  const unlock = ()=>{
    if(__audioUnlocked) return;
    __audioUnlocked = true;

    const q = __pendingSfx.slice(-3);
    __pendingSfx = [];
    q.forEach(()=>{
      __playEnterSfx().catch(()=>{});
    });
  };
  window.addEventListener("pointerdown", unlock);
  window.addEventListener("keydown", unlock);
  window.addEventListener("touchstart", unlock, {passive:true});
})();

async function emitSfx(kind){
  // í‡´ì¥ ì†Œë¦¬ ì œê±°: enterë§Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  if(kind !== "enter") return;
  try{
    if(!state.roomId) return;
    await addDoc(chatCol(state.roomId), {
      type: "sfx",
      kind: "enter",
      tsMs: Date.now(),
      uid: state.uid || "",
      name: state.nickname || (els.name ? (els.name.value||"").trim() : "")
    });
  }catch(e){}
}




    // âœ… ì¤‘ë³µ ì „ì†¡ ë°©ì§€(Enter/Click ë“± ì´ë²¤íŠ¸ê°€ ê²¹ì¹  ë•Œ)
    let __chatLastSig = "";
    let __chatLastAt = 0;
    function __chatSig(text){
      return `${state.roomId||""}|${state.uid||""}|${String(text||"")}`;
    }

    async function sendChat(){
      const text = (els.chatInput.value || "").trim();
      if(!text) return;

      // âœ… ê°™ì€ ë‚´ìš©ì´ ì•„ì£¼ ì§§ì€ ì‹œê°„ ì•ˆì— 2ë²ˆ íŠ¸ë¦¬ê±°ë˜ë©´(Enter+click / IME / ëª¨ë°”ì¼) 1ë²ˆë§Œ ì „ì†¡
      const __now = Date.now();
      const __sig = __chatSig(text);
      if(__sig === __chatLastSig && (__now - __chatLastAt) < 800){
        return;
      }
      __chatLastSig = __sig;
      __chatLastAt = __now;

      // âœ… ì „ì†¡ ì¤‘ì´ë©´ ëŒ€ê¸°ì—´ë¡œ (ì±„íŒ… ì”¹í˜ ë°©ì§€)
      if(__chatSending){
        queueChat(text);
        els.chatInput.value = "";
        /* ì „ì†¡ ëŒ€ê¸°ì—´ í† ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        return;
      }

      const ok = await sendChatCore(text);
      if(ok){
        els.chatInput.value = "";
        try{ els.chatList.scrollTop = els.chatList.scrollHeight; }catch(e){}
      }else{
        // ì‹¤íŒ¨ ì‹œ ì…ë ¥ê°’ì€ ë³´ì¡´ (ì‚¬ìš©ìê°€ ê·¸ëŒ€ë¡œ ì¬ì „ì†¡ ê°€ëŠ¥)
        els.chatInput.value = text;
      }
    }

    // âœ… ì±„íŒ… ì „ì†¡ ìµœì í™”: ëŒ€ê¸°ì—´ + ìˆœì°¨ í”ŒëŸ¬ì‹œ
    let __chatSending = false;
    function chatQueueKey(){
      return `mkm_pending_chat:${state.roomId||"room"}:${state.uid||"anon"}`;
    }
    function loadChatQueue(){
      try{
        const raw = localStorage.getItem(chatQueueKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveChatQueue(arr){
      try{ localStorage.setItem(chatQueueKey(), JSON.stringify(arr.slice(-20))); }catch(e){}
    }
    function queueChat(text){
      const q = loadChatQueue();
      q.push({ text: String(text).slice(0,500), clientTsMs: Date.now() });
      saveChatQueue(q);
    }

    async function flushChatQueue(){
      if(__chatSending) return;
      const q = loadChatQueue();
      if(!q.length) return;

      // ìˆœì°¨ ì „ì†¡
      for(let i=0;i<q.length;i++){
        const item = q[i];
        const ok = await sendChatCore(item.text, true);
        if(!ok){
          // ì‹¤íŒ¨í•˜ë©´ ë‚¨ì€ ê²ƒ í¬í•¨í•´ì„œ ë‹¤ì‹œ ì €ì¥í•˜ê³  ì¤‘ë‹¨
          saveChatQueue(q.slice(i));
          return;
        }
      }
      // ì „ë¶€ ì„±ê³µ
      saveChatQueue([]);
    }

    // âœ… ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ ëŒ€ê¸°ì—´ ì¬ì „ì†¡(í•œ ë²ˆë§Œ ë“±ë¡)
    window.addEventListener("online", ()=>{ try{ flushChatQueue(); }catch(e){} });

    async function sendChatCore(text, isFlush=false){
      __chatSending = true;
      try{
        // ë²„íŠ¼ì€ ì ê¹ë§Œ ì ê·¸ê³ , ì…ë ¥ì€ IME ë•Œë¬¸ì— ê³„ì† ì—´ì–´ë‘ 
        els.sendBtn.disabled = true;

        // ë‚´ í”„ë¡œí•„ ì´ë¦„ í™•ë³´
        let myName = (els.name.value || "").trim();
        try{
          const meSnap = await getDoc(meRef(state.roomId, state.uid));
          if(meSnap.exists()) myName = normalizeNick(meSnap.data().name || myName);
        }catch(e){}

        await addDoc(chatCol(state.roomId), {
          uid: state.uid,
          name: myName,
          text: String(text).slice(0,500),
          tsMs: Date.now(),
          kind: "chat"
        });

        // ì„±ê³µí•˜ë©´ ëŒ€ê¸°ì—´ë„ ì¦‰ì‹œ í”ŒëŸ¬ì‹œ
        if(!isFlush) setTimeout(()=>{ try{ flushChatQueue(); }catch(e){} }, 0);

        return true;
      }catch(err){
        console.error("sendChat error", err);
        // ì‹¤íŒ¨í•˜ë©´ ëŒ€ê¸°ì—´ì— ë„£ê³  ì•ˆë‚´
        if(!isFlush) queueChat(text);
        showToast("ì „ì†¡ ì‹¤íŒ¨â€¦ ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ í™•ì¸! (ëŒ€ê¸°ì—´ì— ì €ì¥í–ˆì–´)");
        return false;
      }finally{
        __chatSending = false;
        try{ els.sendBtn.disabled = false; }catch(e){}
      }
    }

    // Tiles
    function statusBadge(p){
      const online = isOnline(p.lastSeenAtMs);
      if(!online) return { text: "offline", cls: "bOff", emoji:"ğŸ«¥" };
      if(p.status === "work")  return { text:"Work", cls:"bWork recBadge", emoji:"" };
      if(p.status === "break") return { text:"íœ´ì‹ì¤‘", cls:"bBreak", emoji:"â˜•" };
      return { text:"ìë¦¬ë¹„ì›€", cls:"bIdle", emoji:"ğŸŒ™" };
    }
    function tileKey(p){
      return JSON.stringify({
        name:p.name, status:p.status, total:p.totalSecondsToday, started:p.sessionStartedAtMs,
        bubble:p.bubbleText, emo:p.theme?.emoji, emoBg:p.theme?.emojiBg, emoSize:p.theme?.emojiSize, photoSize:p.theme?.photoSize, bg:p.theme?.bgColor, bubbleColor:p.theme?.bubbleColor, pat:(p.theme?.pattern||p.theme?.bgPattern), patColor:p.theme?.patternColor, photo:p.theme?.photoUrl,
        online:isOnline(p.lastSeenAtMs)
      });
    }
    function renderTile(p){
      const key = tileKey(p);
      const prev = state.lastRendered.get(p.id);
      if(prev && prev.key === key && prev.el) return prev.el;

      const t = document.createElement("div");
      t.className = "tile";
      t.dataset.uid = String(p?.id || "");
      t.dataset.name = normalizeNick(p?.name || p?.id || "");
      // ìš°í´ë¦­ ë©”ë‰´(ê°•í‡´)
      t.addEventListener("contextmenu", (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        openCtxMenu(ev.clientX, ev.clientY, p);
      });

      const bg = document.createElement("div");
      bg.className = "bg";
      bg.style.background = bgStyle(p.theme?.bgColor || "#ffd0e2", (p.theme?.pattern || p.theme?.bgPattern || "none"), (p.theme?.patternColor || p.theme?.patColor || "#ffffff"));
      // pattern sizing tweaks
      if(((p.theme?.pattern||p.theme?.bgPattern||"")) === "dots"){ bg.style.backgroundSize = "22px 22px, 22px 22px, auto"; }
      if(((p.theme?.pattern||p.theme?.bgPattern||"")) === "grid"){ bg.style.backgroundSize = "18px 18px, 18px 18px, auto"; }
      if(((p.theme?.pattern||p.theme?.bgPattern||"")) === "stripes"){ bg.style.backgroundSize = "auto, auto"; }
      if(((p.theme?.pattern||p.theme?.bgPattern||"")) === "hearts"){ bg.style.backgroundRepeat = "repeat, no-repeat"; bg.style.backgroundSize = "36px 36px, auto"; }

      const shade = document.createElement("div");
      shade.className = "shade";

      const content = document.createElement("div");
      content.className = "content";

      const statusBar = document.createElement("div");
      statusBar.className = "statusBar";

      const statusLeft = document.createElement("div");
      statusLeft.className = "statusLeft";

      const statusRight = document.createElement("div");
      statusRight.className = "statusRight";

      const badge = statusBadge(p);
      const b = document.createElement("div");
      b.className = `badge ${badge.cls}`;
      const isRec = (badge.cls || "").includes("recBadge");
      const iconCls = (isRec) ? "" : (badge.text==="íœ´ì‹ì¤‘") ? "stBreak" : (badge.text==="ìë¦¬ë¹„ì›€") ? "stIdle" : "";
      b.innerHTML = isRec ? `<span class="recDot"></span><span style="font-weight:1100;">Work</span>` : `<span class="stIcon ${iconCls}">${badge.emoji}</span><span>${badge.text}</span>`;

      const namePill = document.createElement("div");
      namePill.className = "namePill";
      const _fullName = normalizeNick(p.name || p.id);
      const _miniName = miniNick(_fullName);
      const _nameFull = document.createElement("span");
      _nameFull.className = "nameFull";
      _nameFull.textContent = shortNick(_fullName, 4);
      namePill.title = _fullName;
      const _nameMini = document.createElement("span");
      _nameMini.className = "nameMini";
      _nameMini.textContent = _miniName;
      namePill.appendChild(_nameFull);
      namePill.appendChild(_nameMini);
      const nameAccent = clampHexColor(p.theme?.bubbleColor || p.theme?.bgColor || "#ffd0e2");
      namePill.style.background = hexToRgba(nameAccent, 0.22);
      namePill.style.borderColor = hexToRgba(nameAccent,0.55);

      statusLeft.appendChild(b);
      statusLeft.appendChild(namePill);

      const medal = document.createElement("div");
      medal.className = "missionMedal hidden";
      medal.textContent = "ğŸ‘‘";
      statusLeft.appendChild(medal);
      updateMissionMedalForTile(medal, p);

      // ì˜¤ë¥¸ìª½ ì˜ì—­(ì¶”í›„ ë°°ì§€/ì•„ì´ì½˜ í™•ì¥ìš©)
      statusRight.appendChild(document.createElement("div"));

      statusBar.appendChild(statusLeft);
      statusBar.appendChild(statusRight);// tile sizes (emoji/photo)
const emoSize = 82;
const photoSize = 82;
t.style.setProperty("--emoSize", emoSize + "px");
t.style.setProperty("--photoSize", photoSize + "px");

const avatar = document.createElement("div");
avatar.className = "avatar";
avatar.textContent = (p.theme?.emoji || "âœï¸");

const emoBg = clampHexColor(p.theme?.emojiBg || "#2b2b2b");
t.style.setProperty("--emoBg", emoBg);
avatar.style.background = emoBg;
avatar.style.borderColor = hexToRgba(emoBg, 0.95);

const idPhoto = document.createElement("div");
idPhoto.className = "idPhoto";
const photoUrl = (p.theme?.photoUrl || "").trim();
if(photoUrl){
  const img = document.createElement("img");
  img.src = photoUrl;
  img.loading = "lazy";
  img.onerror = ()=>{ idPhoto.textContent = "ì‚¬ì§„"; };
  idPhoto.appendChild(img);
}else{
  idPhoto.textContent = "ì‚¬ì§„";
}

const timer = document.createElement("div");
timer.className = "bigTimer";
      const isMeTile = (p && p.id && state.uid) ? (p.id === state.uid) : false;
timer.innerHTML = `<span class="time">--:--:--</span>` + `<button class="missionBtn" type="button" data-owner="${escapeHtml(p.id||'')}" data-name="${escapeHtml(normalizeNick(p.name||p.id||''))}" data-me="${isMeTile?'1':'0'}" title="ì˜¤ëŠ˜ì˜ ë¯¸ì…˜" aria-label="ì˜¤ëŠ˜ì˜ ë¯¸ì…˜"></button>`;
      const mbtn = timer.querySelector(".missionBtn");
      if(mbtn) updateMissionBtnForTile(mbtn, p);


const bubble = document.createElement("div");
bubble.className = "bubble";
const bubbleAccent = clampHexColor(p.theme?.bubbleColor || p.theme?.bgColor || "#ffd0e2");
bubble.style.background = hexToRgba(bubbleAccent, 0.34);
bubble.style.borderColor = hexToRgba(bubbleAccent, 0.70);
const bubbleText = (p.bubbleText || "").trim().slice(0,15);
if(bubbleText){
  bubble.textContent = bubbleText;
}else{
  bubble.textContent = "â€¦";
  bubble.classList.add("muted");
}

const bottomStack = document.createElement("div");
bottomStack.className = "bottomStack";

const mediaRow = document.createElement("div");
mediaRow.className = "mediaRow";
mediaRow.appendChild(avatar);
mediaRow.appendChild(idPhoto);

bottomStack.appendChild(bubble);
bottomStack.appendChild(mediaRow);

content.appendChild(statusBar);
content.appendChild(timer);
content.appendChild(bottomStack);
t.appendChild(bg);
      t.appendChild(shade);
      t.appendChild(content);

      state.lastRendered.set(p.id, { key, el: t });
      return t;
    }
    function updateTimersLive(){
      for(const [uid, rec] of state.lastRendered.entries()){
        const p = state.currentParticipants.get(uid);
        if(!p || !rec.el) continue;
        const timeEl = rec.el.querySelector(".time");
        if(!timeEl) continue;
        const __disp = computeDisplayedTotal(p);
        timeEl.textContent = fmtHMS(__disp);
        // âœ… ë¡œì»¬(ë¸Œë¼ìš°ì €) "ì˜¤ëŠ˜ ì‘ì—…ì‹œê°„" 24h ëˆ„ì  ì €ì¥ (íƒ€ì´ë¨¸ê°€ ì‹¤ì œë¡œ ë„ëŠ” ì§€ì ì—ì„œ í™•ì‹¤íˆ ì €ì¥)
        try{
          if(p.id === state.uid){
            const s = Math.max(0, Math.floor(Number(__disp)||0));
            const nowMs = Date.now();
            if(!state.__lastFocusPersistAtMs || (nowMs - state.__lastFocusPersistAtMs) > 15000 || Math.abs((state.__lastFocusPersistSec||0) - s) >= 3){
              state.__lastFocusPersistAtMs = nowMs;
              state.__lastFocusPersistSec = s;
              focusSaveSeconds(s);
            }
          }
        }catch(e){}

        // time color: work = user color, break/idle = fixed grey
        const tc = clampHexColor(p.theme?.timeColor || "#ffffff");
        timeEl.style.color = (p.status==="work") ? tc : "#9aa0a6";
      }
    }


    // Compact mode: on very small windows, replace tiles with a fast roster list (ìš”ì²­ 7)
    const COMPACT_W = 560; // px

    // âœ… ë·°í¬íŠ¸ í­ì„ ë” ì•ˆì •ì ìœ¼ë¡œ ê³„ì‚°(ì´ˆê¸° ë¡œë”© ì‹œ innerWidth=0 ì¼€ì´ìŠ¤ ë°©ì–´)
    function getViewportW(){
      try{
        const w1 = (window.innerWidth || 0);
        const w2 = (document.documentElement && document.documentElement.clientWidth) ? document.documentElement.clientWidth : 0;
        return Math.max(w1, w2);
      }catch(e){
        return (window.innerWidth || 0);
      }
    }

    function isCompactNow(){
      const w = getViewportW();
      if(!w) return false; // 0ì´ë©´ compactë¡œ ì˜¤íŒí•˜ì§€ ì•Šê¸°
      return w <= COMPACT_W;
    }

    function applyCompactMode(force){
      const compact = (typeof force === "boolean") ? force : isCompactNow();
      document.body.classList.toggle("compact", compact);
      return compact;
    }

    function renderStatusRoster(onlineArr){
      if(!els.statusRosterList) return;
      els.statusRosterList.innerHTML = "";
      for(const p of onlineArr){
        const item = document.createElement("div");
        item.className = "statusRosterItem";

        const left = document.createElement("div");
        left.className = "statusRosterLeft";

        const emo = document.createElement("div");
        emo.className = "statusRosterEmoji";
        emo.textContent = (p.theme?.emoji || "ğŸ™‚");
        const eb = clampHexColor(p.theme?.emojiBg || "#2b2b2b");
        emo.style.background = eb;
        emo.style.borderColor = hexToRgba("#ffffff", 0.16);

        const nm = document.createElement("div");
        nm.className = "statusRosterName";
        nm.textContent = p.name || p.id;

        left.appendChild(emo);
        left.appendChild(nm);

        const st = document.createElement("div");
        st.className = "statusRosterStatus";
        const bd = statusBadge(p);
        st.textContent = `${bd.emoji} ${bd.text}`;

        item.appendChild(left);
        item.appendChild(st);
        els.statusRosterList.appendChild(item);
      }
    }

    function renderCompactRoster(onlineArr){
      if(!els.grid) return;
      els.grid.innerHTML = "";

      const wrap = document.createElement("div");
      wrap.className = "gridRosterWrap";

      const title = document.createElement("div");
      title.className = "gridRosterTitle";
      title.textContent = `ğŸ‘¥ ì ‘ì†ì ëª©ë¡ (${onlineArr.length})`;

      const list = document.createElement("div");
      list.className = "gridRosterList";

      for(const p of onlineArr){
        const item = document.createElement("div");
        item.className = "gridRosterItem";

        const left = document.createElement("div");
        left.className = "gridRosterLeft";

        const emoji = document.createElement("div");
        emoji.className = "gridRosterEmoji";
        emoji.textContent = (p.theme?.emoji || "âœï¸");
        const emoBg = clampHexColor(p.theme?.emojiBg || "#2b2b2b");
        emoji.style.background = hexToRgba(emoBg, 0.18);
        emoji.style.borderColor = hexToRgba(emoBg, 0.40);

        const nm = document.createElement("div");
        nm.className = "gridRosterName";
        nm.textContent = (p.name || "ìµëª…");

        left.appendChild(emoji);
        left.appendChild(nm);

        const st = document.createElement("div");
        st.className = "gridRosterStatus";
        const s = (p.status || "idle");
        st.textContent = (s==="work") ? "âœï¸ ì‘ì—…ì¤‘" : (s==="break") ? "â˜• íœ´ì‹ì¤‘" : (s==="idle") ? "ğŸŒ™ ìë¦¬ë¹„ì›€" : "â€”";

        item.appendChild(left);
        item.appendChild(st);

        // ìš°í´ë¦­(ê°•í‡´ ë©”ë‰´)
        item.addEventListener("contextmenu", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          openCtxMenu(ev.clientX, ev.clientY, p);
        });

        list.appendChild(item);
      }

      wrap.appendChild(title);
      wrap.appendChild(list);
      els.grid.appendChild(wrap);
    }

    function renderGridTilesOrRoster(onlineArr){
      if(!els.grid) return;
      const compact = applyCompactMode();
      if(compact){
        // âœ… compactì—ì„œëŠ” ë©”ì¸(íƒ€ì¼/ì ‘ì†ì ëª©ë¡) ë Œë”ë¡œ ë ˆì´ì•„ì›ƒì´ ë¬´ë„ˆì§€ëŠ” ê±¸ ë°©ì§€í•˜ê³ ,
        //    ì±„íŒ…(ì‚¬ì´ë“œë°”)ë§Œ ë‚¨ê¸°ëŠ” ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.
        els.grid.innerHTML = "";
        return;
      }

      // normal tiles
      els.grid.innerHTML = "";
      for(const p of onlineArr){
        try{
          const t = renderTile(p);
          if(t) els.grid.appendChild(t);
        }catch(err){
          console.warn("[tile] renderTile failed, fallback tile used:", err);
          // âœ… ë Œë” ì‹¤íŒ¨í•´ë„ ì „ì²´ê°€ ë¹„ì§€ ì•Šë„ë¡ ì•ˆì „ íƒ€ì¼
          const fallback = document.createElement("div");
          fallback.className = "tile";
          const bg = document.createElement("div");
          bg.className = "bg";
          bg.style.background = "linear-gradient(135deg, rgba(255,182,214,.35), rgba(255,119,184,.25))";
          const inner = document.createElement("div");
          inner.className = "inner";
          const top = document.createElement("div");
          top.className = "top";
          const status = document.createElement("div");
          status.className = "status";
          status.textContent = "âš ï¸";
          const name = document.createElement("div");
          name.className = "name";
          name.textContent = (p?.name || p?.id || "unknown");
          top.appendChild(status);
          top.appendChild(name);
          inner.appendChild(top);
          fallback.appendChild(bg);
          fallback.appendChild(inner);
          els.grid.appendChild(fallback);
        }
      }
    }

    // Join / Leave
    async function subscribeParticipants(){
      if(state.unsubParticipants) state.unsubParticipants();
      state.unsubParticipants = safeOnSnapshot(participantsCol(state.roomId), (qs)=>{
        const arr = [];
        const map = new Map();
        qs.forEach(d=>{
          const data = d.data();
          const p = { id:d.id, ...data };
          arr.push(p);
          map.set(p.id, p);
        });
        state.currentParticipants = map;
        syncMyStatusUI();

        // âœ… (ì¤‘ìš”) "ì˜¤ëŠ˜ ì‘ì—…ì‹œê°„" ë¡œì»¬ ëˆ„ì  ë³µêµ¬/ë™ê¸°í™” (ë¸Œë¼ìš°ì € ê¸°ì¤€)
        // - íƒ­ ì¢…ë£Œ/ì¬ì…ì¥/í‡´ì¥ í›„ ì¬ì…ì¥ì—ì„œë„ ë¡œì»¬ ëˆ„ì ì´ ìœ ì§€ë˜ë„ë¡
        try{
          if(!state.didFocusMerge && state.uid){
            const meNow = map.get(state.uid);
            if(meNow){
              const today = seoulDateKey();
              const localSec = Math.floor(Number(focusLoadSeconds()||0));
              let remoteSec = 0;
              try{ remoteSec = Math.floor(Number(computeDisplayedTotal(meNow)||0)); }catch(e){ remoteSec = Math.floor(Number(meNow.totalSecondsToday||0)); }
              const merged = Math.max(localSec, remoteSec);

              if(merged !== localSec) focusSaveSeconds(merged);

              // ë¬¸ì„œê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš°(íƒ­ ì¢…ë£Œ) / ìƒˆë¡œ ìƒì„±ëœ ê²½ìš°(í‡´ì¥) ëª¨ë‘: ê°’ë§Œ ì •ë¦¬ + íœ´ì‹ì¤‘ ì‹œì‘
              const needsRemotePatch =
                (Math.floor(Number(meNow.totalSecondsToday||0)) !== merged) ||
                (meNow.sessionStartedAtMs != null) ||
                ((meNow.status||"break") !== "break") ||
                ((meNow.dateKey||today) !== today);

              if(needsRemotePatch){
                updateDoc(meRef(state.roomId, state.uid), {
                  dateKey: today,
                  status: "break",
                  totalSecondsToday: merged,
                  sessionStartedAtMs: null,
                  updatedAt: Date.now(),
                  lastSeenAtMs: Date.now(),
                }).catch(()=>{});
              }

              state.didFocusMerge = true;
            }
          }
        }catch(e){}

        // âœ… ì˜¤í”„ë¼ì¸ì€ "ì ‘ì† ì¢…ë£Œ"ì²˜ëŸ¼ ì²˜ë¦¬: ë¦¬ìŠ¤íŠ¸/íƒ€ì¼ì—ì„œ ì œì™¸
        const onlineArr = arr.filter(p=>isOnline(p.lastSeenAtMs));

        // âœ… ë¯¸ì…˜ ì„±ê³µ ì¸ì›: participants ë¬¸ì„œì˜ mission í•„ë“œ ê¸°ì¤€(ëª¨ë‘ì—ê²Œ ë³´ì´ê²Œ)
        const todayKey = seoulDateKey();
        let successCount = 0;
        try{
          successCount = onlineArr.filter(p => p && p.mission && String(p.mission.dayKey||"")===String(todayKey) && !!p.mission.done).length;
        }catch(e){ successCount = 0; }

        // fallback: ë¯¸ì…˜ ì´ë²¤íŠ¸(ì±„íŒ… ì»¬ë ‰ì…˜) ì§‘ê³„ê°’ì´ ë” í¬ë©´ ê·¸ìª½ìœ¼ë¡œ
        try{
          const feedCount = Number(state.missionSuccessCount || 0);
          if(feedCount > successCount) successCount = feedCount;
        }catch(e){}

        state.missionSuccessCount = successCount;
        renderMissionSuccessCount(successCount);

        onlineArr.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "ko"));

        els.countOnline.textContent = String(onlineArr.length);
        els.lastSync.textContent = new Date().toLocaleTimeString("ko-KR");

        renderStatusRoster(onlineArr);
        renderGridTilesOrRoster(onlineArr);
        try{ setMissionButtonState(); }catch(e){}

      });
    }


    // Join / Leave
    
async function joinRoom(){
      try{
        const name = normalizeNick(els.name.value); els.name.value = name;
        state.nickname = name;
        setMyNickUI(name);
        try{ const lp = loadLocalProfile() || {}; lp.nickname = name; saveLocalProfile(lp); }catch(e){}
        if(!name){ showToast("ë‹‰ë„¤ì„ ì…ë ¥!"); return; }
        if(!(await requirePassOK())) return;

        const miss = validateFirebaseConfig();
        if(miss.length){
          showToast("Firebase ì„¤ì • ë¯¸ì™„ì„±: " + miss.join(", "), 4500);
          console.error("Firebase config missing/placeholder:", miss, firebaseConfig);
          return;
        }

        state.roomId = FIXED_ROOM_ID;
        await signInAnonymously(auth);
      if(!state.uid){
        await new Promise((resolve)=>{
          const off = onAuthStateChanged(auth, (user)=>{
            if(user){
              state.uid = user.uid;
              off();
              resolve();
            }
          });
        });
      }

      
      // ê°•í‡´ ìƒíƒœ(ì‹œê°„ ì œí•œ)ë©´ ì…ì¥ ë§‰ê¸°
      try{
        const ks = await getDoc(kickRef(state.roomId, state.uid));
        if(ks.exists()){
          const k = ks.data() || {};
          const exp = Number(k.expiresAtMs || 0);
          if(exp && exp > Date.now()){
            showToast("ğŸš« ê°•í‡´ ìƒíƒœë¼ ì ì‹œ ì…ì¥í•  ìˆ˜ ì—†ì–´");
            setControlsEnabled(false);
            return;
          }
        }
      }catch(e){}

      setControlsEnabled(true);
      await ensureRoom(state.roomId);
      await ensureMeDoc();

      const meSnap = await getDoc(meRef(state.roomId, state.uid));
      if(meSnap.exists()){
        const me = meSnap.data();
        els.emoji.value = me.theme?.emoji || "âœï¸";
        els.bgColor.value = me.theme?.bgColor || "#ffd0e2";
        if(els.emojiBgColor) els.emojiBgColor.value = me.theme?.emojiBg || "#2b2b2b";
        if(els.bubbleColor) els.bubbleColor.value = me.theme?.bubbleColor || me.theme?.bgColor || "#ffd0e2";
        if(els.timeColor) els.timeColor.value = me.theme?.timeColor || "#ffffff";
        if(els.timePicker && els.timeColor) els.timePicker.value = els.timeColor.value;
        if(els.emojiSize){ els.emojiSize.value = String(me.theme?.emojiSize || 40); if(els.emojiSizeNum) els.emojiSizeNum.value = els.emojiSize.value; }
        if(els.photoSize){ els.photoSize.value = String(me.theme?.photoSize || 68); if(els.photoSizeNum) els.photoSizeNum.value = els.photoSize.value; }
        if(els.bgPattern) els.bgPattern.value = me.theme?.pattern || "none";
        if(els.patternColor) els.patternColor.value = me.theme?.patternColor || "#ffffff";
        if(els.patternPicker && els.patternColor) els.patternPicker.value = els.patternColor.value;
        els.bubbleText.value = me.bubbleText || "";
        state.myPhotoUrl = me.theme?.photoUrl || "";
      } else {
        // ì‹ ê·œ/í…Œë§ˆì—†ìŒ: ë¸Œë¼ìš°ì € í”„ë¦¬ì…‹ì„ UIì— ë°˜ì˜
        try{
          const lp = loadLocalProfile();
          if(lp && lp.theme){
            els.emoji.value = lp.theme.emoji || els.emoji.value;
            els.bgColor.value = lp.theme.bgColor || els.bgColor.value;
            if(els.emojiBgColor) els.emojiBgColor.value = lp.theme.emojiBg || "#2b2b2b";
            if(els.bubbleColor) els.bubbleColor.value = lp.theme.bubbleColor || lp.theme.bgColor || "#ffd0e2";
            if(els.timeColor) els.timeColor.value = lp.theme.timeColor || "#ffffff";
            if(els.timePicker && els.timeColor) els.timePicker.value = els.timeColor.value;
            if(els.emojiSize){ els.emojiSize.value = String(lp.theme.emojiSize || 40); if(els.emojiSizeNum) els.emojiSizeNum.value = els.emojiSize.value; }
            if(els.photoSize){ els.photoSize.value = String(lp.theme.photoSize || 68); if(els.photoSizeNum) els.photoSizeNum.value = els.photoSize.value; }
            if(els.bgPattern) els.bgPattern.value = lp.theme.pattern || (els.bgPattern.value||"none");
            if(els.patternColor) els.patternColor.value = lp.theme.patternColor || "#ffffff";
            if(els.patternPicker && els.patternColor) els.patternPicker.value = els.patternColor.value;
            els.bubbleText.value = lp.bubbleText || (els.bubbleText.value||"");
            state.myPhotoUrl = lp.theme.photoUrl || state.myPhotoUrl;
          }
        }catch(e){}
      }

      // ğŸ” ë¸Œë¼ìš°ì € í”„ë¦¬ì…‹ë„ ë™ê¸°í™”(ë‹¤ìŒ ì ‘ì† í¸ì˜)
      try{
        const lp = loadLocalProfile() || {};
        lp.theme = { emoji: els.emoji.value, bgColor: els.bgColor.value, pattern: (els.bgPattern?els.bgPattern.value:"none"), patternColor: (els.patternColor?els.patternColor.value:"#ffffff"), photoUrl: state.myPhotoUrl||"", emojiBg: (els.emojiBgColor?els.emojiBgColor.value:"#2b2b2b"), bubbleColor: (els.bubbleColor?els.bubbleColor.value:els.bgColor.value), timeColor: (els.timeColor?els.timeColor.value:"#ffffff"), emojiSize: (els.emojiSize?Number(els.emojiSize.value):40), photoSize: (els.photoSize?Number(els.photoSize.value):68) };
        lp.bubbleText = (els.bubbleText.value||"");
        saveLocalProfile(lp);
      }catch(e){}

      subscribeRoom();
      await subscribeParticipants();
      // âœ… ìë™ íœ´ì‹/ìë¦¬ë¹„ì›€ ê°ì§€ ì‹œì‘(ì…ì¥ í›„)
      try{ bumpActivity(); }catch(e){}
      try{ startActivityWatch(); }catch(e){ console.warn("startActivityWatch failed", e); }
      // âœ… ë¯¸ì…˜ ì„±ê³µ ì¸ì›(ë¡œê·¸ì•„ì›ƒ/ì¬ì…ì¥ì—ë„ ìœ ì§€)
      subscribeMissionFeed();
      scheduleMissionDayWatcher();
      subscribeChat();
      subscribeKicks();

      await heartbeat();
      if(state.tickTimer) clearInterval(state.tickTimer);
      state.tickTimer = setInterval(()=>{ updateTimersLive(); updateClocks(); }, 1000);
      updateClocks();

      if(state.hbTimer) clearInterval(state.hbTimer);
      state.hbTimer = setInterval(heartbeat, 30_000);

      try{ localStorage.setItem("mk_last_name", name); }catch(e){}
      els.meHint.textContent = name;
      try{ if(els.checkInBtn) __applyCheckInBtnUI(els.checkInBtn); }catch(e){}
      showToast("ì…ì¥!");
      // âœ… 30ì´ˆë§ˆë‹¤ ë¡œì»¬ì— ì§‘ì¤‘ì‹œê°„ ì €ì¥(ì˜ˆê¸°ì¹˜ ì•Šì€ ì¢…ë£Œ ëŒ€ë¹„)
      try{ if(state.focusPersistTimer) clearInterval(state.focusPersistTimer); }catch(e){}
      try{ state.focusPersistTimer = setInterval(()=>{ try{ if(state.joined) persistMyFocusToLocal(); }catch(e){} }, 30000); }catch(e){}
      // âœ… ì…ì¥ ì‚¬ìš´ë“œ(ëª¨ë‘ì—ê²Œ): ë‚˜ëŠ” ì¦‰ì‹œ ì¬ìƒ, ë‹¤ë¥¸ ì‚¬ëŒì€ sfx ì´ë²¤íŠ¸ë¡œ ì¬ìƒ
      try{ playSfx("enter"); }catch(e){}
      try{ emitSfx("enter"); }catch(e){}
      }catch(e){
        console.error(e);
        const code = e?.code || "";
        const msg = e?.message || "";
        showToast("ì…ì¥ ì‹¤íŒ¨: " + (code || "ì˜¤ë¥˜"), 3500);
        if(msg) console.warn("joinRoom error message:", msg);
        // ê°œë°œìë„êµ¬ ì—†ì´ë„ ë°”ë¡œ ê° ì¡ê²Œ ì§§ê²Œ í•œ ë²ˆ ë”
        if(!code && msg) showToast("ì…ì¥ ì‹¤íŒ¨: " + msg.slice(0, 60), 3500);
        const hint = friendlyAuthHint(code);
        if(hint) console.warn(hint);
        // í™”ë©´ì—ì„œë„ íŒíŠ¸ë¥¼ ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ í•œ ì¤„ ì£¼ì„ í•´ì œ
        if(hint) showToast(hint, 4500);
      }
    }

    async function leaveRoom(){
      // âœ… í‡´ì¥ ì§ì „ ì§‘ì¤‘ì‹œê°„ ë¡œì»¬ ì €ì¥
      persistMyFocusToLocal();
      // âœ… ìë™ íœ´ì‹/ìë¦¬ë¹„ì›€ ê°ì§€ íƒ€ì´ë¨¸ ì •ë¦¬(í‡´ì¥ ì‹œ)
      try{ stopActivityWatch(); }catch(e){}
      // âœ… í‡´ì¥ ì‚¬ìš´ë“œ(ëª¨ë‘ì—ê²Œ)
      try{ playSfx("exit"); }catch(e){}
      /* exit sfx disabled */
      if(!state.roomId || !state.uid) return;

      try{ await transitionTo("idle","manual"); }catch(e){}

      if(state.unsubParticipants) state.unsubParticipants();
      if(state.unsubRoom) state.unsubRoom();
      if(state.unsubChat) state.unsubChat();
      if(state.unsubKick) state.unsubKick();
      if(state.unsubMissions) state.unsubMissions();
      state.unsubParticipants = null;
      state.unsubRoom = null;
      state.unsubChat = null;
      state.unsubKick = null;
      state.unsubMissions = null;

      try{ await deleteDoc(meRef(state.roomId, state.uid)); }catch(e){}

      els.grid.innerHTML = "";
      els.chatList.innerHTML = "";
      state.currentParticipants = new Map();
      state.lastRendered.clear();

      setControlsEnabled(false);
    updateClocks();

      if(state.tickTimer) clearInterval(state.tickTimer);
      if(state.hbTimer) clearInterval(state.hbTimer);
      state.tickTimer = null;
      state.hbTimer = null;

      els.meHint.textContent = "â€”";
      try{ if(state.focusPersistTimer) clearInterval(state.focusPersistTimer); }catch(e){}
      state.focusPersistTimer = null;
      // ë‹¤ìŒ ì…ì¥ ë•Œ sfx ìµœì´ˆ ë¡œë“œ ì²˜ë¦¬ ë‹¤ì‹œ
      state.sfxInitDone = false; state.lastSfxTs = 0;
      showToast("í‡´ì¥!");
    }

    // UI bindings
    initPalette();

    // keep dashboard docked
    
window.addEventListener("resize", ()=>{
  dockRightRail();
  ensureChatLayout();
  // âœ… ì°½ í­ ë³€í™” ì‹œ: compact ëª¨ë“œ/íƒ€ì¼â†”ì ‘ì†ìëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
  try{
    const arr = [...state.currentParticipants.values()];
    const onlineArr = arr.filter(p=>isOnline(p.lastSeenAtMs));
    onlineArr.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "ko"));
    renderGridTilesOrRoster(onlineArr);
  }catch(e){
    applyCompactMode();
  }
});
window.addEventListener("scroll", dockRightRail, {passive:true});
    setTimeout(dockRightRail, 80);
    // âœ… ì´ˆê¸° ë¡œë”© ë•Œ compact ì˜¤íŒ ë°©ì§€(ë ˆì´ì•„ì›ƒ í™•ì • í›„ íŒë‹¨)
    requestAnimationFrame(()=>applyCompactMode());
    setTimeout(()=>applyCompactMode(), 180);

    if(els.onlineBtn){
      els.onlineBtn.addEventListener("click", ()=>{
        const n = (els.countOnline && els.countOnline.textContent) ? els.countOnline.textContent : "0";
        showToast(`ğŸ‘¥ ì§€ê¸ˆ ${n}ëª… ì ‘ì†ì¤‘`);
      });
    }

    els.joinBtn.addEventListener("click", joinRoom);

    // âœ… Nickname clamp (IME-safe)
    if(els.name){
      let composing = false;
      els.name.addEventListener("compositionstart", ()=>{ composing = true; });
      els.name.addEventListener("compositionend", ()=>{ composing = false; els.name.value = normalizeNick(els.name.value); });
      els.name.addEventListener("input", ()=>{ if(composing) return; els.name.value = normalizeNick(els.name.value); });
      els.name.addEventListener("blur", ()=>{ els.name.value = normalizeNick(els.name.value); });
    }

    els.leaveBtn.addEventListener("click", leaveRoom);

    if(els.layoutToggleBtn){
      applyLayoutMode(getLayoutMode());
      els.layoutToggleBtn.addEventListener("click", toggleLayoutMode);
    }

    els.btnWork.addEventListener("click", ()=>{ transitionTo("work","manual"); els.statusMenu.classList.add("hidden"); });
    els.btnBreak.addEventListener("click", ()=>{ transitionTo("break","manual"); els.statusMenu.classList.add("hidden"); });
    els.btnIdle.addEventListener("click", ()=>{ transitionTo("idle","manual"); els.statusMenu.classList.add("hidden"); });

    // ìƒíƒœ ë©”ë‰´ í† ê¸€
    
    if(els.checkInBtn){
      try{ __applyCheckInBtnUI(els.checkInBtn); }catch(e){}
      // ===== ì¶œê·¼(ì¶œì„) íŒì—…(êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™) =====
      // âœ… ì—¬ê¸°ì— 'ì›¹ì•±ìœ¼ë¡œ ë°°í¬'í•œ Apps Script URLì„ ë„£ì–´ì£¼ì„¸ìš”.
      // ì˜ˆ) https://script.google.com/macros/s/XXXXX/exec
      const ATTEND_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxzzk9MGHywJH7y8poYidXAdUrL6_Bz2SQy7cBmgSbI0dNPjuPRdwm5SnRoAEItMuwp/exec";
      // ì¶œê·¼(ì¶œì„) íŒì—… ë‚´ë¶€ ì´ë™(1íšŒ=ë‹‰ì„ íƒ í™”ë©´, 2íšŒ ì´ìƒ=ì™„ë£Œ í™”ë©´) ê°ì§€ìš©
      let __attLoadCount = 0;
      let __attDoneReady = false;
      function __resetAttendFlow(){
        __attLoadCount = 0;
        __attDoneReady = false;
      }


      function openAttendanceModal(){
        __resetAttendFlow();
        const modal = document.getElementById("attModal");
        const frame = document.getElementById("attFrame");
        if(!modal || !frame) return;

        if(!ATTEND_WEBAPP_URL || ATTEND_WEBAPP_URL.includes("PASTE_YOUR")) {
          showToast("âš ï¸ ì¶œê·¼ ì›¹ì•± URLì„ ì•„ì§ ì•ˆ ë„£ì—ˆì–´!");
          return;
        }

        // cache-bust + embedded flag
        const u = new URL(ATTEND_WEBAPP_URL);
        u.searchParams.set("embedded", "1");
        u.searchParams.set("_", String(Date.now()));

        frame.src = u.toString();
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden","false");
      }

      function closeAttendanceModal(opts={}){
        const modal = document.getElementById("attModal");
        const frame = document.getElementById("attFrame");
        if(!modal || !frame) return;

        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden","true");

        // âœ… ì‚¬ìš©ìê°€ 'ì™„ë£Œ í™”ë©´(2ë²ˆì§¸ ë¡œë“œ ì´í›„)'ê¹Œì§€ ë³´ê³  ë‹«ëŠ” ê²½ìš° â†’ ê·¸ ì‹œì ì— ì¶œê·¼ì™„ë£Œ ì²˜ë¦¬
        try{
          const fromUser = !!opts.fromUser;
          if(fromUser && __attDoneReady){
            __markCheckedInToday();
            if(els && els.checkInBtn) __applyCheckInBtnUI(els.checkInBtn);
            showToast("âœ… ì¶œê·¼ ê¸°ë¡ ì™„ë£Œ!");
          }
        }catch(e){}

        // iframe reset
        frame.src = "about:blank";
      }

      // ë‹«ê¸° ë²„íŠ¼/ë°°ê²½ í´ë¦­
      (function wireAttendanceModal(){
        const modal = document.getElementById("attModal");
        const closeBtn = document.getElementById("attCloseBtn");
        const frame = document.getElementById("attFrame");

        // âœ… iframe ë¡œë“œ íšŸìˆ˜ë¡œ "ì™„ë£Œ í™”ë©´ê¹Œì§€ ì™”ëŠ”ì§€" ì¶”ì • (cross-origin ì•ˆì „)
        if(frame){
          frame.addEventListener("load", ()=>{
            try{
              // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ë™ì•ˆë§Œ ì¹´ìš´íŠ¸
              const isOpen = modal && !modal.classList.contains("hidden");
              if(!isOpen) return;
              __attLoadCount = (__attLoadCount || 0) + 1;
              if(__attLoadCount >= 2) __attDoneReady = true;
            }catch(e){}
          });
        }
        if(closeBtn) closeBtn.addEventListener("click", ()=>closeAttendanceModal({fromUser:true}));
        if(modal) modal.addEventListener("click", (ev)=>{
          const t = ev.target;
          if(t && t.dataset && t.dataset.close) closeAttendanceModal({fromUser:true});
        });
        // ESC ë‹«ê¸°
        document.addEventListener("keydown", (ev)=>{
          if(ev.key === "Escape") closeAttendanceModal({fromUser:true});
        });

        // Apps Script(iframe) â†’ ì‘ì—…ë°©ìœ¼ë¡œ ì™„ë£Œ ì‹ í˜¸ ë°›ê¸°
        window.addEventListener("message", async (ev)=>{
          try{
            let data = ev && ev.data;
            // âœ… Apps Script ìª½ì´ ë¬¸ìì—´ë¡œ ë³´ë‚´ê±°ë‚˜(JSON ë¬¸ìì—´) íƒ€ì… í‚¤ê°€ ë‹¤ë¥¼ ë•Œë„ ë°›ê¸°
            if(typeof data === "string"){
              const s = data.trim();
              if(s === "ATTENDANCE_DONE"){
                data = {type:"ATTENDANCE_DONE"};
              }else if(s.startsWith("{") || s.startsWith("[")){
                try{ data = JSON.parse(s); }catch(e){}
              }
            }
            if(!data || typeof data !== "object") return;
            const t = String(data.type || data.event || "").toUpperCase();
            if(t !== "ATTENDANCE_DONE") return;


            closeAttendanceModal();
            const nick = data.nickname ? ` (${data.nickname})` : "";
            showToast("âœ… ì¶œê·¼ ê¸°ë¡ ì™„ë£Œ!" + nick);
            // âœ… ì˜¤ëŠ˜ ì¶œê·¼ ì™„ë£Œë¡œ í‘œì‹œ(ë²„íŠ¼ í…ìŠ¤íŠ¸/ë±ƒì§€)
            try{ __markCheckedInToday(); if(els.checkInBtn) __applyCheckInBtnUI(els.checkInBtn); }catch(e){}

            // ê¸°ì¡´ ì¶œê·¼ ë²„íŠ¼ ë™ì‘ ìœ ì§€: ì¶œê·¼í•˜ë©´ ìë™ 'ì‘ì—…ì¤‘'ìœ¼ë¡œ ë³€ê²½
            if(state && state.uid){
              try{ await setStatus("work"); }catch(e){}
            }
          }catch(e){}
        });
      })();

      els.checkInBtn.addEventListener("click", async ()=>{
        try{
          if(!state.uid) return;
          openAttendanceModal();
        }catch(e){}
      });
}

els.statusBtn.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      els.statusMenu.classList.toggle("hidden");
    });
    // ë©”ë‰´ ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
    document.addEventListener("click", ()=>{
      if(!els.statusMenu.classList.contains("hidden")) els.statusMenu.classList.add("hidden");
    });
    // ë©”ë‰´ í´ë¦­ì€ ë²„ë¸”ë§ ë§‰ê¸°
    els.statusMenu.addEventListener("click", (ev)=>ev.stopPropagation());
    els.profileBtn.addEventListener("click", ()=>{
      // âœ… ëª¨ë‹¬ ì—´ ë•Œ í˜„ì¬ ì €ì¥ëœ ê°’ë“¤ì„ ë‹¤ì‹œ ì±„ì›Œë„£ê¸°
      try{
        const lp = loadLocalProfile() || {};
        const theme = lp.theme || {};
        if(els.profileNick){
          const nn = (lp.nickname || state.nickname || "").toString().trim().slice(0,20);
          if(nn) els.profileNick.value = nn;
        }
        if(els.emoji) els.emoji.value = (window.firstEmojiGrapheme || firstEmojiGrapheme)((theme.emoji || els.emoji.value || "âœï¸").toString().trim()) || "âœï¸";
        if(els.emojiSize){ els.emojiSize.value = "82"; els.emojiSize.disabled = true; }
        if(els.emojiSizeNum){ els.emojiSizeNum.value = "82"; }

        if(els.photoSize){ els.photoSize.value = "82"; els.photoSize.disabled = true; }
        if(els.photoSizeNum){ els.photoSizeNum.value = "82"; }


        if(els.emojiBgColor) els.emojiBgColor.value = clampHexColor(theme.emojiBg || els.emojiBgColor.value || "#2b2b2b");
        if(els.emojiBgPicker) els.emojiBgPicker.value = els.emojiBgColor.value;

        if(els.bgColor) els.bgColor.value = clampHexColor(theme.bgColor || els.bgColor.value || "#ffd0e2");
        if(els.bgPicker) els.bgPicker.value = els.bgColor.value;

        if(els.bgPattern) els.bgPattern.value = (theme.pattern || els.bgPattern.value || "none");
        if(els.patternColor) els.patternColor.value = clampHexColor(theme.patternColor || els.patternColor.value || "#ffffff");
        if(els.patternPicker) els.patternPicker.value = els.patternColor.value;

        if(els.bubbleText) els.bubbleText.value = (lp.bubbleText || "").toString().slice(0,15);
        if(els.bubbleColor) els.bubbleColor.value = clampHexColor(theme.bubbleColor || els.bubbleColor.value || "#ffd0e2");
        if(els.bubblePicker) els.bubblePicker.value = els.bubbleColor.value;

        if(els.timeColor) els.timeColor.value = clampHexColor(theme.timeColor || els.timeColor.value || "#ffffff");
        if(els.timePicker) els.timePicker.value = els.timeColor.value;

        // âœ… ìë™ì „í™˜(ë¶„)
        const ab = Number(lp.autoBreakMin ?? 10);
        const ai = Number(lp.autoIdleMin ?? 15);
        if(els.autoBreakMin) els.autoBreakMin.value = String(Math.min(180, Math.max(1, isFinite(ab)?ab:10)));
        if(els.autoIdleMin) els.autoIdleMin.value = String(Math.min(180, Math.max(1, isFinite(ai)?ai:15)));
        // âœ… í—¬í¼ ëª¨ë“œ
        const hm = String(lp.helperMode || state.helperMode || 'auto');
        setHelperMode((hm==='manual')?'manual':'auto', false);
      }catch(e){}
      showModal(els.profileModal);
    });
    els.closeProfile.addEventListener("click", ()=>hideModal(els.profileModal));
    els.applyProfile.addEventListener("click", applyProfile);
    // âœ… í—¬í¼ ëª¨ë“œ ì¦‰ì‹œ ë°˜ì˜
    try{
      if(els.helperMode) els.helperMode.addEventListener('change', ()=>{ setHelperMode(els.helperMode.value, true); updateHelperStatusUI(); });
    }catch(e){}

    // âœ… ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ëª¨ë‹¬ ë°”ì¸ë”©
    try{
      const mm = document.getElementById("missionModal");
      const close = document.getElementById("closeMission");
      const save = document.getElementById("saveMission");
      if(close) close.addEventListener("click", closeMissionModal);
      if(mm) mm.addEventListener("click", (e)=>{ if(e.target===mm) closeMissionModal(); });

      // ë²„íŠ¼ í´ë¦­(ì´ë²¤íŠ¸ ìœ„ì„) - íƒ€ì¼ì´ ë¦¬ë Œë”ë˜ì–´ë„ ì•ˆ ì£½ê²Œ
      document.addEventListener("click", (e)=>{
        const btn = e.target && e.target.closest ? e.target.closest(".missionBtn") : null;
        if(btn){
          e.preventDefault();
          const isMe = (btn.dataset.me==="1") || ((btn.dataset.owner||"") && state.uid && (btn.dataset.owner===state.uid));
          if(isMe){
            openMissionModal();
          }else{
            const nameRaw = (btn.dataset.name || "").trim() || "ìƒëŒ€";
              const nameKey = (typeof normalizeNick==="function") ? normalizeNick(nameRaw) : nameRaw;
              const info = getRemoteMissionInfoByName(nameKey);
              const name = nameRaw;
            if(info && info.action==="done"){
              showToast(info.text ? `${name} ë¯¸ì…˜ ì„±ê³µ! ğŸ‘‘ ${info.text}` : `${name} ë¯¸ì…˜ ì„±ê³µ! ğŸ‘‘`);
            }else if(info && info.text){
              showToast(`${name} ì˜¤ëŠ˜ì˜ ë¯¸ì…˜: ${info.text}`);
            }else{
              showToast(`${name} ì•„ì§ ë¯¸ì…˜ì´ ì—†ì–´!`);
            }
          }
        }
      });

      if(save) save.addEventListener("click", async ()=>{
        try{
          const text = (document.getElementById("missionText")?.value || "").trim();
          const done = !!document.getElementById("missionDone")?.checked;
          const dayKey = seoulDateKey();
          const prev = state.myMission || loadMissionLocal();
          const becameDone = (!prev.done && done);
          const becameUndone = (prev.done && !done);

          const m = { dayKey, text, done, doneAt: done ? (prev.doneAt || new Date().toISOString()) : "" };
          state.myMission = m;
          saveMissionLocal(m);
          setMissionButtonState();
          refreshAllMissionMedals();
          closeMissionModal();

          // ì„±ê³µ í­ì£½(í”„ë¡œí•„ íƒ€ì¼ ì¤‘ì‹¬)
          if(becameDone){
            const myTile = (state.uid && state.lastRendered && state.lastRendered.get(state.uid)) ? (state.lastRendered.get(state.uid).el || null) : null;
            const btn = document.querySelector(".missionBtn[data-me=\"1\"]");
            fxFireworksAt(myTile || btn);
          }

          // Firestoreì— ë‚´ ë¯¸ì…˜ ì €ì¥(ê°€ëŠ¥í•  ë•Œë§Œ)
          try{
            if(state.roomId && state.uid){
              const ref = meRef(state.roomId, state.uid);
              await updateDoc(ref, { mission: m, lastSeenAtMs: Date.now() });
              // âœ… ë¡œê·¸ì•„ì›ƒ/ì¬ì…ì¥ì—ë„ ìœ ì§€ë˜ë„ë¡ 'ì˜¤ëŠ˜ ë¯¸ì…˜ ì„±ê³µ'ì„ ë³„ë„ ì»¬ë ‰ì…˜ì— ì €ì¥
              if(becameUndone) await emitMissionEvent('undo', m);
              else if(done) await emitMissionEvent('done', m);
              else if(text) await emitMissionEvent('set', m);
            }
          }catch(e){}
        }catch(e){}
      });
    }catch(e){}

    // âœ… ëŒ€ì‹œë³´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸°
    try{
      const foldBtn = document.getElementById("dashFoldBtn");
      const btnIcon = document.getElementById("dashFoldIcon");
      const btnTxt  = document.getElementById("dashFoldTxt");
      const body = document.getElementById("dashFoldBody");
      function applyFoldUI(){
        const folded = loadDashFold();
        const card = document.getElementById("dashboardCard");
        if(card) card.classList.toggle("folded", folded);
        if(body) body.classList.toggle("isHidden", folded);
        if(btnIcon) btnIcon.textContent = folded ? "â–¾" : "â–´";
        if(btnTxt) btnTxt.textContent = folded ? "í¼ì¹˜ê¸°" : "ì ‘ê¸°";
      }
      applyFoldUI();
      if(foldBtn) foldBtn.addEventListener("click", ()=>{
        const next = !loadDashFold();
        saveDashFold(next);
        applyFoldUI();

        // âœ… ì ‘ê¸°/í¼ì¹˜ê¸° ë‘˜ ë‹¤: ë„í‚¹ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚° (ê²¹ì¹¨/ì”ìƒ ë°©ì§€)
        try{ if(typeof dockRightRail==="function") dockRightRail(); }catch(e){}
        setTimeout(()=>{ try{ if(typeof dockRightRail==="function") dockRightRail(); }catch(e){} }, 50);
      });
    }catch(e){}


    // âœ… í¬ê¸° ì¡°ì ˆ ë°”ëŠ” ê³ ì •(82px)ì´ë¼ ëª¨ë‹¬ì—ì„œ ìˆ¨ê¹€
    function hideRowByControl(el){
      try{
        if(!el) return;
        const row = el.closest ? el.closest(".row") : null;
        if(row) row.style.display = "none";
      }catch(e){}
    }
    hideRowByControl(els.emojiSize);
    hideRowByControl(els.photoSize);
    hideRowByControl(els.emojiSizeNum);
    hideRowByControl(els.photoSizeNum);


    // âœ… ì´ëª¨ì§€ 1ê°œë§Œ í—ˆìš©
    if(els.emoji){
      els.emoji.addEventListener("input", ()=>{
        const v = (window.firstEmojiGrapheme || firstEmojiGrapheme)(els.emoji.value);
        if(v && els.emoji.value !== v) els.emoji.value = v;
      });
      els.emoji.addEventListener("blur", ()=>{
        const v = (window.firstEmojiGrapheme || firstEmojiGrapheme)(els.emoji.value);
        els.emoji.value = v || "âœï¸";
      });
    }

    if(els.uploadPhotoBtn) els.uploadPhotoBtn.addEventListener("click", uploadPhoto);

    els.menuBtn.addEventListener("click", ()=>{
      els.adminPass.value = "";
      els.adminArea.style.display = "none";
      state.adminOk = false;
      showModal(els.settingsModal);
    });
    els.closeSettings.addEventListener("click", ()=>hideModal(els.settingsModal));
    els.adminUnlock.addEventListener("click", unlockAdmin);
    if(els.adminPass){
      els.adminPass.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); unlockAdmin(); }
      });
    }

    // ëª¨ë‹¬ì—ì„œ Enter â†’ ì²« ë²ˆì§¸ primary ë²„íŠ¼
    document.addEventListener("keydown",(e)=>{
      if(e.key!=="Enter") return;
      const openModal = [els.profileModal, els.settingsModal].find(m=>m && m.style.display==="flex");
      if(!openModal) return;
      const ae = document.activeElement;
      if(ae && (ae.tagName==="TEXTAREA")) return;
      // ì´ë¯¸ íŠ¹ì • inputì—ì„œ Enter ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê¸°
      if(ae && ae.id==="adminPass") return;
      const btn = openModal.querySelector("button.primary");
      if(btn){ e.preventDefault(); btn.click(); }
    });
    els.saveDash.addEventListener("click", saveDashboard);

    els.sendBtn.addEventListener("click", sendChat);

    if(els.chatJumpBtn){
      els.chatJumpBtn.addEventListener("click", ()=>{
        scrollChatToBottom();
        hideChatNewBar(true);
      });
    }
    if(els.chatList){
      els.chatList.addEventListener("scroll", ()=>{
        const nb = isChatNearBottom();
        state.chatUserNearBottom = nb;
        if(nb) hideChatNewBar(true);
      }, { passive: true });
    }

    // --- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´(í”„ë¡œí•„ ìš°í´ë¦­) ë‹«ê¸°/ë™ì‘ ---
    if(els.ctxClose){
      els.ctxClose.addEventListener("click", (e)=>{
        e.preventDefault();
        hideCtxMenu();
      });
    }
    if(els.ctxKick){
      els.ctxKick.addEventListener("click", async (e)=>{
        e.preventDefault();
        const t = state.ctxTarget || {};
        hideCtxMenu();
        if(t.uid) await requestKick(t.uid, t.name);
      });
    }
    // ë©”ë‰´ ì•ˆì—ì„œ í´ë¦­ì€ ë°”ê¹¥ í´ë¦­ ë‹«ê¸° íŠ¸ë¦¬ê±°ë¥¼ ë§‰ê¸°
    if(els.ctxMenu){
      els.ctxMenu.addEventListener("click", (e)=>e.stopPropagation());
      els.ctxMenu.addEventListener("contextmenu", (e)=>e.preventDefault());
    }
    // ë°”ê¹¥ í´ë¦­/ìš°í´ë¦­/ESC ë¡œ ë‹«ê¸°
    document.addEventListener("click", (e)=>{
      if(!els.ctxMenu || els.ctxMenu.classList.contains("hidden")) return;
      if(!els.ctxMenu.contains(e.target)) hideCtxMenu();
    }, true);
    document.addEventListener("contextmenu", (e)=>{
      if(!els.ctxMenu || els.ctxMenu.classList.contains("hidden")) return;
      if(!els.ctxMenu.contains(e.target)) hideCtxMenu();
    }, true);
    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape") hideCtxMenu();
    });


    // embed controls (í˜„ì¬ëŠ” ë‚´ë¶€ ì„ë² ë“œ ì‚¬ìš© ì•ˆ í•¨. ìš”ì†Œê°€ ì—†ì„ ìˆ˜ë„ ìˆì–´ ê°€ë“œ)
    if(els.embedClose) els.embedClose.addEventListener("click", closeInlineEmbed);
    if(els.embedOpen)  els.embedOpen.addEventListener("click", ()=>{ /* set on openInlineEmbed */ });
    if(els.closeEmbedModal) els.closeEmbedModal.addEventListener("click", closeEmbedModal);
    if(els.embedModal) els.embedModal.addEventListener("click", (e)=>{ if(e.target===els.embedModal) closeEmbedModal(); });
    // âœ… IME(í•œê¸€ ë“±) ì¡°í•© ì…ë ¥ì—ì„œ Enterê°€ 2ë²ˆ ì²˜ë¦¬ë˜ë©° 'ë§ˆì§€ë§‰ ê¸€ìë§Œ ë”°ë¡œ ì „ì†¡'ë˜ëŠ” í˜„ìƒ ë°©ì§€
    let __chatIsComposing = false;
    let __chatSendAfterCompose = false;

    els.chatInput.addEventListener("compositionstart", ()=>{
      __chatIsComposing = true;
      __chatSendAfterCompose = false;
    });
    els.chatInput.addEventListener("compositionend", ()=>{
      __chatIsComposing = false;
      if(__chatSendAfterCompose){
        __chatSendAfterCompose = false;
        // ì¡°í•© í™•ì • í›„ ë‹¤ìŒ í‹±ì— ì „ì†¡ (í•œ ë²ˆë§Œ)
        setTimeout(()=>sendChat(), 0);
      }
    });

    els.chatInput.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;



      // ì¡°í•© ì¤‘ Enter: ì¡°í•© í™•ì •ë§Œ í•˜ê³ (ê¸°ë³¸ ë™ì‘), ì „ì†¡ì€ compositionendì—ì„œ í•œ ë²ˆë§Œ ì²˜ë¦¬
      if(e.isComposing || __chatIsComposing || e.keyCode === 229){
        __chatSendAfterCompose = true;
        return;
      }

      e.preventDefault();
      sendChat();
    });

    els.profileModal.addEventListener("click", (e)=>{ if(e.target === els.profileModal) hideModal(els.profileModal); });
    els.settingsModal.addEventListener("click", (e)=>{ if(e.target === els.settingsModal) hideModal(els.settingsModal); });

    
    // âœ… ì…ì¥í‚¤(24h) ê¸°ì–µ
    loadPassOK();
    if(els.roomPass){
      els.roomPass.addEventListener("input", ()=>{
        if(!(els.roomPass.value||"").trim()) clearPass();
      });
    }

    // âœ… í”„ë¡œí•„ ì„¤ì •(ë¸Œë¼ìš°ì €) í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸°
    try{
      const lp = loadLocalProfile();
      if(lp){
        if(els.emoji) els.emoji.value = lp.theme?.emoji || els.emoji.value;
        if(els.bgColor) els.bgColor.value = lp.theme?.bgColor || els.bgColor.value;
        if(els.bgPattern && lp.theme?.pattern) els.bgPattern.value = lp.theme.pattern;
        if(els.bubbleText) els.bubbleText.value = lp.bubbleText || "";
        if(lp.theme?.photoUrl) state.myPhotoUrl = lp.theme.photoUrl;
      }
    }catch(e){}


    // ë‹‰ë„¤ì„ ê¸°ì–µ (ì…í‡´ì¥ í¸ì˜)
    try{
      const lp = loadLocalProfile() || {};
      const fromProfile = (lp.nickname || "").toString().trim().slice(0,20);
      const saved = localStorage.getItem("mk_last_name") || "";
      if(els.name){
        if(fromProfile) els.name.value = fromProfile;
        else if(saved) els.name.value = saved;
      }
    }catch(e){}
    if(els.name){
      els.name.addEventListener("input", ()=>{
        try{ localStorage.setItem("mk_last_name", els.name.value.trim()); }catch(e){}
      });
      els.name.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          if(!els.joinBtn.disabled) joinRoom();
        }
      });
    }

    if(els.roomPass){
      els.roomPass.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          if(!els.joinBtn.disabled) joinRoom();
        }
      });
    }

    setControlsEnabled(false);
    updateClocks();

    window.addEventListener("beforeunload", ()=>{
      // âœ… íƒ­ ë‹«ê¸°/ìƒˆë¡œê³ ì¹¨ì—ì„œë„ "ì˜¤ëŠ˜ ì‘ì—…ì‹œê°„" ë¡œì»¬ì— ì €ì¥(24h ëˆ„ì  ìœ ì§€ìš©)
      try{ if(state && state.joined) persistMyFocusToLocal(); }catch(e){}
      if(state.roomId && state.uid){
        try{ updateDoc(meRef(state.roomId, state.uid), { lastSeenAtMs: Date.now(), updatedAt: Date.now() }); }catch(e){}
      }
    });

  
  // READY FLAG (bindings complete)
  window.__MK_READY__ = true;
})();
</script>
  <script>
    // Fallback: if ES module didn't execute (common when opening via file://), show a clear hint
    (function(){
      function show(msg){
        try{
          var t = document.getElementById('toast');
          if(t){ t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4500); }
          else { alert(msg); }
        }catch(e){ alert(msg); }
      }
      window.addEventListener('load', function(){
        setTimeout(function(){
                    if(window.__MK_BOOT_OK__ && !window.__MK_READY__){
            show("âš ï¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¡œë“œëëŠ”ë° ì´ˆê¸°í™”ê°€ ì¤‘ê°„ì— ë©ˆì·„ì–´(ì—ëŸ¬ ê°€ëŠ¥). ê°œë°œìë„êµ¬(F12)â†’Console ì—ëŸ¬ë¥¼ ìº¡ì²˜í•´ì„œ ë³´ë‚´ì£¼ë©´ ë°”ë¡œ ì¡ì•„ì¤„ê²Œ!\n(ë˜ëŠ” ë°°í¬ íŒŒì¼ êµì²´ í›„ Ctrl+F5)");
            var jb2 = document.getElementById('joinBtn');
            if(jb2){ jb2.addEventListener('click', function(){ show("âš ï¸ ì´ˆê¸°í™” ì—ëŸ¬ë¡œ ì…ì¥ì´ ë§‰í˜”ì–´. F12â†’Console ì—ëŸ¬ ìº¡ì²˜ë¥¼ ë³´ë‚´ì¤˜!"); }); }
            return;
          }
if(!window.__MK_BOOT_OK__){
            show("âš ï¸ ì§€ê¸ˆ íŒŒì¼ì´ 'ë¡œì»¬ íŒŒì¼(file://)'ë¡œ ì—´ë ¤ì„œ ìŠ¤í¬ë¦½íŠ¸ê°€ ë§‰íŒ ê²ƒ ê°™ì•„! Netlify/GitHub ê°™ì€ ì›¹ì£¼ì†Œ(https://)ë¡œ ì—´ê±°ë‚˜, ë¡œì»¬ ì„œë²„ë¡œ ì—´ì–´ì¤˜. (ì˜ˆ: í´ë”ì—ì„œ í„°ë¯¸ë„ â†’ python -m http.server)");
            var jb = document.getElementById('joinBtn');
            if(jb){
              jb.addEventListener('click', function(){
                show("âš ï¸ ë¡œì»¬ íŒŒì¼(file://)ë¡œ ì—´ë©´ ì…ì¥ì´ ì•ˆ ë¼. Netlify/GitHub ë°°í¬ ì£¼ì†Œ(https://)ë¡œ ì—´ì–´ì¤˜!");
              });
            }
          }
        }, 400);
      });
    })();
  </script>


  <!-- âœ… ì¶œê·¼(ì¶œì„) íŒì—… -->
  <div id="attModal" class="attModal hidden" aria-hidden="true">
    <div class="backdrop" data-close="1"></div>
    <div class="panel" role="dialog" aria-modal="true" aria-label="ì¶œê·¼">
      <div class="head">
        <div class="ttl">ğŸ’Œ ì¶œê·¼(ì¶œì„) ì²´í¬</div>
        <button id="attCloseBtn" class="xBtn" type="button">ë‹«ê¸° âœ–</button>
      </div>
      <iframe id="attFrame" title="ì¶œê·¼(ì¶œì„)" sandbox="allow-scripts allow-forms allow-same-origin allow-popups" referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

</body>
</html>
